"use strict";var kaplay=(()=>{var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,n=Object.getOwnPropertyNames,s=Object.prototype.hasOwnProperty,r=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:4*t-205]=t;return t=>{for(var n=t.length,s=new Uint8Array(3*(n-("="==t[n-1])-("="==t[n-2]))/4|0),r=0,i=0;r<n;){var a=e[t.charCodeAt(r++)],o=e[t.charCodeAt(r++)],l=e[t.charCodeAt(r++)],h=e[t.charCodeAt(r++)];s[i++]=a<<2|o>>4,s[i++]=o<<4|l>>2,s[i++]=l<<6|h}return s}})(),i={};((t,n)=>{for(var s in n)e(t,s,{get:n[s],enumerable:!0})})(i,{_k:()=>Wi,default:()=>Zi,kaplay:()=>zi});function a(e,t,n){return t>n?a(e,n,t):Math.min(Math.max(e,t),n)}var o=class e{r=255;g=255;b=255;constructor(e,t,n){this.r=a(e,0,255),this.g=a(t,0,255),this.b=a(n,0,255)}static fromArray(t){return new e(t[0],t[1],t[2])}static fromHex(t){if("number"==typeof t)return new e(t>>16&255,t>>8&255,t>>0&255);if("string"==typeof t){let n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);if(!n)throw new Error("Invalid hex color format");return new e(parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16))}throw new Error("Invalid hex color format")}static fromHSL(t,n,s){if(0==n)return new e(255*s,255*s,255*s);let r=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e),i=s<.5?s*(1+n):s+n-s*n,a=2*s-i,o=r(a,i,t+1/3),l=r(a,i,t),h=r(a,i,t-1/3);return new e(Math.round(255*o),Math.round(255*l),Math.round(255*h))}static RED=new e(255,0,0);static GREEN=new e(0,255,0);static BLUE=new e(0,0,255);static YELLOW=new e(255,255,0);static MAGENTA=new e(255,0,255);static CYAN=new e(0,255,255);static WHITE=new e(255,255,255);static BLACK=new e(0,0,0);clone(){return new e(this.r,this.g,this.b)}lighten(t){return new e(this.r+t,this.g+t,this.b+t)}darken(e){return this.lighten(-e)}invert(){return new e(255-this.r,255-this.g,255-this.b)}mult(t){return new e(this.r*t.r/255,this.g*t.g/255,this.b*t.b/255)}lerp(t,n){return new e(c(this.r,t.r,n),c(this.g,t.g,n),c(this.b,t.b,n))}toHSL(){let e=this.r/255,t=this.g/255,n=this.b/255,s=Math.max(e,t,n),r=Math.min(e,t,n),i=(s+r)/2,a=i,o=i;if(s==r)i=a=0;else{let l=s-r;switch(a=o>.5?l/(2-s-r):l/(s+r),s){case e:i=(t-n)/l+(t<n?6:0);break;case t:i=(n-e)/l+2;break;case n:i=(e-t)/l+4;break}i/=6}return[i,a,o]}eq(e){return this.r===e.r&&this.g===e.g&&this.b===e.b}toString(){return`rgb(${this.r}, ${this.g}, ${this.b})`}toHex(){return"#"+((1<<24)+(this.r<<16)+(this.g<<8)+this.b).toString(16).slice(1)}toArray(){return[this.r,this.g,this.b]}};function l(...e){if(0===e.length)return new o(255,255,255);if(1===e.length){if(e[0]instanceof o)return e[0].clone();if("string"==typeof e[0])return o.fromHex(e[0]);if(Array.isArray(e[0])&&3===e[0].length)return o.fromArray(e[0])}else if(2===e.length){if(e[0]instanceof o)return e[0].clone()}else if(3===e.length||4===e.length)return new o(e[0],e[1],e[2]);throw new Error("Invalid color arguments")}var h=(e,t,n)=>o.fromHSL(e,t,n);function u(e){return e*Math.PI/180}function d(e){return 180*e/Math.PI}function c(e,t,n){if("number"==typeof e&&"number"==typeof t)return e+(t-e)*n;if(e instanceof g&&t instanceof g)return e.lerp(t,n);if(e instanceof o&&t instanceof o)return e.lerp(t,n);throw new Error(`Bad value for lerp(): ${e}, ${t}. Only number, Vec2 and Color is supported.`)}function f(e,t,n,s,r){return s+(e-t)/(n-t)*(r-s)}function p(e,t,n,s,r){return a(f(e,t,n,s,r),s,r)}var g=class e{x=0;y=0;constructor(e=0,t=e){this.x=e,this.y=t}static fromAngle(t){let n=u(t);return new e(Math.cos(n),Math.sin(n))}static fromArray(t){return new e(t[0],t[1])}static ZERO=new e(0,0);static ONE=new e(1,1);static LEFT=new e(-1,0);static RIGHT=new e(1,0);static UP=new e(0,-1);static DOWN=new e(0,1);clone(){return new e(this.x,this.y)}add(...t){let n=m(...t);return new e(this.x+n.x,this.y+n.y)}sub(...t){let n=m(...t);return new e(this.x-n.x,this.y-n.y)}scale(...t){let n=m(...t);return new e(this.x*n.x,this.y*n.y)}dist(...e){let t=m(...e);return this.sub(t).len()}sdist(...e){let t=m(...e);return this.sub(t).slen()}static sdist(e,t){let n=e.x-t.x,s=e.y-t.y;return n*n+s*s}len(){return Math.sqrt(this.dot(this))}slen(){return this.dot(this)}unit(){let t=this.len();return 0===t?new e(0):this.scale(1/t)}normal(){return new e(this.y,-this.x)}reflect(e){return this.sub(e.scale(2*this.dot(e)))}project(e){return e.scale(e.dot(this)/e.len())}reject(e){return this.sub(this.project(e))}dot(e){return this.x*e.x+this.y*e.y}static dot(e,t){return e.x*t.x+e.y*t.y}cross(e){return this.x*e.y-this.y*e.x}static cross(e,t){return e.x*t.y-e.y*t.x}angle(...e){let t=m(...e);return d(Math.atan2(this.y-t.y,this.x-t.x))}angleBetween(...e){let t=m(...e);return d(Math.atan2(this.cross(t),this.dot(t)))}lerp(t,n){return new e(c(this.x,t.x,n),c(this.y,t.y,n))}slerp(e,t){let n=this.dot(e),s=this.cross(e),r=Math.atan2(s,n);return this.scale(Math.sin((1-t)*r)).add(e.scale(Math.sin(t*r))).scale(1/s)}isZero(){return 0===this.x&&0===this.y}toFixed(t){return new e(Number(this.x.toFixed(t)),Number(this.y.toFixed(t)))}transform(e){return e.multVec2(this)}eq(e){return this.x===e.x&&this.y===e.y}bbox(){return new ne(this,0,0)}toString(){return`vec2(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}toArray(){return[this.x,this.y]}};function m(...e){if(1===e.length){if(e[0]instanceof g)return new g(e[0].x,e[0].y);if(Array.isArray(e[0])&&2===e[0].length)return new g(...e[0])}return new g(...e)}var w=class e{x=0;y=0;w=1;h=1;constructor(e,t,n,s){this.x=e,this.y=t,this.w=n,this.h=s}scale(t){return new e(this.x+this.w*t.x,this.y+this.h*t.y,this.w*t.w,this.h*t.h)}pos(){return new g(this.x,this.y)}clone(){return new e(this.x,this.y,this.w,this.h)}eq(e){return this.x===e.x&&this.y===e.y&&this.w===e.w&&this.h===e.h}toString(){return`quad(${this.x}, ${this.y}, ${this.w}, ${this.h})`}};function y(e,t,n,s){return new w(e,t,n,s)}var A=class e{a;b;c;d;constructor(e,t,n,s){this.a=e,this.b=t,this.c=n,this.d=s}mul(t){return new e(this.a*t.a+this.b*t.c,this.a*t.b+this.b*t.d,this.c*t.a+this.d*t.c,this.c*t.b+this.d*t.d)}transform(e){return m(this.a*e.x+this.b*e.y,this.c*e.x+this.d*e.y)}get inverse(){let t=this.det;return new e(this.d/t,-this.b/t,-this.c/t,this.a/t)}get transpose(){return new e(this.a,this.c,this.b,this.d)}get eigenvalues(){let e=this.trace/2,t=this.det;return[e+Math.sqrt(e*e-t),e-Math.sqrt(e*e-t)]}eigenvectors(e,t){return 0!=this.c?[[e-this.d,this.c],[t-this.d,this.c]]:0!=this.b?[[this.b,e-this.a],[this.b,t-this.a]]:Math.abs(this.transform(m(1,0)).x-e)<Number.EPSILON?[[1,0],[0,1]]:[[0,1],[1,0]]}get det(){return this.a*this.d-this.b*this.c}get trace(){return this.a+this.d}static rotation(t){let n=Math.cos(t),s=Math.sin(t);return new e(n,s,-s,n)}static scale(t,n){return new e(t,0,0,n)}},x=class e{m11;m12;m13;m21;m22;m23;m31;m32;m33;constructor(e,t,n,s,r,i,a,o,l){this.m11=e,this.m12=t,this.m13=n,this.m21=s,this.m22=r,this.m23=i,this.m31=a,this.m32=o,this.m33=l}static fromMat2(t){return new e(t.a,t.b,0,t.c,t.d,0,0,0,1)}toMat2(){return new A(this.m11,this.m12,this.m21,this.m22)}mul(t){return new e(this.m11*t.m11+this.m12*t.m21+this.m13*t.m31,this.m11*t.m12+this.m12*t.m22+this.m13*t.m32,this.m11*t.m13+this.m12*t.m23+this.m13*t.m33,this.m21*t.m11+this.m22*t.m21+this.m23*t.m31,this.m21*t.m12+this.m22*t.m22+this.m23*t.m32,this.m21*t.m13+this.m22*t.m23+this.m23*t.m33,this.m31*t.m11+this.m32*t.m21+this.m33*t.m31,this.m31*t.m12+this.m32*t.m22+this.m33*t.m32,this.m31*t.m13+this.m32*t.m23+this.m33*t.m33)}get det(){return this.m11*this.m22*this.m33+this.m12*this.m23*this.m31+this.m13*this.m21*this.m32-this.m13*this.m22*this.m31-this.m12*this.m21*this.m33-this.m11*this.m23*this.m32}rotate(e){let t=Math.cos(e),n=Math.sin(e),s=this.m11,r=this.m12;return this.m11=t*this.m11+n*this.m21,this.m12=t*this.m12+n*this.m22,this.m21=t*this.m21-n*s,this.m22=t*this.m22-n*r,this}scale(e,t){return this.m11*=e,this.m12*=e,this.m21*=t,this.m22*=t,this}get inverse(){let t=this.det;return new e((this.m22*this.m33-this.m23*this.m32)/t,(this.m13*this.m32-this.m12*this.m33)/t,(this.m12*this.m23-this.m13*this.m22)/t,(this.m23*this.m31-this.m21*this.m33)/t,(this.m11*this.m33-this.m13*this.m31)/t,(this.m13*this.m21-this.m11*this.m23)/t,(this.m21*this.m32-this.m22*this.m31)/t,(this.m12*this.m31-this.m11*this.m32)/t,(this.m11*this.m22-this.m12*this.m21)/t)}get transpose(){return new e(this.m11,this.m21,this.m31,this.m12,this.m22,this.m32,this.m13,this.m23,this.m33)}},v=class e{m=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];constructor(e){e&&(this.m=e)}static translate(t){return new e([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1])}static scale(t){return new e([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1])}static rotateX(t){t=u(-t);let n=Math.cos(t),s=Math.sin(t);return new e([1,0,0,0,0,n,-s,0,0,s,n,0,0,0,0,1])}static rotateY(t){t=u(-t);let n=Math.cos(t),s=Math.sin(t);return new e([n,0,s,0,0,1,0,0,-s,0,n,0,0,0,0,1])}static rotateZ(t){t=u(-t);let n=Math.cos(t),s=Math.sin(t);return new e([n,-s,0,0,s,n,0,0,0,0,1,0,0,0,0,1])}translate(e){return this.m[12]+=this.m[0]*e.x+this.m[4]*e.y,this.m[13]+=this.m[1]*e.x+this.m[5]*e.y,this.m[14]+=this.m[2]*e.x+this.m[6]*e.y,this.m[15]+=this.m[3]*e.x+this.m[7]*e.y,this}scale(e){return this.m[0]*=e.x,this.m[4]*=e.y,this.m[1]*=e.x,this.m[5]*=e.y,this.m[2]*=e.x,this.m[6]*=e.y,this.m[3]*=e.x,this.m[7]*=e.y,this}rotate(e){e=u(-e);let t=Math.cos(e),n=Math.sin(e),s=this.m[0],r=this.m[1],i=this.m[4],a=this.m[5];return this.m[0]=s*t+r*n,this.m[1]=-s*n+r*t,this.m[4]=i*t+a*n,this.m[5]=-i*n+a*t,this}mult(t){let n=[];for(let e=0;e<4;e++)for(let s=0;s<4;s++)n[4*e+s]=this.m[0+s]*t.m[4*e+0]+this.m[4+s]*t.m[4*e+1]+this.m[8+s]*t.m[4*e+2]+this.m[12+s]*t.m[4*e+3];return new e(n)}multVec2(e){return new g(e.x*this.m[0]+e.y*this.m[4]+this.m[12],e.x*this.m[1]+e.y*this.m[5]+this.m[13])}getTranslation(){return new g(this.m[12],this.m[13])}getScale(){if(0!=this.m[0]||0!=this.m[1]){let e=this.m[0]*this.m[5]-this.m[1]*this.m[4],t=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new g(t,e/t)}if(0!=this.m[4]||0!=this.m[5]){let e=this.m[0]*this.m[5]-this.m[1]*this.m[4],t=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new g(e/t,t)}return new g(0,0)}getRotation(){if(0!=this.m[0]||0!=this.m[1]){let e=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return d(this.m[1]>0?Math.acos(this.m[0]/e):-Math.acos(this.m[0]/e))}if(0!=this.m[4]||0!=this.m[5]){let e=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return d(Math.PI/2-(this.m[5]>0?Math.acos(-this.m[4]/e):-Math.acos(this.m[4]/e)))}return 0}getSkew(){if(0!=this.m[0]||0!=this.m[1]){let e=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]);return new g(Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(e*e),0)}if(0!=this.m[4]||0!=this.m[5]){let e=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]);return new g(0,Math.atan(this.m[0]*this.m[4]+this.m[1]*this.m[5])/(e*e))}return new g(0,0)}invert(){let t=[],n=this.m[10]*this.m[15]-this.m[14]*this.m[11],s=this.m[9]*this.m[15]-this.m[13]*this.m[11],r=this.m[9]*this.m[14]-this.m[13]*this.m[10],i=this.m[8]*this.m[15]-this.m[12]*this.m[11],a=this.m[8]*this.m[14]-this.m[12]*this.m[10],o=this.m[8]*this.m[13]-this.m[12]*this.m[9],l=this.m[6]*this.m[15]-this.m[14]*this.m[7],h=this.m[5]*this.m[15]-this.m[13]*this.m[7],u=this.m[5]*this.m[14]-this.m[13]*this.m[6],d=this.m[4]*this.m[15]-this.m[12]*this.m[7],c=this.m[4]*this.m[14]-this.m[12]*this.m[6],f=this.m[5]*this.m[15]-this.m[13]*this.m[7],p=this.m[4]*this.m[13]-this.m[12]*this.m[5],g=this.m[6]*this.m[11]-this.m[10]*this.m[7],m=this.m[5]*this.m[11]-this.m[9]*this.m[7],w=this.m[5]*this.m[10]-this.m[9]*this.m[6],y=this.m[4]*this.m[11]-this.m[8]*this.m[7],A=this.m[4]*this.m[10]-this.m[8]*this.m[6],x=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*n-this.m[6]*s+this.m[7]*r,t[4]=-(this.m[4]*n-this.m[6]*i+this.m[7]*a),t[8]=this.m[4]*s-this.m[5]*i+this.m[7]*o,t[12]=-(this.m[4]*r-this.m[5]*a+this.m[6]*o),t[1]=-(this.m[1]*n-this.m[2]*s+this.m[3]*r),t[5]=this.m[0]*n-this.m[2]*i+this.m[3]*a,t[9]=-(this.m[0]*s-this.m[1]*i+this.m[3]*o),t[13]=this.m[0]*r-this.m[1]*a+this.m[2]*o,t[2]=this.m[1]*l-this.m[2]*h+this.m[3]*u,t[6]=-(this.m[0]*l-this.m[2]*d+this.m[3]*c),t[10]=this.m[0]*f-this.m[1]*d+this.m[3]*p,t[14]=-(this.m[0]*u-this.m[1]*c+this.m[2]*p),t[3]=-(this.m[1]*g-this.m[2]*m+this.m[3]*w),t[7]=this.m[0]*g-this.m[2]*y+this.m[3]*A,t[11]=-(this.m[0]*m-this.m[1]*y+this.m[3]*x),t[15]=this.m[0]*w-this.m[1]*A+this.m[2]*x;let v=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let e=0;e<4;e++)for(let n=0;n<4;n++)t[4*e+n]*=1/v;return new e(t)}clone(){return new e([...this.m])}toString(){return this.m.toString()}};function b(e,t,n,s=(e=>-Math.cos(e))){return e+(s(n)+1)/2*(t-e)}var E=2147483648,M=class{seed;constructor(e){this.seed=e}gen(){return this.seed=(1103515245*this.seed+12345)%E,this.seed/E}genNumber(e,t){return e+this.gen()*(t-e)}genVec2(e,t){return new g(this.genNumber(e.x,t.x),this.genNumber(e.y,t.y))}genColor(e,t){return new o(this.genNumber(e.r,t.r),this.genNumber(e.g,t.g),this.genNumber(e.b,t.b))}genAny(...e){if(0===e.length)return this.gen();if(1===e.length){if("number"==typeof e[0])return this.genNumber(0,e[0]);if(e[0]instanceof g)return this.genVec2(m(0,0),e[0]);if(e[0]instanceof o)return this.genColor(l(0,0,0),e[0])}else if(2===e.length){if("number"==typeof e[0]&&"number"==typeof e[1])return this.genNumber(e[0],e[1]);if(e[0]instanceof g&&e[1]instanceof g)return this.genVec2(e[0],e[1]);if(e[0]instanceof o&&e[1]instanceof o)return this.genColor(e[0],e[1])}throw new Error("More than 2 arguments not supported")}},q=new M(Date.now());function S(e){return null!=e&&(q.seed=e),q.seed}function B(...e){return q.genAny(...e)}function R(...e){return Math.floor(B(...e.length>0?e:[2]))}function I(e){return B()<=e}function k(e){for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function P(e,t){return e.length<=t?e.slice():k(e.slice()).slice(0,t)}function C(e){return e[R(e.length)]}function F(e,t){return e.pos.x+e.width>t.pos.x&&e.pos.x<t.pos.x+t.width&&e.pos.y+e.height>t.pos.y&&e.pos.y<t.pos.y+t.height}function T(e,t){let n=function(e,t){if(e.p1.x===e.p2.x&&e.p1.y===e.p2.y||t.p1.x===t.p2.x&&t.p1.y===t.p2.y)return null;let n=(t.p2.y-t.p1.y)*(e.p2.x-e.p1.x)-(t.p2.x-t.p1.x)*(e.p2.y-e.p1.y);if(0===n)return null;let s=((t.p2.x-t.p1.x)*(e.p1.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.p1.x-t.p1.x))/n,r=((e.p2.x-e.p1.x)*(e.p1.y-t.p1.y)-(e.p2.y-e.p1.y)*(e.p1.x-t.p1.x))/n;return s<0||s>1||r<0||r>1?null:s}(e,t);return n?m(e.p1.x+n*(e.p2.x-e.p1.x),e.p1.y+n*(e.p2.y-e.p1.y)):null}function D(e,t){let n=t.p2.sub(t.p1),s=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY;if(0!=n.x){let i=(e.pos.x-t.p1.x)/n.x,a=(e.pos.x+e.width-t.p1.x)/n.x;s=Math.max(s,Math.min(i,a)),r=Math.min(r,Math.max(i,a))}if(0!=n.y){let i=(e.pos.y-t.p1.y)/n.y,a=(e.pos.y+e.height-t.p1.y)/n.y;s=Math.max(s,Math.min(i,a)),r=Math.min(r,Math.max(i,a))}return r>=s&&r>=0&&s<=1}function O(e,t){return t.x>e.pos.x&&t.x<e.pos.x+e.width&&t.y>e.pos.y&&t.y<e.pos.y+e.height}function U(e,t){return m(Math.max(e.pos.x,Math.min(t.center.x,e.pos.x+e.width)),Math.max(e.pos.y,Math.min(t.center.y,e.pos.y+e.height))).sdist(t.center)<=t.radius*t.radius}function L(e,t){return K(t,new ie(e.points()))}function N(e,t){let n=t.sub(e.p1),s=e.p2.sub(e.p1);if(Math.abs(n.cross(s))>Number.EPSILON)return!1;let r=n.dot(s)/s.dot(s);return r>=0&&r<=1}function H(e,t){let n=e.p2.sub(e.p1),s=n.dot(n),r=e.p1.sub(t.center),i=2*n.dot(r),a=i*i-4*s*(r.dot(r)-t.radius*t.radius);if(s<=Number.EPSILON||a<0)return!1;if(0==a){let e=-i/(2*s);if(e>=0&&e<=1)return!0}else{let e=(-i+Math.sqrt(a))/(2*s),t=(-i-Math.sqrt(a))/(2*s);if(e>=0&&e<=1||t>=0&&t<=1)return!0}return G(t,e.p1)}function j(e,t){if(Y(t,e.p1)||Y(t,e.p2))return!0;for(let n=0;n<t.pts.length;n++){let s=t.pts[n],r=t.pts[(n+1)%t.pts.length];if(T(e,new te(s,r)))return!0}return!1}function G(e,t){return e.center.sdist(t)<e.radius*e.radius}function V(e,t){let n=t.pts[t.pts.length-1];for(let s of t.pts){if(H(new te(n,s),e))return!0;n=s}return!!G(e,t.pts[0])||Y(t,e.center)}function K(e,t){for(let n=0;n<e.pts.length;n++)if(j(new te(e.pts[n],e.pts[(n+1)%e.pts.length]),t))return!0;return!(!e.pts.some((e=>Y(t,e)))&&!t.pts.some((t=>Y(e,t))))}function Y(e,t){let n=!1,s=e.pts;for(let e=0,r=s.length-1;e<s.length;r=e++)s[e].y>t.y!=s[r].y>t.y&&t.x<(s[r].x-s[e].x)*(t.y-s[e].y)/(s[r].y-s[e].y)+s[e].x&&(n=!n);return n}function X(e,t){t=t.sub(e.center);let n=u(e.angle),s=Math.cos(n),r=Math.sin(n),i=t.x*s+t.y*r,a=-t.x*r+t.y*s;return i*i/(e.radiusX*e.radiusX)+a*a/(e.radiusY*e.radiusY)<1}function Q(e,t){let n=t.center.sub(e.center),s=u(e.angle),r=Math.cos(s),i=Math.sin(s),a=n.x*r+n.y*i,o=-n.x*i+n.y*r;return X(new re(m(),e.radiusX+t.radius,e.radiusY+t.radius,0),m(a,o))}function W(e,t){let n=e.toMat2().inverse;return H(t=new te(n.transform(t.p1.sub(e.center)),n.transform(t.p2.sub(e.center))),new se(m(),1))}function z(e,t){return Z(e,new ie(t.points()))}function Z(e,t){let n=e.toMat2().inverse;return t=new ie(t.pts.map((t=>n.transform(t.sub(e.center))))),V(new se(m(),1),t)}function J(e,t){return t instanceof g?X(e,t):t instanceof se?Q(e,t):t instanceof te?W(e,t):t instanceof ne?z(e,t):t instanceof ie?Z(e,t):t instanceof re&&function(e,t){if(e.radiusX===e.radiusY)return Q(t,new se(e.center,e.radiusX));if(t.radiusX===t.radiusY)return Q(e,new se(t.center,t.radiusX));let n=new x(1/e.radiusX**2,0,0,0,1/e.radiusY**2,0,0,0,-1),s=new x(1/t.radiusX**2,0,0,0,1/t.radiusY**2,0,0,0,-1),r=e.center.x,i=e.center.y,a=t.center.x,o=t.center.y,l=u(e.angle),h=u(t.angle),d=new x(Math.cos(l),-Math.sin(l),r,Math.sin(l),Math.cos(l),i,0,0,1),c=new x(Math.cos(h),-Math.sin(h),a,Math.sin(h),Math.cos(h),o,0,0,1),f=d.inverse,p=c.inverse,g=f.transpose.mul(n).mul(f),m=p.transpose.mul(s).mul(p),w=g.m11,y=g.m12,A=g.m13,v=g.m21,b=g.m22,E=g.m23,M=g.m31,q=g.m32,S=g.m33,B=m.m11,R=m.m12,I=m.m13,k=m.m21,P=m.m22,C=m.m23,F=m.m31,T=m.m32,D=m.m33,O=w*b*S-w*E*q-y*v*S+y*E*M+A*v*q-A*b*M,U=(w*b*D-w*E*T-w*q*C+w*S*P-y*v*D+y*E*F+y*M*C-y*S*k+A*v*T-A*b*F-A*M*P+A*q*k+v*q*I-v*S*R-b*M*I+b*S*B+E*M*R-E*q*B)/O,L=(w*P*D-w*C*T-y*k*D+y*C*F+A*k*T-A*P*F-v*R*D+v*I*T+b*B*D-b*I*F-E*B*T+E*R*F+M*R*C-M*I*P-q*B*C+q*I*k+S*B*P-S*R*k)/O,N=(B*P*D-B*C*T-R*k*D+R*C*F+I*k*T-I*P*F)/O;if(U>=0){let e=3*U*N+L*U**2-4*L**2,t=-27*N**2+18*N*U*L+U**2*L**2-4*U**3*N-4*L**3;return!(-3*L+U**2>0&&e<0&&t>0)}{let e=-27*N**2+18*N*U*L+U**2*L**2-4*U**3*N-4*L**3;return!(-3*L+U**2>0&&e>0)}}(t,e)}function _(e,t,n){let s=e,r=n.p1,i=t,a=n.p2.sub(r),o=i.cross(a);if(Math.abs(o)<Number.EPSILON)return null;let l=r.sub(s),h=l.cross(a)/o;if(h<=0||h>=1)return null;let u=l.cross(i)/o;if(u<=0||u>=1)return null;let d=a.normal().unit();return t.dot(d)>0&&(d.x*=-1,d.y*=-1),{point:s.add(i.scale(h)),normal:d,fraction:h}}function $(e,t,n){let s=e,r=n.center,i=t,a=i.dot(i),o=s.sub(r),l=2*i.dot(o),h=l*l-4*a*(o.dot(o)-n.radius*n.radius);if(a<=Number.EPSILON||h<0)return null;if(0==h){let e=-l/(2*a);if(e>=0&&e<=1){let t=s.add(i.scale(e));return{point:t,normal:t.sub(r),fraction:e}}}else{let e=(-l+Math.sqrt(h))/(2*a),t=(-l-Math.sqrt(h))/(2*a),n=null;if(e>=0&&e<=1&&(n=e),t>=0&&t<=1&&(n=Math.min(t,n??t)),null!=n){let e=s.add(i.scale(n));return{point:e,normal:e.sub(r).unit(),fraction:n}}}return null}var ee=class e{pt;constructor(e){this.pt=e.clone()}transform(t){return new e(t.multVec2(this.pt))}bbox(){return new ne(this.pt,0,0)}area(){return 0}clone(){return new e(this.pt)}collides(e){return function(e,t){return t instanceof g?function(e,t){return e.x===t.x&&e.y===t.y}(t,e.pt):t instanceof se?G(t,e.pt):t instanceof te?N(t,e.pt):t instanceof ne?O(t,e.pt):t instanceof ie?Y(t,e.pt):t instanceof re&&X(t,e.pt)}(this,e)}contains(e){return this.pt.eq(e)}raycast(e,t){return null}random(){return this.pt.clone()}},te=class e{p1;p2;constructor(e,t){this.p1=e.clone(),this.p2=t.clone()}transform(t){return new e(t.multVec2(this.p1),t.multVec2(this.p2))}bbox(){return ne.fromPoints(this.p1,this.p2)}area(){return this.p1.dist(this.p2)}clone(){return new e(this.p1,this.p2)}collides(e){return function(e,t){return t instanceof g?N(e,t):t instanceof se?H(e,t):t instanceof te?null!=T(e,t):t instanceof ne?D(t,e):t instanceof ie?j(e,t):t instanceof re&&W(t,e)}(this,e)}contains(e){return this.collides(e)}raycast(e,t){return _(e,t,this)}random(){return this.p1.add(this.p2.sub(this.p1).scale(B(1)))}},ne=class e{pos;width;height;constructor(e,t,n){this.pos=e.clone(),this.width=t,this.height=n}static fromPoints(t,n){return new e(t.clone(),n.x-t.x,n.y-t.y)}center(){return new g(this.pos.x+this.width/2,this.pos.y+this.height/2)}points(){return[this.pos,this.pos.add(this.width,0),this.pos.add(this.width,this.height),this.pos.add(0,this.height)]}transform(e){return new ie(this.points().map((t=>e.multVec2(t))))}bbox(){return this.clone()}area(){return this.width*this.height}clone(){return new e(this.pos.clone(),this.width,this.height)}distToPoint(e){return Math.sqrt(this.sdistToPoint(e))}sdistToPoint(e){let t=this.pos,n=this.pos.add(this.width,this.height),s=Math.max(t.x-e.x,0,e.x-n.x),r=Math.max(t.y-e.y,0,e.y-n.y);return s*s+r*r}collides(e){return function(e,t){return t instanceof g?O(e,t):t instanceof se?U(e,t):t instanceof te?D(e,t):t instanceof ne?F(e,t):t instanceof ie?L(e,t):t instanceof re&&z(t,e)}(this,e)}contains(e){return this.collides(e)}raycast(e,t){return function(e,t,n){let s,r=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;if(0!=e.x){let a=(n.pos.x-e.x)/t.x,o=(n.pos.x+n.width-e.x)/t.x;s=m(-Math.sign(t.x),0),r=Math.max(r,Math.min(a,o)),i=Math.min(i,Math.max(a,o))}if(0!=e.y){let a=(n.pos.y-e.y)/t.y,o=(n.pos.y+n.height-e.y)/t.y;Math.min(a,o)>r&&(s=m(0,-Math.sign(t.y))),r=Math.max(r,Math.min(a,o)),i=Math.min(i,Math.max(a,o))}return i>=r&&r>=0&&r<=1?{point:e.add(t.scale(r)),normal:s,fraction:r}:null}(e,t,this)}random(){return this.pos.add(B(this.width),B(this.height))}},se=class e{center;radius;constructor(e,t){this.center=e.clone(),this.radius=t}transform(e){return new re(this.center,this.radius,this.radius).transform(e)}bbox(){return ne.fromPoints(this.center.sub(m(this.radius)),this.center.add(m(this.radius)))}area(){return this.radius*this.radius*Math.PI}clone(){return new e(this.center,this.radius)}collides(e){return function(e,t){return t instanceof g?G(e,t):t instanceof se?function(e,t){return e.center.sdist(t.center)<(e.radius+t.radius)*(e.radius+t.radius)}(e,t):t instanceof te?H(t,e):t instanceof ne?U(t,e):t instanceof ie?V(e,t):t instanceof re&&Q(t,e)}(this,e)}contains(e){return this.collides(e)}raycast(e,t){return $(e,t,this)}random(){return this.center.add(g.fromAngle(B(360)).scale(B(this.radius)))}},re=class e{center;radiusX;radiusY;angle;constructor(e,t,n,s=0){this.center=e.clone(),this.radiusX=t,this.radiusY=n,this.angle=s}static fromMat2(t){let n=t.inverse,s=n.transpose.mul(n),[r,i]=s.eigenvalues,[a,o]=s.eigenvectors(r,i),[l,h]=[1/Math.sqrt(r),1/Math.sqrt(i)];return l>h?new e(m(),l,h,d(Math.atan2(-a[1],a[0]))):new e(m(),h,l,d(Math.atan2(-o[1],o[0])))}toMat2(){let e=u(this.angle),t=Math.cos(e),n=Math.sin(e);return new A(t*this.radiusX,-n*this.radiusY,n*this.radiusX,t*this.radiusY)}transform(t){if(0==this.angle&&0==t.getRotation())return new e(t.multVec2(this.center),t.m[0]*this.radiusX,t.m[5]*this.radiusY);{let n=this.toMat2(),s=t.getRotation(),r=t.getScale();n=x.fromMat2(n).scale(r.x,r.y).rotate(s).toMat2();let i=e.fromMat2(n);return i.center=t.multVec2(this.center),i}}bbox(){if(0==this.angle)return ne.fromPoints(this.center.sub(m(this.radiusX,this.radiusY)),this.center.add(m(this.radiusX,this.radiusY)));{let e=u(this.angle),t=Math.cos(e),n=Math.sin(e),s=this.radiusX*t,r=this.radiusX*n,i=this.radiusY*n,a=this.radiusY*t,o=Math.sqrt(s*s+i*i),l=Math.sqrt(r*r+a*a);return ne.fromPoints(this.center.sub(m(o,l)),this.center.add(m(o,l)))}}area(){return this.radiusX*this.radiusY*Math.PI}clone(){return new e(this.center,this.radiusX,this.radiusY,this.angle)}collides(e){return J(this,e)}contains(e){e=e.sub(this.center);let t=u(this.angle),n=Math.cos(t),s=Math.sin(t),r=e.x*n+e.y*s,i=-e.x*s+e.y*n;return r*r/(this.radiusX*this.radiusX)+i*i/(this.radiusY*this.radiusY)<1}raycast(e,t){return function(e,t,n){let s=n.toMat2(),r=s.inverse,i=$(r.transform(e.sub(n.center)),r.transform(t),new se(m(),1));if(i){let r=A.rotation(u(-n.angle)),a=A.scale(n.radiusX,n.radiusY).transform(i.point),o=s.transform(i.point).add(n.center),l=o.dist(e)/t.len();return{point:o,normal:r.transform(m(n.radiusY**2*a.x,n.radiusX**2*a.y)).unit(),fraction:l}}return i}(e,t,this)}random(){return this.center}};var ie=class e{pts;constructor(e){if(e.length<3)throw new Error("Polygons should have at least 3 vertices");this.pts=e}transform(t){return new e(this.pts.map((e=>t.multVec2(e))))}bbox(){let e=m(Number.MAX_VALUE),t=m(-Number.MAX_VALUE);for(let n of this.pts)e.x=Math.min(e.x,n.x),t.x=Math.max(t.x,n.x),e.y=Math.min(e.y,n.y),t.y=Math.max(t.y,n.y);return ne.fromPoints(e,t)}area(){let e=0,t=this.pts.length;for(let n=0;n<t;n++){let s=this.pts[n],r=this.pts[(n+1)%t];e+=s.x*r.y*.5,e-=r.x*s.y*.5}return Math.abs(e)}clone(){return new e(this.pts.map((e=>e.clone())))}collides(e){return function(e,t){return t instanceof g?Y(e,t):t instanceof se?V(t,e):t instanceof te?j(t,e):t instanceof ne?L(t,e):t instanceof ie?K(t,e):t instanceof re&&Z(t,e)}(this,e)}contains(e){return this.collides(e)}raycast(e,t){return function(e,t,n){let s=n.pts,r=null,i=s[s.length-1];for(let n=0;n<s.length;n++){let a=s[n],o=_(e,t,new te(i,a));o&&(!r||r.fraction>o.fraction)&&(r=o),i=a}return r}(e,t,this)}random(){return m()}cut(t,n){new te(t,n);let s=[],r=[],i=n.sub(t),a=this.pts[this.pts.length-1],o=a.sub(t),l=i.cross(o)>0;return this.pts.forEach((e=>{o=e.sub(t);let h=i.cross(o)>0;if(l!=h){let i=function(e,t,n,s){let r=t.sub(e),i=s.sub(n),a=r.cross(i);return a<1e-5&&a>-1e-5||(a=n.sub(e).cross(i)/a,a<0||a>1)?null:e.add(r.scale(a))}(a,e,t,n);s.push(i),r.push(i),l=h}(h?s:r).push(e),a=e})),[s.length?new e(s):null,r.length?new e(r):null]}};function ae(e,t,n,s){let r=s*s,i=1-s,a=i*i;return e.scale(a).add(t.scale(2*i*s)).add(n.scale(r))}function oe(e,t,n,s){let r=1-s;return t.sub(e).scale(2*r).add(n.sub(t).scale(2*s))}function le(e,t,n,s){return n.sub(t.scale(2)).add(e).scale(2)}function he(e,t,n,s,r){let i=r*r,a=i*r,o=1-r,l=o*o,h=l*o;return e.scale(h).add(t.scale(3*l*r)).add(n.scale(3*o*i)).add(s.scale(a))}function ue(e,t,n,s,r){let i=r*r,a=1-r,o=a*a;return t.sub(e).scale(3*o).add(n.sub(t).scale(6*a*r)).add(s.sub(n).scale(3*i))}function de(e,t,n,s,r){let i=1-r;return n.sub(t.scale(2)).add(e).scale(6*i).add(s.sub(n.scale(2)).add(t).scale(6*r))}function ce(e,t,n,s,r){let i=((2-r)*r-1)*r*.5,a=.5*((3*r-5)*r*r+2),o=((-3*r+4)*r+1)*r*.5,l=(r-1)*r*r*.5;return e.scale(i).add(t.scale(a)).add(n.scale(o)).add(s.scale(l))}function fe(e,t,n,s,r){let i=.5*((-3*r+4)*r-1),a=(9*r-10)*r*.5,o=.5*((-9*r+8)*r+1),l=(3*r-2)*r*.5;return e.scale(i).add(t.scale(a)).add(n.scale(o)).add(s.scale(l))}function pe(e){let t=ge(e),n=t(1);return s=>{let r=t(s*n,!0);return e(r)}}function ge(e,t=10,n=10){let s=[0],r=[0],i=1/(t-1)/n,a=0,o=e(0),l=0;for(let h=1;h<t;h++){for(let t=0;t<n;t++){l+=i;let t=e(l),n=t.dist(o);a+=n,o=t}s[h]=a,r[h]=l}return r[t-1]=1,(e,n=!1)=>{if(n){let t=e;if(t<=0)return 0;if(t>=a)return 1;let n=0;for(;s[n+1]<t;)n++;let i=r[n],o=r[n+1],l=s[n];return i+(o-i)*((t-l)/(s[n+1]-l))}{if(e<=0)return 0;if(e>=1)return s[t-1];let n=0;for(;r[n+1]<e;)n++;let i=r[n],a=r[n+1],o=s[n];return o+(s[n+1]-o)*((e-i)/(a-i))}}}function me(e,t,n,s){let r=2*e+t-2*s+n,i=-3*e+3*s-2*t-n,a=t,o=e;return e=>{let t=e*e;return r*(t*e)+i*t+a*e+o}}function we(e,t,n,s,r,i=me){let a=i(t.x,(1-r)*(n.x-e.x),(1-r)*(s.x-t.x),n.x),o=i(t.y,(1-r)*(n.y-e.y),(1-r)*(s.y-t.y),n.y);return e=>new g(a(e),o(e))}function ye(e,t,n,s,r=me){return we(e,t,n,s,.5,r)}function Ae(e,t,n,s,r=me){return ye(s.add(e.sub(t).scale(6)),e,s,e.add(s.sub(n).scale(6)),r)}function xe(e,t,n,s,r,i,a,o=me){let l=o(t.x,.5*(1-r)*(1+a)*(1+i)*(t.x-e.x)+.5*(1-r)*(1-a)*(1-i)*(n.x-t.x),.5*(1-r)*(1+a)*(1-i)*(n.x-t.x)+.5*(1-r)*(1-a)*(1+i)*(s.x-n.x),n.x),h=o(t.y,.5*(1-r)*(1+a)*(1+i)*(t.y-e.y)+.5*(1-r)*(1-a)*(1-i)*(n.y-t.y),.5*(1-r)*(1+a)*(1-i)*(n.y-t.y)+.5*(1-r)*(1-a)*(1+i)*(s.y-n.y),n.y);return e=>new g(l(e),h(e))}function ve(e,t,n,s){let r=2*e+t-2*s+n,i=-3*e+3*s-2*t+n,a=t;return e=>3*r*(e*e)+2*i*e+a}function be(e){return 0<=e&&e<=1}function Ee(e,t){return Math.abs(e-t)<=Number.EPSILON}function Me(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function qe(e,t,n,s,r){let i=function(e,t,n,s){let r=3*e-6*t+3*n,i=-3*e+3*t,a=e,o=3*t-e-3*n+s;if(Ee(o,0)){if(Ee(r,0))return Ee(i,0)?[]:[-a/i].filter(be);let e=Math.sqrt(i*i-4*r*a),t=2*r;return[(e-i)/t,(-i-e)/t].filter(be)}r/=o,i/=o,a/=o;let l=(3*i-r*r)/3,h=l/3,u=(2*r*r*r-9*r*i+27*a)/27,d=u/2,c=d*d+h*h*h;if(c<0){let e=-l/3,t=e*e*e,n=Math.sqrt(t),s=-u/(2*n),i=s<-1?-1:s>1?1:s,a=Math.acos(i),o=2*Me(n);return[o*Math.cos(a/3)-r/3,o*Math.cos((a+2*Math.PI)/3)-r/3,o*Math.cos((a+4*Math.PI)/3)-r/3].filter(be)}if(0===c){let e=d<0?Me(-d):-Me(d);return[2*e-r/3,-e-r/3].filter(be)}let f=Math.sqrt(c);return[Me(f-d)-Me(f+d)-r/3].filter(be)}(e.x-r,t.x-r,n.x-r,s.x-r);return i.length>0?he(e,t,n,s,i[0]).y:NaN}function Se(e){if(!e||0==e.length)throw new Error("Need at least one point for easingLinear.");let t=e.length;return n=>{if(n<=0||1==e.length||n<=e[0].x)return e[0].y;for(let s=0;s<t;s++)if(e[s].x>=n)return f(n,e[s-1].x,e[s].x,e[s-1].y,e[s].y);return e[e.length-1].y}}function Be(e,t){return n=>qe(m(0,0),e,t,m(1,1),n)}function Re(e,t="jump-end"){let n=1/e,s=1/(e+("jump-end"==t||"jump-both"==t?1:0)),r="jump-start"==t||"jump-both"==t?s:0;return e=>{let t=Math.floor(e/n);return r+t*s}}function Ie(e,t){let n=Number.MAX_VALUE,s={normal:m(0),distance:0};for(let r of[e,t])for(let i=0;i<r.pts.length;i++){let a=r.pts[i],o=r.pts[(i+1)%r.pts.length].sub(a).normal().unit(),l=Number.MAX_VALUE,h=-Number.MAX_VALUE;for(let t=0;t<e.pts.length;t++){let n=e.pts[t].dot(o);l=Math.min(l,n),h=Math.max(h,n)}let u=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let e=0;e<t.pts.length;e++){let n=t.pts[e].dot(o);u=Math.min(u,n),d=Math.max(d,n)}let c=Math.min(h,d)-Math.max(l,u);if(c<0)return null;if(c<Math.abs(n)){let e=d-l,t=u-h;n=Math.abs(e)<Math.abs(t)?e:t,s.normal=o,s.distance=n}}return s}function ke(e,t,n){return(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x)>=0}function Pe(e,t,n,s){let r=s.x-n.x,i=s.y-n.y;return(r*(e.y-n.y)-i*(e.x-n.x))*(r*(t.y-n.y)-i*(t.x-n.x))>=0}function Ce(e,t,n,s){return Pe(e,t,n,s)&&Pe(e,n,t,s)&&Pe(e,s,t,n)}function Fe(e,t,n,s){return ke(e,t,n)&&!function(e,t,n,s){for(let r of e)if(r!==t&&r!==n&&r!==s&&Ce(r,t,n,s))return!0;return!1}(s,e,t,n)}function Te(e){if(e.length<3)return[];if(3==e.length)return[e];let t=[],n=[],s=0;for(let r=0;r<e.length;r++){let i=e[s],a=e[r];(a.x<i.x||a.x==i.x&&a.y<i.y)&&(s=s),t[r]=r+1,n[r]=r-1}t[t.length-1]=0,n[0]=n.length-1,function(e){let t=0,n=e[e.length-1];for(let s=0;s<e.length;s++)t+=(e[s].x-n.x)*(e[s].y+n.y),n=e[s];return t<0}(e)||([t,n]=[n,t]);let r=[];for(let s=0;s<e.length;++s)ke(e[n[s]],e[s],e[t[s]])||r.push(e[s]);let i,a,o=[],l=e.length,h=1,u=0;for(;l>3;){i=t[h],a=n[h];let s=e[a],d=e[h],c=e[i];if(Fe(s,d,c,r))o.push([s,d,c]),t[a]=i,n[i]=a,r.splice(r.indexOf(d),1),--l,u=0;else if(++u>l)return[];h=i}return i=t[h],a=n[h],o.push([e[a],e[h],e[i]]),o}function De(e){if(e.length<3)return!1;let t=e.length-2,n=e.length-1,s=0,r=e[n].sub(e[t]),i=e[s].sub(e[n]),a=r.cross(i);for(;s+1<e.length;)if(t=n,n=s,s++,r=e[n].sub(e[t]),i=e[s].sub(e[n]),r.cross(i)*a<0)return!1;return!0}var Oe=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",Ue="topleft",Le="monospace",Ne="linear",He=[{name:"a_pos",size:2},{name:"a_uv",size:2},{name:"a_color",size:4}],je=He.reduce(((e,t)=>e+t.size),0),Ge=8192*je,Ve="\nattribute vec2 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec2 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvec4 def_vert() {\n\treturn vec4(a_pos, 0.0, 1.0);\n}\n\n{{user}}\n\nvoid main() {\n\tvec4 pos = vert(a_pos, a_uv, a_color);\n\tv_pos = a_pos;\n\tv_uv = a_uv;\n\tv_color = a_color;\n\tgl_Position = pos;\n}\n",Ke="\nprecision mediump float;\n\nvarying vec2 v_pos;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nuniform sampler2D u_tex;\n\nvec4 def_frag() {\n\tvec4 texColor = texture2D(u_tex, v_uv);\n\treturn vec4((v_color.rgb * texColor.rgb), texColor.a) * v_color.a;\n}\n\n{{user}}\n\nvoid main() {\n\tgl_FragColor = frag(v_pos, v_uv, v_color, u_tex);\n\tif (gl_FragColor.a == 0.0) {\n\t\tdiscard;\n\t}\n}\n",Ye="\nvec4 vert(vec2 pos, vec2 uv, vec4 color) {\n\treturn def_vert();\n}\n",Xe="\nvec4 frag(vec2 pos, vec2 uv, vec4 color, sampler2D tex) {\n\treturn def_frag();\n}\n",Qe=new Set(["id","require"]),We=new Set(["add","fixedUpdate","update","draw","destroy","inspect","drawInspect"]),ze=Symbol.for("kaplay.cancel"),Ze=class extends Map{lastID=0;push(e){let t=this.lastID;return this.set(t,e),this.lastID++,t}pushd(e){let t=this.push(e);return()=>this.delete(t)}},Je=class e{paused=!1;cancel;constructor(e){this.cancel=e}static join(t){let n=new e((()=>t.forEach((e=>e.cancel()))));return Object.defineProperty(n,"paused",{get:()=>t[0].paused,set:e=>t.forEach((t=>t.paused=e))}),n.paused=!1,n}static replace(e,t){return e.cancel=()=>t.cancel(),t.paused=e.paused,Object.defineProperty(e,"paused",{get:()=>t.paused,set:e=>t.paused=e}),e}},_e=class{cancellers=new WeakMap;handlers=new Ze;add(e){function t(...t){if(!s.paused)return e(...t)}let n=this.handlers.pushd(t),s=new Je(n);return this.cancellers.set(t,n),s}addOnce(e){let t=this.add(((...n)=>{t.cancel(),e(...n)}));return t}next(){return new Promise((e=>this.addOnce(e)))}trigger(...e){this.handlers.forEach((t=>{let n;t(...e)===ze&&(n=this.cancellers.get(t))&&n()}))}numListeners(){return this.handlers.size}clear(){this.handlers.clear()}},$e=class{handlers={};registers={};on(e,t){return this.handlers[e]||(this.handlers[e]=new _e),this.handlers[e].add(t)}onOnce(e,t){let n=this.on(e,((...e)=>{n.cancel(),t(...e)}));return n}next(e){return new Promise((t=>{this.onOnce(e,((...e)=>t(e[0])))}))}trigger(e,...t){this.handlers[e]&&this.handlers[e].trigger(...t)}remove(e){delete this.handlers[e]}clear(){this.handlers={}}numListeners(e){return this.handlers[e]?.numListeners()??0}},et=e=>e[0]instanceof o,tt=e=>e[0]instanceof g,nt=class{_items;_compareFn;constructor(e=((e,t)=>e<t)){this._compareFn=e,this._items=[]}insert(e){this._items.push(e),this.moveUp(this._items.length-1)}remove(){if(0===this._items.length)return null;let e=this._items[0],t=this._items.pop();return 0!==this._items.length&&(this._items[0]=t,this.moveDown(0)),e}clear(){this._items.splice(0,this._items.length)}moveUp(e){for(;e>0;){let t=Math.floor((e-1)/2);if(!this._compareFn(this._items[e],this._items[t])&&this._items[e]>=this._items[t])break;this.swap(e,t),e=t}}moveDown(e){for(;e<Math.floor(this._items.length/2);){let t=2*e+1;if(t<this._items.length-1&&!this._compareFn(this._items[t],this._items[t+1])&&++t,this._compareFn(this._items[e],this._items[t]))break;this.swap(e,t),e=t}}swap(e,t){[this._items[e],this._items[t]]=[this._items[t],this._items[e]]}get length(){return this._items.length}};function st(e){return function(e){let t=window.atob(e),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.charCodeAt(e);return s.buffer}(e.split(",")[1])}function rt(e,t){let n=document.createElement("a");n.href=t,n.download=e,n.click()}function it(e,t){rt(e,"data:text/plain;charset=utf-8,"+t)}function at(e,t){it(e,JSON.stringify(t))}function ot(e,t){let n=URL.createObjectURL(t);rt(e,n),URL.revokeObjectURL(n)}var lt=e=>e.match(/^data:\w+\/\w+;base64,.+/);function ht(e,t){if(e===t)return!0;let n=typeof e,s=typeof t;if(n!==s)return!1;if("object"===n&&"object"===s&&null!==e&&null!==t){if(Array.isArray(e)!==Array.isArray(t))return!1;let n=Object.keys(e),s=Object.keys(t);if(n.length!==s.length)return!1;for(let s of n){if(!ht(e[s],t[s]))return!1}return!0}return!1}var ut=new Set;function dt(e,t){!function(e){ut.has(e)||ut.add(e)}(`${e} is deprecated. Use ${t} instead.`)}function ct(e,t){return Number(e.toFixed(t))}function ft(e,t){return(...n)=>{let s=n.length;return s===e.length?e(...n):s===t.length?t(...n):void 0}}var pt=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);function gt(e,t){let n=t[e];if(!function(e){return e&&bt(e[0].charCodeAt(0),55296,56319)}(n)||e===t.length-1)return 1;let s=n+t[e+1],r=t.substring(e+2,e+5);return mt(s)&&mt(r)?4:function(e){return bt(vt(e),127988,127988)}(s)&&function(e){let t=e.codePointAt(0);return"string"==typeof e&&"number"==typeof t&&bt(t,917504,917631)}(r)?t.slice(e).indexOf(String.fromCodePoint(917631))+2:function(e){return bt(vt(e),127995,127999)}(r)?4:2}function mt(e){return bt(vt(e),127462,127487)}function wt(e){return"string"==typeof e&&bt(e.charCodeAt(0),65024,65039)}function yt(e){return"string"==typeof e&&bt(e.charCodeAt(0),8400,8447)}function At(e){return"string"==typeof e&&pt.includes(e.charCodeAt(0))}function xt(e){return"string"==typeof e&&8205===e.charCodeAt(0)}function vt(e){return(e.charCodeAt(0)-55296<<10)+(e.charCodeAt(1)-56320)+65536}function bt(e,t,n){return e>=t&&e<=n}var Et=(e,t)=>Array.isArray(e)?e?.includes(t):e===t,Mt=(e,t)=>Array.isArray(t)?t.some((t=>e.has(t))):e.has(t),qt=(e,t,n)=>{e.has(t)?e.get(t)?.push(n):e.set(t,[n])},St=(()=>{let e=0;return()=>e++})();function Bt(){let e=Wi.globalOpt.pixelDensity??1,t=Wi.globalOpt.width,n=Wi.globalOpt.height,s=Wi.gfx.ggl.gl.drawingBufferWidth/e,r=Wi.gfx.ggl.gl.drawingBufferHeight/e,i=0,a=0,o=s,l=r;if(Wi.globalOpt.letterbox){if(!t||!n)throw new Error("Letterboxing requires width and height defined.");let e=t/n;if(s/r>e){let t=r*e;i=(s-t)/2,o=t}else{let t=s/e;l=t,a=(r-t)/2}}if(Wi.globalOpt.stretch&&(!Wi.globalOpt.width||!Wi.globalOpt.height))throw new Error("Stretching requires width and height defined.");Wi.gfx.viewport={x:i,y:a,width:o,height:l,scale:(Wi.gfx.viewport.width+Wi.gfx.viewport.height)/(Wi.gfx.width+Wi.gfx.height)}}var Rt,It=()=>Rt.lastInputDevice,kt=class{pressed=new Set([]);pressedRepeat=new Set([]);released=new Set([]);down=new Set([]);update(){this.pressed.clear(),this.released.clear(),this.pressedRepeat.clear()}press(e){this.pressed.add(e),this.pressedRepeat.add(e),this.down.add(e)}pressRepeat(e){this.pressedRepeat.add(e)}release(e){this.down.delete(e),this.pressed.delete(e),this.released.add(e)}},Pt=class{buttonState=new kt;stickState=new Map},Ct=class{dts=[];timer=0;fps=0;tick(e){this.dts.push(e),this.timer+=e,this.timer>=1&&(this.timer=0,this.fps=Math.round(1/(this.dts.reduce(((e,t)=>e+t))/this.dts.length)),this.dts=[])}},Ft={"Joy-Con L+R (STANDARD GAMEPAD Vendor: 057e Product: 200e)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},"Joy-Con (L) (STANDARD GAMEPAD Vendor: 057e Product: 2006)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"select",10:"lstick",16:"start"},sticks:{left:{x:0,y:1}}},"Joy-Con (R) (STANDARD GAMEPAD Vendor: 057e Product: 2007)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",9:"start",10:"lstick",16:"select"},sticks:{left:{x:0,y:1}}},"Pro Controller (STANDARD GAMEPAD Vendor: 057e Product: 2009)":{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home",17:"capture"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}},default:{buttons:{0:"south",1:"east",2:"west",3:"north",4:"lshoulder",5:"rshoulder",6:"ltrigger",7:"rtrigger",8:"select",9:"start",10:"lstick",11:"rstick",12:"dpad-up",13:"dpad-down",14:"dpad-left",15:"dpad-right",16:"home"},sticks:{left:{x:0,y:1},right:{x:2,y:3}}}},Tt=e=>{if(!e.canvas)throw new Error("Please provide a canvas");let t=(e=>{let t=e.buttons??{};return{canvas:e.canvas,buttons:t,buttonsByKey:new Map,buttonsByMouse:new Map,buttonsByGamepad:new Map,buttonsByKeyCode:new Map,loopID:null,stopped:!1,dt:0,fixedDt:.02,restDt:0,time:0,realTime:0,fpsCounter:new Ct,timeScale:1,skipTime:!1,isHidden:!1,numFrames:0,mousePos:new g(0),mouseDeltaPos:new g(0),keyState:new kt,mouseState:new kt,mergedGamepadState:new Pt,gamepadStates:new Map,lastInputDevice:null,buttonState:new kt,gamepads:[],charInputted:[],isMouseMoved:!1,lastWidth:e.canvas.offsetWidth,lastHeight:e.canvas.offsetHeight,events:new $e}})(e);function n(){return t.dt*t.timeScale}function s(){return document.fullscreenElement===t.canvas||document.webkitFullscreenElement===t.canvas}function r(){return t.mousePos.clone()}function i(){return t.mouseDeltaPos.clone()}Rt=t,(()=>{let e=Rt.buttons;for(let t in e){let n=e[t].keyboard&&[e[t].keyboard].flat(),s=e[t].keyboardCode&&[e[t].keyboardCode].flat(),r=e[t].gamepad&&[e[t].gamepad].flat(),i=e[t].mouse&&[e[t].mouse].flat();n&&n.forEach((e=>{qt(Rt.buttonsByKey,e,t)})),s&&s.forEach((e=>{qt(Rt.buttonsByKeyCode,e,t)})),r&&r.forEach((e=>{qt(Rt.buttonsByGamepad,e,t)})),i&&i.forEach((e=>{qt(Rt.buttonsByMouse,e,t)}))}})();let a=ft((e=>t.events.on("keyDown",e)),((e,n)=>t.events.on("keyDown",(t=>Et(e,t)&&n(t))))),o=ft((e=>t.events.on("keyPress",(t=>e(t)))),((e,n)=>t.events.on("keyPress",(t=>Et(e,t)&&n(t))))),l=ft((e=>t.events.on("keyPressRepeat",e)),((e,n)=>t.events.on("keyPressRepeat",(t=>Et(e,t)&&n(t))))),h=ft((e=>t.events.on("keyRelease",e)),((e,n)=>t.events.on("keyRelease",(t=>Et(e,t)&&n(t))))),u=ft((e=>t.events.on("mouseDown",(t=>e(t)))),((e,n)=>t.events.on("mouseDown",(t=>Et(e,t)&&n(t))))),d=ft((e=>t.events.on("mousePress",(t=>e(t)))),((e,n)=>t.events.on("mousePress",(t=>Et(e,t)&&n(t))))),c=ft((e=>t.events.on("mouseRelease",(t=>e(t)))),((e,n)=>t.events.on("mouseRelease",(t=>t===e&&n(t)))));let p=ft((e=>t.events.on("gamepadButtonPress",((t,n)=>e(t,n)))),((e,n)=>t.events.on("gamepadButtonPress",((t,s)=>Et(e,t)&&n(t,s))))),w=ft((e=>t.events.on("gamepadButtonDown",((t,n)=>e(t,n)))),((e,n)=>t.events.on("gamepadButtonDown",((t,s)=>Et(e,t)&&n(t,s))))),y=ft((e=>t.events.on("gamepadButtonRelease",((t,n)=>e(t,n)))),((e,n)=>t.events.on("gamepadButtonRelease",((t,s)=>Et(e,t)&&n(t,s)))));function A(){return[...t.gamepads]}let x=ft((e=>t.events.on("buttonPress",(t=>e(t)))),((e,n)=>t.events.on("buttonPress",(t=>Et(e,t)&&n(t))))),v=ft((e=>t.events.on("buttonDown",(t=>e(t)))),((e,n)=>t.events.on("buttonDown",(t=>Et(e,t)&&n(t))))),b=ft((e=>t.events.on("buttonRelease",(t=>e(t)))),((e,n)=>t.events.on("buttonRelease",(t=>Et(e,t)&&n(t)))));function E(){t.events.trigger("input"),t.keyState.down.forEach((e=>t.events.trigger("keyDown",e))),t.mouseState.down.forEach((e=>t.events.trigger("mouseDown",e))),t.buttonState.down.forEach((e=>{t.events.trigger("buttonDown",e)})),function(){for(let e of navigator.getGamepads())e&&!t.gamepadStates.has(e.index)&&q(e);for(let n of t.gamepads){let s=navigator.getGamepads()[n.index];if(!s)continue;let r=(e.gamepads??{})[s.id]||Ft[s.id]||Ft.default,i=t.gamepadStates.get(n.index);if(i){for(let e=0;e<s.buttons.length;e++){let a=r.buttons[e],o=s.buttons[e],l=t.buttonsByGamepad.has(a);if(o.pressed){if(i.buttonState.down.has(a)){t.events.trigger("gamepadButtonDown",a,n);continue}t.lastInputDevice="gamepad",l&&t.buttonsByGamepad.get(a)?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.mergedGamepadState.buttonState.press(a),i.buttonState.press(a),t.events.trigger("gamepadButtonPress",a,n)}else i.buttonState.down.has(a)&&(l&&t.buttonsByGamepad.get(a)?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.mergedGamepadState.buttonState.release(a),i.buttonState.release(a),t.events.trigger("gamepadButtonRelease",a,n))}for(let e in r.sticks){let a=r.sticks[e];if(!a)continue;let o=new g(s.axes[a.x],s.axes[a.y]);i.stickState.set(e,o),t.mergedGamepadState.stickState.set(e,o),t.events.trigger("gamepadStick",e,o,n)}}}}()}function M(){t.keyState.update(),t.mouseState.update(),t.buttonState.update(),t.mergedGamepadState.buttonState.update(),t.mergedGamepadState.stickState.forEach(((e,n)=>{t.mergedGamepadState.stickState.set(n,new g(0))})),t.charInputted=[],t.isMouseMoved=!1,t.mouseDeltaPos=new g(0),t.gamepadStates.forEach((e=>{e.buttonState.update(),e.stickState.forEach(((t,n)=>{e.stickState.set(n,new g(0))}))}))}function q(e){let n={index:e.index,isPressed:n=>t.gamepadStates.get(e.index)?.buttonState.pressed.has(n)||!1,isDown:n=>t.gamepadStates.get(e.index)?.buttonState.down.has(n)||!1,isReleased:n=>t.gamepadStates.get(e.index)?.buttonState.released.has(n)||!1,getStick:n=>t.gamepadStates.get(e.index)?.stickState.get(n)||m()};return t.gamepads.push(n),t.gamepadStates.set(e.index,{buttonState:new kt,stickState:new Map([["left",new g(0)],["right",new g(0)]])}),n}let S={},B={},R={},I=e.pixelDensity||1;S.mousemove=e=>{let n=function(e){return new g((e.x-Wi.gfx.viewport.x)*Wi.gfx.width/Wi.gfx.viewport.width,(e.y-Wi.gfx.viewport.y)*Wi.gfx.height/Wi.gfx.viewport.height)}(new g(e.offsetX,e.offsetY)),r=new g(e.movementX,e.movementY);if(s()){let s=t.canvas.width/I,r=t.canvas.height/I,i=window.innerWidth,a=window.innerHeight;if(i/a>s/r){let t=a/r,o=(i-s*t)/2;n.x=f(e.offsetX-o,0,s*t,0,s),n.y=f(e.offsetY,0,r*t,0,r)}else{let t=i/s,o=(a-r*t)/2;n.x=f(e.offsetX,0,s*t,0,s),n.y=f(e.offsetY-o,0,r*t,0,r)}}t.events.onOnce("input",(()=>{t.isMouseMoved=!0,t.mousePos=n,t.mouseDeltaPos=r,t.events.trigger("mouseMove")}))};let k=["left","middle","right","back","forward"];S.mousedown=e=>{t.events.onOnce("input",(()=>{let n=k[e.button];n&&(t.lastInputDevice="mouse",t.buttonsByMouse.has(n)&&t.buttonsByMouse.get(n)?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.mouseState.press(n),t.events.trigger("mousePress",n))}))},S.mouseup=e=>{t.events.onOnce("input",(()=>{let n=k[e.button];n&&(t.buttonsByMouse.has(n)&&t.buttonsByMouse.get(n)?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.mouseState.release(n),t.events.trigger("mouseRelease",n))}))};let P=new Set([" ","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab"]),C={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"};S.keydown=e=>{P.has(e.key)&&e.preventDefault(),t.events.onOnce("input",(()=>{let n=C[e.key]||e.key.toLowerCase(),s=e.code;if(void 0===n)throw new Error(`Unknown key: ${e.key}`);1===n.length?(t.events.trigger("charInput",n),t.charInputted.push(n)):"space"===n&&(t.events.trigger("charInput"," "),t.charInputted.push(" ")),e.repeat?(t.keyState.pressRepeat(n),t.events.trigger("keyPressRepeat",n)):(t.lastInputDevice="keyboard",t.buttonsByKey.has(n)&&t.buttonsByKey.get(n)?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.buttonsByKeyCode.has(s)&&t.buttonsByKeyCode.get(s)?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.keyState.press(n),t.events.trigger("keyPressRepeat",n),t.events.trigger("keyPress",n))}))},S.keyup=e=>{t.events.onOnce("input",(()=>{let n=C[e.key]||e.key.toLowerCase(),s=e.code;t.buttonsByKey.has(n)&&t.buttonsByKey.get(n)?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.buttonsByKeyCode.has(s)&&t.buttonsByKeyCode.get(s)?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.keyState.release(n),t.events.trigger("keyRelease",n)}))},S.touchstart=n=>{n.preventDefault(),t.events.onOnce("input",(()=>{let s=[...n.changedTouches],r=t.canvas.getBoundingClientRect();!1!==e.touchToMouse&&(t.mousePos=new g(s[0].clientX-r.x,s[0].clientY-r.y),t.lastInputDevice="mouse",t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach((e=>{t.buttonState.press(e),t.events.trigger("buttonPress",e)})),t.mouseState.press("left"),t.events.trigger("mousePress","left")),s.forEach((e=>{t.events.trigger("touchStart",new g(e.clientX-r.x,e.clientY-r.y),e)}))}))},S.touchmove=n=>{n.preventDefault(),t.events.onOnce("input",(()=>{let s=[...n.changedTouches],r=t.canvas.getBoundingClientRect();if(!1!==e.touchToMouse){let e=t.mousePos;t.mousePos=new g(s[0].clientX-r.x,s[0].clientY-r.y),t.mouseDeltaPos=t.mousePos.sub(e),t.events.trigger("mouseMove")}s.forEach((e=>{t.events.trigger("touchMove",new g(e.clientX-r.x,e.clientY-r.y),e)}))}))},S.touchend=n=>{t.events.onOnce("input",(()=>{let s=[...n.changedTouches],r=t.canvas.getBoundingClientRect();!1!==e.touchToMouse&&(t.mousePos=new g(s[0].clientX-r.x,s[0].clientY-r.y),t.mouseDeltaPos=new g(0,0),t.buttonsByMouse.has("left")&&t.buttonsByMouse.get("left")?.forEach((e=>{t.buttonState.release(e),t.events.trigger("buttonRelease",e)})),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),s.forEach((e=>{t.events.trigger("touchEnd",new g(e.clientX-r.x,e.clientY-r.y),e)}))}))},S.touchcancel=n=>{t.events.onOnce("input",(()=>{let s=[...n.changedTouches],r=t.canvas.getBoundingClientRect();!1!==e.touchToMouse&&(t.mousePos=new g(s[0].clientX-r.x,s[0].clientY-r.y),t.mouseState.release("left"),t.events.trigger("mouseRelease","left")),s.forEach((e=>{t.events.trigger("touchEnd",new g(e.clientX-r.x,e.clientY-r.y),e)}))}))},S.wheel=e=>{e.preventDefault(),t.events.onOnce("input",(()=>{t.events.trigger("scroll",new g(e.deltaX,e.deltaY))}))},S.contextmenu=e=>e.preventDefault(),B.visibilitychange=()=>{"visible"===document.visibilityState?(t.skipTime=!0,t.isHidden=!1,t.events.trigger("show")):(t.isHidden=!0,t.events.trigger("hide"))},R.gamepadconnected=e=>{let n=q(e.gamepad);t.events.onOnce("input",(()=>{t.events.trigger("gamepadConnect",n)}))},R.gamepaddisconnected=e=>{let n=A().filter((t=>t.index===e.gamepad.index))[0];(function(e){t.gamepads=t.gamepads.filter((t=>t.index!==e.index)),t.gamepadStates.delete(e.index)})(e.gamepad),t.events.onOnce("input",(()=>{t.events.trigger("gamepadDisconnect",n)}))};for(let[e,n]of Object.entries(S))t.canvas.addEventListener(e,n);for(let[e,t]of Object.entries(B))document.addEventListener(e,t);for(let[e,t]of Object.entries(R))window.addEventListener(e,t);let F=new ResizeObserver((e=>{for(let n of e)if(n.target===t.canvas){if(t.lastWidth===t.canvas.offsetWidth&&t.lastHeight===t.canvas.offsetHeight)return;t.lastWidth=t.canvas.offsetWidth,t.lastHeight=t.canvas.offsetHeight,t.events.onOnce("input",(()=>{t.events.trigger("resize")}))}}));return F.observe(t.canvas),{state:t,dt:n,fixedDt:function(){return t.fixedDt*t.timeScale},restDt:function(){return t.restDt*t.timeScale},time:function(){return t.time},run:function(s,r){null!==t.loopID&&cancelAnimationFrame(t.loopID);let i=0,a=0,o=l=>{if(t.stopped)return;if("visible"!==document.visibilityState)return void(t.loopID=requestAnimationFrame(o));let h=l/1e3,u=Math.min(h-t.realTime,.25),d=e.maxFPS?1/e.maxFPS:0;if(t.realTime=h,a+=u,a>d){if(!t.skipTime){for(i+=a,t.dt=t.fixedDt,t.restDt=0;i>t.fixedDt;)i-=t.fixedDt,i<t.fixedDt&&(t.restDt=i),s();t.restDt=i,t.dt=a,t.time+=n(),t.fpsCounter.tick(t.dt)}a=0,t.skipTime=!1,t.numFrames++,r(E,M)}t.loopID=requestAnimationFrame(o)};o(0)},canvas:t.canvas,fps:function(){return t.fpsCounter.fps},numFrames:function(){return t.numFrames},quit:function(){t.stopped=!0;let e=Object.entries(S),n=Object.entries(B),s=Object.entries(R);for(let[n,s]of e)t.canvas.removeEventListener(n,s);for(let[e,t]of n)document.removeEventListener(e,t);for(let[e,t]of s)window.removeEventListener(e,t);F.disconnect()},isHidden:function(){return t.isHidden},setFullscreen:function(e=!0){e?function(e){e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}(t.canvas):document.exitFullscreen?document.exitFullscreen():document.webkitExitFullScreen&&document.webkitExitFullScreen()},isFullscreen:s,setCursor:function(e){t.canvas.style.cursor=e},screenshot:function(){return t.canvas.toDataURL()},getGamepads:A,getCursor:function(){return t.canvas.style.cursor},setCursorLocked:function(e){if(e)try{let e=t.canvas.requestPointerLock();e?.catch&&e.catch((e=>{}))}catch(e){}else document.exitPointerLock()},isCursorLocked:function(){return!!document.pointerLockElement},isTouchscreen:function(){return"ontouchstart"in window||navigator.maxTouchPoints>0},mousePos:r,mouseDeltaPos:i,isKeyDown:function(e){return void 0===e?t.keyState.down.size>0:Mt(t.keyState.down,e)},isKeyPressed:function(e){return void 0===e?t.keyState.pressed.size>0:Mt(t.keyState.pressed,e)},isKeyPressedRepeat:function(e){return void 0===e?t.keyState.pressedRepeat.size>0:Mt(t.keyState.pressedRepeat,e)},isKeyReleased:function(e){return void 0===e?t.keyState.released.size>0:Mt(t.keyState.released,e)},isMouseDown:function(e="left"){return t.mouseState.down.has(e)},isMousePressed:function(e="left"){return t.mouseState.pressed.has(e)},isMouseReleased:function(e="left"){return t.mouseState.released.has(e)},isMouseMoved:function(){return t.isMouseMoved},isGamepadButtonPressed:function(e){return void 0===e?t.mergedGamepadState.buttonState.pressed.size>0:Mt(t.mergedGamepadState.buttonState.pressed,e)},isGamepadButtonDown:function(e){return void 0===e?t.mergedGamepadState.buttonState.down.size>0:Mt(t.mergedGamepadState.buttonState.down,e)},isGamepadButtonReleased:function(e){return void 0===e?t.mergedGamepadState.buttonState.released.size>0:Mt(t.mergedGamepadState.buttonState.released,e)},getGamepadStick:function(e){return t.mergedGamepadState.stickState.get(e)||new g(0)},isButtonPressed:function(e){return void 0===e?t.buttonState.pressed.size>0:Mt(t.buttonState.pressed,e)},isButtonDown:function(e){return void 0===e?t.buttonState.down.size>0:Mt(t.buttonState.down,e)},isButtonReleased:function(e){return void 0===e?t.buttonState.released.size>0:Mt(t.buttonState.released,e)},setButton:function(e,n){t.buttons[e]={...t.buttons[e],...n}},getButton:function(e){return t.buttons?.[e]},pressButton:function(e){t.buttonState.press(e),t.events.trigger("buttonPress",e)},releaseButton:function(e){t.buttonState.release(e),t.events.trigger("buttonRelease",e)},charInputted:function(){return[...t.charInputted]},onResize:function(e){return t.events.on("resize",e)},onKeyDown:a,onKeyPress:o,onKeyPressRepeat:l,onKeyRelease:h,onMouseDown:u,onMousePress:d,onMouseRelease:c,onMouseMove:function(e){return t.events.on("mouseMove",(()=>e(r(),i())))},onCharInput:function(e){return t.events.on("charInput",e)},onTouchStart:function(e){return t.events.on("touchStart",e)},onTouchMove:function(e){return t.events.on("touchMove",e)},onTouchEnd:function(e){return t.events.on("touchEnd",e)},onScroll:function(e){return t.events.on("scroll",e)},onHide:function(e){return t.events.on("hide",e)},onShow:function(e){return t.events.on("show",e)},onGamepadButtonDown:w,onGamepadButtonPress:p,onGamepadButtonRelease:y,onGamepadStick:function(e,n){return t.events.on("gamepadStick",((t,s,r)=>t===e&&n(s,r)))},onGamepadConnect:function(e){t.events.on("gamepadConnect",e)},onGamepadDisconnect:function(e){t.events.on("gamepadDisconnect",e)},onButtonPress:x,onButtonDown:v,onButtonRelease:b,getLastInputDeviceType:It,events:t.events}};function Dt(){return Wi.app.dt()}function Ot(){return Wi.app.fixedDt()}function Ut(){return Wi.app.restDt()}var Lt=new g(-1,-1),Nt=new g(0,-1),Ht=new g(1,-1),jt=new g(-1,0),Gt=new g(0,0),Vt=new g(1,0),Kt=new g(-1,1),Yt=new g(0,1),Xt=new g(1,1);function Qt(e){switch(e){case"topleft":return Lt;case"top":return Nt;case"topright":return Ht;case"left":return jt;case"center":return Gt;case"right":return Vt;case"botleft":return Kt;case"bot":return Yt;case"botright":return Xt;default:return e}}function Wt(e){switch(e){case"left":return 0;case"center":return.5;case"right":return 1;default:return 0}}var zt=2.5949095,Zt=2.70158,Jt=2*Math.PI/3,_t=2*Math.PI/4.5,$t={linear:e=>e,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInQuad:e=>e*e,easeOutQuad:e=>1-(1-e)*(1-e),easeInOutQuad:e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,easeInCubic:e=>e*e*e,easeOutCubic:e=>1-Math.pow(1-e,3),easeInOutCubic:e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,easeInQuart:e=>e*e*e*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutQuart:e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,easeInQuint:e=>e*e*e*e*e,easeOutQuint:e=>1-Math.pow(1-e,5),easeInOutQuint:e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2,easeInExpo:e=>0===e?0:Math.pow(2,10*e-10),easeOutExpo:e=>1===e?1:1-Math.pow(2,-10*e),easeInOutExpo:e=>0===e?0:1===e?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2,easeInCirc:e=>1-Math.sqrt(1-Math.pow(e,2)),easeOutCirc:e=>Math.sqrt(1-Math.pow(e-1,2)),easeInOutCirc:e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,easeInBack:e=>Zt*e*e*e-1.70158*e*e,easeOutBack:e=>1+Zt*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeInOutBack:e=>e<.5?Math.pow(2*e,2)*(7.189819*e-zt)/2:(Math.pow(2*e-2,2)*((zt+1)*(2*e-2)+zt)+2)/2,easeInElastic:e=>0===e?0:1===e?1:-Math.pow(2,10*e-10)*Math.sin((10*e-10.75)*Jt),easeOutElastic:e=>0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin((10*e-.75)*Jt)+1,easeInOutElastic:e=>0===e?0:1===e?1:e<.5?-Math.pow(2,20*e-10)*Math.sin((20*e-11.125)*_t)/2:Math.pow(2,-20*e+10)*Math.sin((20*e-11.125)*_t)/2+1,easeInBounce:e=>1-$t.easeOutBounce(1-e),easeOutBounce:e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,easeInOutBounce:e=>e<.5?(1-$t.easeOutBounce(1-2*e))/2:(1+$t.easeOutBounce(2*e-1))/2},en=$t;var tn=class{_polygons;_pointCache;_edgeCache;constructor(){this._polygons=[],this._pointCache={},this._edgeCache={}}_addPoint(e){let t=this._pointCache[`${e.x}_${e.y}`];return t||(t=e.clone(),this._pointCache[`${e.x}_${e.y}`]=t,t)}_addEdge(e){let t=`${e.a.x}_${e.a.y}-${e.b.x}_${e.b.y}`;return this._edgeCache[t]=e,e}_findEdge(e,t){let n=`${e.x}_${e.y}-${t.x}_${t.y}`;return this._edgeCache[n]}_findCommonEdge(e,t){for(let n of e.edges){let e=this._findEdge(n.b,n.a);if(e&&e.polygon.deref().id===t.id)return e}return null}addPolygon(e){let t=new class{_edges;_centroid;_id;constructor(e){this._id=e}get id(){return this._id}set edges(e){this._edges=e;let t=0,n=0,s=0;for(let e of this._edges){e.polygon=new WeakRef(this);let r=e.a.x*e.b.y-e.a.y*e.b.x;t+=(e.a.x+e.b.x)*r,n+=(e.a.y+e.b.y)*r,s+=r}s/=2,this._centroid=m(t/(6*s),n/(6*s))}get edges(){return this._edges}get centroid(){return this._centroid}contains(e){let t=!1;for(let n of this.edges)n.b.y>e.y!=n.a.y>e.y&&e.x<(n.a.x-n.b.x)*(e.y-n.b.y)/(n.a.y-n.b.y)+n.b.x&&(t=!t);return t}}(this._polygons.length),n=e.map(((n,s)=>new class{a;b;polygon;constructor(e,t,n){this.a=e,this.b=t,this.polygon=new WeakRef(n)}isLeft(e,t){return(this.b.x-this.a.x)*(t-this.a.y)-(e-this.a.x)*(this.b.y-this.a.y)}get middle(){return this.a.add(this.b).scale(.5)}}(n,e[(s+1)%e.length],t)));t.edges=n,this._polygons.push(t);for(let e of t.edges)this._addEdge(e);return t}addRect(e,t){let n=this._addPoint(e),s=this._addPoint(e.add(t.x,0)),r=this._addPoint(e.add(t)),i=this._addPoint(e.add(0,t.y));return this.addPolygon([n,s,r,i])}_getLocation(e){for(let t of this._polygons)if(t.contains(e))return t;return null}getNeighbours(e){let t=[];for(let n of this._polygons[e].edges){let e=this._findEdge(n.b,n.a);if(e){let n=e.polygon.deref();n&&t.push(n.id)}}return t}getCost(e,t){return 1}getHeuristic(e,t){let n=this._polygons[e],s=this._polygons[t],r=n.centroid.x-s.centroid.x,i=n.centroid.y-s.centroid.y;return Math.sqrt(r*r+i*i)}getPath(e,t){return void 0===e||void 0===t?[]:e===t?[e,t]:function(e,t,n){let s=new nt(((e,t)=>e.cost<t.cost));s.insert({cost:0,node:t});let r=new Map;r.set(t,t);let i=new Map;for(i.set(t,0);0!==s.length;){let t=s.remove()?.node;if(t===n)break;let a=e.getNeighbours(t);for(let o of a){let a=(i.get(t)||0)+e.getCost(t,o)+e.getHeuristic(o,n);(!i.has(o)||a<i.get(o))&&(i.set(o,a),s.insert({cost:a,node:o}),r.set(o,t))}}return function(e,t,n){let s=[],r=t;for(s.push(r);r!==e;){if(r=n.get(r),null==r)return null;s.push(r)}return s.reverse()}(t,n,r)}(this,e,t)}getWaypointPath(e,t,n){let s=n?.type||"centroids",r=this._getLocation(e),i=this._getLocation(t);if(void 0===r||void 0===i)return[];let a=this.getPath(r.id,i.id);if(!a)return[];if("edges"===s){let n=[];for(let e=1;e<a.length;e++){let t=this._polygons[a[e-1]],s=this._polygons[a[e]],r=this._findCommonEdge(t,s);n.push(r.middle.add(s.centroid.sub(r.middle).unit().scale(4)))}return[e,...n,t]}return[e,...a.slice(1,-1).map((e=>this._polygons[e].centroid)),t]}};function nn(e){let t=new v;return e.pos&&t.translate(e.pos),e.scale&&t.scale(e.scale),e.angle&&t.rotate(e.angle),e.parent?t.mult(e.parent.transform):t}function sn(e){return new g(e.x/gn()*2-1,-e.y/mn()*2+1)}function rn(e,t,n,s,r,i=1){s=u(s%360),(r=u(r%360))<=s&&(r+=2*Math.PI);let a=[],o=Math.ceil((r-s)/u(8)*i),l=(r-s)/o,h=m(Math.cos(s),Math.sin(s)),d=m(Math.cos(l),Math.sin(l));for(let s=0;s<=o;s++)a.push(e.add(t*h.x,n*h.y)),h=m(h.x*d.x-h.y*d.y,h.x*d.y+h.y*d.x);return a}function an(...e){let t=l(...e),n=e[3]??1;Wi.gfx.bgColor=t,Wi.gfx.bgAlpha=n,Wi.gfx.ggl.gl.clearColor(t.r/255,t.g/255,t.b/255,n)}function on(){return Wi.gfx.bgColor?.clone?.()??null}function ln(...e){if(void 0===e[0])return;let t=m(...e);0===t.x&&0===t.y||Wi.gfx.transform.translate(t)}function hn(){Wi.gfx.transformStack.push(Wi.gfx.transform.clone())}function un(e){Wi.gfx.transform=e.clone()}function dn(...e){if(void 0===e[0])return;let t=m(...e);1===t.x&&1===t.y||Wi.gfx.transform.scale(t)}function cn(e){e&&Wi.gfx.transform.rotate(e)}function fn(){Wi.gfx.transformStack.length>0&&(Wi.gfx.transform=Wi.gfx.transformStack.pop())}function pn(){Wi.gfx.renderer.flush()}function gn(){return Wi.gfx.width}function mn(){return Wi.gfx.height}function wn(){return(Wi.gfx.viewport.width+Wi.gfx.viewport.height)/(Wi.gfx.width+Wi.gfx.height)}function yn(){return m(gn()/2,mn()/2)}var An=class{lastTextureId=0;textures=[];bigTextures=[];texturesPosition=new Map;canvas;c2d;x=0;y=0;curHeight=0;gfx;padding;constructor(e,t,n,s){this.gfx=e,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=n,this.textures=[us.fromImage(e,this.canvas)],this.bigTextures=[],this.padding=s;let r=this.canvas.getContext("2d");if(!r)throw new Error("Failed to get 2d context");this.c2d=r}add_single(e){let t=us.fromImage(this.gfx,e);return this.bigTextures.push(t),[t,new w(0,0,1,1),0]}add(e){let t=e.width+2*this.padding,n=e.height+2*this.padding;(t>this.canvas.width||n>this.canvas.height)&&this.add_single(e),this.x+t>this.canvas.width&&(this.x=0,this.y+=this.curHeight,this.curHeight=0),this.y+n>this.canvas.height&&(this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.textures.push(us.fromImage(this.gfx,this.canvas)),this.x=0,this.y=0,this.curHeight=0);let s=this.textures[this.textures.length-1],r=new g(this.x+this.padding,this.y+this.padding);return this.x+=t,n>this.curHeight&&(this.curHeight=n),e instanceof ImageData?this.c2d.putImageData(e,r.x,r.y):this.c2d.drawImage(e,r.x,r.y),s.update(this.canvas),this.texturesPosition.set(this.lastTextureId,{position:r,size:new g(e.width,e.height),texture:s}),this.lastTextureId++,[s,new w(r.x/this.canvas.width,r.y/this.canvas.height,e.width/this.canvas.width,e.height/this.canvas.height),this.lastTextureId-1]}free(){for(let e of this.textures)e.free();for(let e of this.bigTextures)e.free()}};function xn(e){return"string"!=typeof e||lt(e)?e:Wi.assets.urlPrefix+e}var vn=class e{loaded=!1;data=null;error=null;onLoadEvents=new _e;onErrorEvents=new _e;onFinishEvents=new _e;constructor(e){e.then((e=>{this.loaded=!0,this.data=e,this.onLoadEvents.trigger(e)})).catch((e=>{if(this.error=e,!(this.onErrorEvents.numListeners()>0))throw e;this.onErrorEvents.trigger(e)})).finally((()=>{this.onFinishEvents.trigger(),this.loaded=!0}))}static loaded(t){let n=new e(Promise.resolve(t));return n.data=t,n.loaded=!0,n}onLoad(e){return this.loaded&&this.data?e(this.data):this.onLoadEvents.add(e),this}onError(e){return this.loaded&&this.error?e(this.error):this.onErrorEvents.add(e),this}onFinish(e){return this.loaded?e():this.onFinishEvents.add(e),this}then(e){return this.onLoad(e)}catch(e){return this.onError(e)}finally(e){return this.onFinish(e)}},bn=class{assets=new Map;lastUID=0;add(e,t){let n=e??this.lastUID+++"",s=new vn(t);return this.assets.set(n,s),s}addLoaded(e,t){let n=e??this.lastUID+++"",s=vn.loaded(t);return this.assets.set(n,s),s}get(e){return this.assets.get(e)}progress(){if(0===this.assets.size)return 1;let e=0;return this.assets.forEach((t=>{t.loaded&&e++})),e/this.assets.size}getFailedAssets(){return Array.from(this.assets.keys()).filter((e=>null!==this.assets.get(e).error)).map((e=>[e,this.assets.get(e)]))}};function En(e){return fetch(e).then((t=>{if(!t.ok)throw new Error(`Failed to fetch "${e}"`);return t}))}function Mn(e){return En(e).then((e=>e.json()))}function qn(e){return void 0!==e&&(Wi.assets.urlPrefix=e),Wi.assets.urlPrefix}function Sn(e,t){return Wi.assets.custom.add(e,Mn(xn(t)))}function Bn(e){let t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise(((n,s)=>{t.onload=()=>n(t),t.onerror=()=>s(new Error(`Failed to load image from "${e}"`))}))}function Rn(){let e=[Wi.assets.sprites,Wi.assets.sounds,Wi.assets.shaders,Wi.assets.fonts,Wi.assets.bitmapFonts,Wi.assets.custom];return e.reduce(((e,t)=>e+t.progress()),0)/e.length}function In(){return[Wi.assets.sprites,Wi.assets.sounds,Wi.assets.shaders,Wi.assets.fonts,Wi.assets.bitmapFonts,Wi.assets.custom].reduce(((e,t)=>e.concat(t.getFailedAssets())),[])}function kn(e){return Wi.assets.custom.get(e)??null}function Pn(e){return Wi.assets.custom.add(null,e)}var Cn=class e{tex;frames=[new w(0,0,1,1)];anims={};slice9=null;constructor(e,t,n={},s=null){this.tex=e,t&&(this.frames=t),this.anims=n,this.slice9=s}get width(){return this.tex.width*this.frames[0].w}get height(){return this.tex.height*this.frames[0].h}static from(t,n={}){return"string"==typeof t?e.fromURL(t,n):Promise.resolve(e.fromImage(t,n))}static fromImage(t,n={}){let[s,r]=n.singular?Wi.assets.packer.add_single(t):Wi.assets.packer.add(t),i=n.frames?n.frames.map((e=>new w(r.x+e.x*r.w,r.y+e.y*r.h,e.w*r.w,e.h*r.h))):On(n.sliceX||1,n.sliceY||1,r.x,r.y,r.w,r.h);return new e(s,i,n.anims,n.slice9)}static fromURL(t,n={}){return Bn(t).then((t=>e.fromImage(t,n)))}};function Fn(e){if("string"==typeof e){let t=Tn(e);if(t)return t;if(Rn()<1)return null;throw new Error(`Sprite not found: ${e}`)}if(e instanceof Cn)return vn.loaded(e);if(e instanceof vn)return e;throw new Error(`Invalid sprite: ${e}`)}function Tn(e){return Wi.assets.sprites.get(e)??null}function Dn(e,t,n={sliceX:1,sliceY:1,anims:{}}){return t=xn(t),Array.isArray(t)?t.some((e=>"string"==typeof e))?Wi.assets.sprites.add(e,Promise.all(t.map((e=>"string"==typeof e?Bn(e):Promise.resolve(e)))).then((e=>Un(e,n)))):Wi.assets.sprites.addLoaded(e,Un(t,n)):"string"==typeof t?Wi.assets.sprites.add(e,Cn.from(t,n)):Wi.assets.sprites.addLoaded(e,Cn.fromImage(t,n))}function On(e=1,t=1,n=0,s=0,r=1,i=1){let a=[],o=r/e,l=i/t;for(let r=0;r<t;r++)for(let t=0;t<e;t++)a.push(new w(n+t*o,s+r*l,o,l));return a}function Un(e,t={}){let n=document.createElement("canvas"),s=e[0].width,r=e[0].height;n.width=s*e.length,n.height=r;let i=n.getContext("2d");if(!i)throw new Error("Failed to create canvas context");e.forEach(((e,t)=>{e instanceof ImageData?i.putImageData(e,t*s,0):i.drawImage(e,t*s,0)}));let a=i.getImageData(0,0,e.length*s,r);return Cn.fromImage(a,{...t,sliceX:e.length,sliceY:1})}function Ln(e="bean"){return Dn(e,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA1CAYAAADyMeOEAAAAAXNSR0IArs4c6QAAAoVJREFUaIHdm7txwkAQhheGAqACiCHzOKQDQrqgILpwSAeEDBnEUAF0gCMxZ7G72qce/mec2Lpf9+3unaS78wgSNZ8uX5729+d1FNWXUuGmXlBOUUEIMckEpeQJgBu6C+BSFngztBR2vd+ovY+7g+p6LbgaWgJrAeUkDYIUXgXdBBwNi6kpABJwMTQH3AZsXRR8GHTfgEth8E3gjdAUcNewpbTgY85sCMCUuOokozE0YM0YRzM9NGAAXd8+omAF5h4lnmBRvpSnZHyLoLEbaN+aKB9KWv/KWw0tAbbANnlG+UvB2dm77NxxdwgBpjrF/d7rW9cbmpvio2A5z8iAYpVU8pGZlo6/2+MSco2lHfd3rv9jAP038e1xef9o2mjvYb2OqpqKE81028/jeietlSEVO5FRWsxWsJit1G3aFpW8iWe5RwpiCZAk25QvV6nz6fIlynRGuTd5WqpJ4guAlDfVKBK87hXljflgv1ON6fV+4+5gVlA17SfeG0heKqQd4l4jI/wrmaA9N9R4ar+wpHJDZyrrfcH0nB66PqAzPi76pn+faSyJk/vzOorYhGurQrzj/P68jtBMawHaHBIR9xoD5O34dy0qQOSYHvqExq2TpT2nf76+w7y251OYF0CRaU+J920TwLUa6inx6OxE6g80lu2ux7Y2eJLF/rCXE6zEPdnenk9o+4ih9AEdnW2q81HXl5LuU6OTl2fXUhqganbXAGq3g6jJOWV/OnoesO6YqqEB/GdNsjf7uHtwj2DzmRNpp7iOZfm6D9oAxB6Yi1gC4oIYeo4MIPdopEQRB+cAko5J1tW386HpB2Kz1eop4Epdwls/kgZ1sh8gZsEjdcWkr//D8Qu3Z3l5Nl1NtAAAAABJRU5ErkJggg==")}function Nn(e,t,n){t=xn(t),n=xn(n),"string"==typeof t&&!n&&(n=(e=>e.split(".").slice(0,-1).join("."))(t)+".json");let s="string"==typeof n?Mn(n):Promise.resolve(n);return Wi.assets.sprites.add(e,s.then((e=>{let n=e.meta.size,s=e.frames.map((e=>new w(e.frame.x/n.w,e.frame.y/n.h,e.frame.w/n.w,e.frame.h/n.h))),r={};for(let t of e.meta.frameTags)t.from===t.to?r[t.name]=t.from:r[t.name]={from:t.from,to:t.to,speed:10,loop:!0,pingpong:"pingpong"===t.direction};return Cn.from(t,{frames:s,anims:r})})))}var Hn=class{fontface;filter=Ne;outline=null;size=64;constructor(e,t={}){if(this.fontface=e,this.filter=t.filter??Ne,this.size=t.size??64,this.size>256)throw new Error("Max font size: 256");t.outline&&(this.outline={width:1,color:l(0,0,0)},"number"==typeof t.outline?this.outline.width=t.outline:"object"==typeof t.outline&&(t.outline.width&&(this.outline.width=t.outline.width),t.outline.color&&(this.outline.color=t.outline.color)))}};function jn(e){if(!e)return jn(Wi.globalOpt.font??"monospace");if("string"==typeof e){let t=Kn(e),n=Gn(e);if(t)return t.data??t;if(n)return n.data??n;if(document.fonts.check(`64px ${e}`))return e;if(Rn()<1)return null;throw new Error(`Font not found: ${e}`)}return e instanceof vn&&e.data?e.data:e}function Gn(e){return Wi.assets.fonts.get(e)??null}function Vn(e,t,n={}){let s=xn(t),r=new FontFace(e,"string"==typeof t?`url(${s})`:s);return document.fonts.add(r),Wi.assets.fonts.add(e,r.load().catch((e=>{throw new Error(`Failed to load font from "${s}": ${e}`)})).then((e=>new Hn(e,n))))}function Kn(e){return Wi.assets.bitmapFonts.get(e)??null}function Yn(e,t,n,s,r={}){let i=xn(t);return Wi.assets.bitmapFonts.add(e,Bn(i).then((e=>function(e,t,n,s){let r=e.width/t,i={},a=s.split("").entries();for(let[e,s]of a)i[s]=new w(e%r*t,Math.floor(e/r)*n,t,n);return{tex:e,map:i,size:n}}(us.fromImage(Wi.gfx.ggl,e,r),n,s,r.chars??Oe))))}function Xn(e,t){return t=xn(t),Wi.assets.sprites.add(e,new Promise((async e=>{let n="string"==typeof t?await Mn(t):t,s=await Promise.all(n.frames.map(Bn)),r=document.createElement("canvas");r.width=n.width,r.height=n.height*n.frames.length;let i=r.getContext("2d");if(!i)throw new Error("Failed to create canvas context");s.forEach(((e,t)=>{i.drawImage(e,0,t*n.height)})),e(await Dn(null,r,{sliceY:n.frames.length,anims:n.anims}))})))}function Qn(e,t=Ye,n=Xe){let s=Ve.replace("{{user}}",t??Ye),r=Ke.replace("{{user}}",n??Xe);try{return new class{ctx;glProgram;constructor(e,t,n,s){this.ctx=e,e.onDestroy((()=>this.free()));let r=e.gl,i=r.createShader(r.VERTEX_SHADER),a=r.createShader(r.FRAGMENT_SHADER);if(!i||!a)throw new Error("Failed to create shader");r.shaderSource(i,t),r.shaderSource(a,n),r.compileShader(i),r.compileShader(a);let o=r.createProgram();if(this.glProgram=o,r.attachShader(o,i),r.attachShader(o,a),s.forEach(((e,t)=>r.bindAttribLocation(o,t,e))),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS)){let e=r.getShaderInfoLog(i);if(e)throw new Error("VERTEX SHADER "+e);let t=r.getShaderInfoLog(a);if(t)throw new Error("FRAGMENT SHADER "+t)}r.deleteShader(i),r.deleteShader(a)}bind(){this.ctx.pushProgram(this.glProgram)}unbind(){this.ctx.popProgram()}send(e){let t=this.ctx.gl;for(let n in e){let s=e[n],r=t.getUniformLocation(this.glProgram,n);if("number"==typeof s)t.uniform1f(r,s);else if(s instanceof v)t.uniformMatrix4fv(r,!1,new Float32Array(s.m));else if(s instanceof o)t.uniform3f(r,s.r,s.g,s.b);else if(s instanceof g)t.uniform2f(r,s.x,s.y);else{if(!Array.isArray(s))throw new Error("Unsupported uniform data type");s[0],"number"==typeof s[0]?t.uniform1fv(r,s):tt(s)?t.uniform2fv(r,s.map((e=>[e.x,e.y])).flat()):et(s)&&t.uniform3fv(r,s.map((e=>[e.r,e.g,e.b])).flat())}}}free(){this.ctx.gl.deleteProgram(this.glProgram)}}(e,s,r,He.map((e=>e.name)))}catch(e){let t=/(?<type>^\w+) SHADER ERROR: 0:(?<line>\d+): (?<msg>.+)/,n=(e=>e instanceof Error?e.message:String(e))(e).match(t);if(!n?.groups)throw e;let s=Number(n.groups.line)-14,r=n.groups.msg.trim(),i=n.groups.type.toLowerCase();throw new Error(`${i} shader line ${s}: ${r}`)}}function Wn(e){return Wi.assets.shaders.get(e)??null}function zn(e,t,n){return Wi.assets.shaders.addLoaded(e,Qn(Wi.gfx.ggl,t,n))}function Zn(e,t,n){t=xn(t),n=xn(n);let s=e=>e?function(e){return En(e).then((e=>e.text()))}(e):Promise.resolve(null),r=Promise.all([s(t),s(n)]).then((([e,t])=>Qn(Wi.gfx.ggl,e,t)));return Wi.assets.shaders.add(e,r)}var Jn=class e{buf;constructor(e){this.buf=e}static fromArrayBuffer(t){return new Promise(((e,n)=>Wi.audio.ctx.decodeAudioData(t,e,n))).then((t=>new e(t)))}static fromURL(t){return lt(t)?e.fromArrayBuffer(st(t)):function(e){return En(e).then((e=>e.arrayBuffer()))}(t).then((t=>e.fromArrayBuffer(t)))}};function _n(e){return Wi.assets.sounds.get(e)??null}function $n(e,t){return t=xn(t),Wi.assets.sounds.add(e,"string"==typeof t?Jn.fromURL(t):Jn.fromArrayBuffer(t))}function es(e,t){let n=xn(t);return new Audio(n).preload="auto",Wi.assets.music[e]=n}function ts(e,t){return e=xn(e),Pn("string"==typeof t?new Promise(((n,s)=>{Mn(t).then((t=>{ts(e,t).then(n).catch(s)}))})):Cn.from(e).then((e=>{let n={};for(let s in t){let r=t[s],i=e.frames[0],a=2048*i.w,o=2048*i.h,l=r.frames?r.frames.map((e=>new w(i.x+(r.x+e.x)/a*i.w,i.y+(r.y+e.y)/o*i.h,e.w/a*i.w,e.h/o*i.h))):On(r.sliceX||1,r.sliceY||1,i.x+r.x/a*i.w,i.y+r.y/o*i.h,r.width/a*i.w,r.height/o*i.h),h=new Cn(e.tex,l,r.anims);Wi.assets.sprites.addLoaded(s,h),n[s]=h}return n})))}function ns(e,t,n=!1,s,r,i={}){let a=s??Wi.gfx.defTex,o=function(e){if(!e)return Wi.gfx.defShader;if("string"==typeof e){let t=Wn(e);if(t)return t.data??t;if(Rn()<1)return null;throw new Error(`Shader not found: ${e}`)}return e instanceof vn&&e.data?e.data:e}(r??Wi.gfx.defShader);if(!o||o instanceof vn)return;let l=Wi.gfx.fixed||n?Wi.gfx.transform:Wi.game.cam.transform.mult(Wi.gfx.transform),h=[];for(let t of e){let e=sn(l.multVec2(t.pos));h.push(e.x,e.y,t.uv.x,t.uv.y,t.color.r/255,t.color.g/255,t.color.b/255,t.opacity)}Wi.gfx.renderer.push(Wi.gfx.ggl.gl.TRIANGLES,h,t,o,a,i)}function ss(e){if(!e.pts)throw new Error('drawPolygon() requires property "pts".');let t=e.pts.length;if(!(t<3)){if(hn(),ln(e.pos),dn(e.scale),cn(e.angle),ln(e.offset),!1!==e.fill){let n,s=e.color??o.WHITE,r=e.pts.map(((t,n)=>({pos:new g(t.x,t.y),uv:e.uv?e.uv[n]:new g(0,0),color:e.colors&&e.colors[n]?e.colors[n].mult(s):s,opacity:e.opacity??1})));n=e.triangulate?Te(e.pts).map((t=>t.map((t=>e.pts.indexOf(t))))).flat():[...Array(t-2).keys()].map((e=>[0,e+1,e+2])).flat(),ns(r,e.indices??n,e.fixed,e.uv?e.tex:Wi.gfx.defTex,e.shader,e.uniform??void 0)}e.outline&&os({pts:[...e.pts,e.pts[0]],radius:e.radius,width:e.outline.width,color:e.outline.color,join:e.outline.join,uniform:e.uniform,fixed:e.fixed,opacity:e.opacity??e.outline.opacity}),fn()}}function rs(e){if(void 0===e.radiusX||void 0===e.radiusY)throw new Error('drawEllipse() requires properties "radiusX" and "radiusY".');if(0===e.radiusX||0===e.radiusY)return;let t=e.start??0,n=e.end??360,s=Qt(e.anchor??"center").scale(new g(-e.radiusX,-e.radiusY)),r=rn(s,e.radiusX,e.radiusY,t,n,e.resolution);r.unshift(s);let i=Object.assign({},e,{pts:r,radius:0,...e.gradient?{colors:[e.gradient[0],...Array(r.length-1).fill(e.gradient[1])]}:{}});if(n-t>=360&&e.outline)return!1!==e.fill&&ss(Object.assign({},i,{outline:null})),void ss(Object.assign({},i,{pts:r.slice(1),fill:!1}));ss(i)}function is(e){if("number"!=typeof e.radius)throw new Error('drawCircle() requires property "radius".');0!==e.radius&&rs(Object.assign({},e,{radiusX:e.radius,radiusY:e.radius,angle:0}))}function as(e){let{p1:t,p2:n}=e;if(!t||!n)throw new Error('drawLine() requires properties "p1" and "p2".');let s=e.width||1,r=n.sub(t).unit().normal().scale(.5*s);ns([t.sub(r),t.add(r),n.add(r),n.sub(r)].map((t=>({pos:new g(t.x,t.y),uv:new g(0),color:e.color??o.WHITE,opacity:e.opacity??1}))),[0,1,3,1,2,3],e.fixed,Wi.gfx.defTex,e.shader,e.uniform??void 0)}function os(e){let t=e.pts,n=e.width??1;if(!t)throw new Error('drawLines() requires property "pts".');if(!(t.length<2)){if(t.length>2)switch(e.join){case"bevel":return function(e){let t,n=e.pts,s=[],r=.5*(e.width||1),i=n[0]===n[n.length-1]||n[0].eq(n[n.length-1]),a=e.pos||m(0,0);t=i?n[0].sub(n[n.length-2]):n[1].sub(n[0]);let l,h=t.len(),u=t.normal().scale(-r/h),d=n[0];if(!i)switch(e.cap){case"square":{let e=t.scale(-r/h);s.push(d.add(e).add(u)),s.push(d.add(e).sub(u));break}case"round":{let e=Math.max(r,10),t=Math.PI/e,n=u.scale(-1),i=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)s.push(d),s.push(d.sub(n)),n=m(n.x*i-n.y*a,n.x*a+n.y*i)}}for(let e=1;e<n.length;e++){if(d===n[e]||d.eq(n[e]))continue;l=d,d=n[e];let i=d.sub(l),a=i.len(),o=i.normal().scale(-r/a),c=t.cross(i);if(Math.abs(c)/(h*a)<.05){s.push(l.add(u)),s.push(l.sub(u)),t.dot(i)<0&&(s.push(l.sub(u)),s.push(l.add(u))),t=i,h=a,u=o;continue}let f=o.sub(u).cross(i)/c,p=u.add(t.scale(f));c>0?(s.push(l.add(p)),s.push(l.sub(u)),s.push(l.add(p)),s.push(l.sub(o))):(s.push(l.add(u)),s.push(l.sub(p)),s.push(l.add(o)),s.push(l.sub(p))),t=i,h=a,u=o}if(!i)switch(s.push(d.add(u)),s.push(d.sub(u)),e.cap){case"square":{let e=t.scale(r/h);s.push(d.add(e).add(u)),s.push(d.add(e).sub(u));break}case"round":{let e=Math.max(r,10),t=Math.PI/e,n=u.scale(1),i=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)n=m(n.x*i-n.y*a,n.x*a+n.y*i),s.push(d),s.push(d.sub(n))}}if(s.length<4)return;let c=s.map((t=>({pos:a.add(t),uv:m(),color:e.color||o.WHITE,opacity:e.opacity??1}))),f=[],p=0;for(let e=0;e<s.length-2;e+=2)f[p++]=e+1,f[p++]=e,f[p++]=e+2,f[p++]=e+2,f[p++]=e+3,f[p++]=e+1;i&&(f[p++]=s.length-1,f[p++]=s.length-2,f[p++]=0,f[p++]=0,f[p++]=1,f[p++]=s.length-1),ns(c,f,e.fixed,Wi.gfx.defTex,e.shader,e.uniform??void 0)}(e);case"round":return function(e){let t,n=e.pts,s=[],r=.5*(e.width||1),i=n[0]===n[n.length-1]||n[0].eq(n[n.length-1]),a=e.pos||m(0,0);t=i?n[0].sub(n[n.length-2]):n[1].sub(n[0]);let l,h=t.len(),d=t.normal().scale(-r/h),c=n[0];if(!i)switch(e.cap){case"square":{let e=t.scale(-r/h);s.push(c.add(e).add(d)),s.push(c.add(e).sub(d));break}case"round":{let e=Math.max(r,10),t=Math.PI/e,n=d.scale(-1),i=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)s.push(c),s.push(c.sub(n)),n=m(n.x*i-n.y*a,n.x*a+n.y*i)}}for(let e=1;e<n.length;e++){if(c===n[e]||c.eq(n[e]))continue;l=c,c=n[e];let i=c.sub(l),a=i.len(),o=i.normal().scale(-r/a),f=t.cross(i);if(Math.abs(f)/(h*a)<.05){s.push(l.add(d)),s.push(l.sub(d)),t.dot(i)<0&&(s.push(l.sub(d)),s.push(l.add(d))),t=i,h=a,d=o;continue}let p=o.sub(d).cross(i)/f,g=d.add(t.scale(p));if(f>0){let e=l.add(g),t=Math.max(r,10),n=u(d.angleBetween(o)/t),i=d,a=Math.cos(n),h=Math.sin(n);for(let n=0;n<t;n++)s.push(e),s.push(l.sub(i)),i=m(i.x*a-i.y*h,i.x*h+i.y*a)}else{let e=l.sub(g),t=Math.max(r,10),n=u(d.angleBetween(o)/t),i=d,a=Math.cos(n),h=Math.sin(n);for(let n=0;n<t;n++)s.push(l.add(i)),s.push(e),i=m(i.x*a-i.y*h,i.x*h+i.y*a)}t=i,h=a,d=o}if(!i)switch(s.push(c.add(d)),s.push(c.sub(d)),e.cap){case"square":{let e=t.scale(r/h);s.push(c.add(e).add(d)),s.push(c.add(e).sub(d));break}case"round":{let e=Math.max(r,10),t=Math.PI/e,n=d.scale(1),i=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)n=m(n.x*i-n.y*a,n.x*a+n.y*i),s.push(c),s.push(c.sub(n))}}if(s.length<4)return;let f=s.map((t=>({pos:a.add(t),uv:m(),color:e.color||o.WHITE,opacity:e.opacity??1}))),p=[],g=0;for(let e=0;e<s.length-2;e+=2)p[g++]=e+1,p[g++]=e,p[g++]=e+2,p[g++]=e+2,p[g++]=e+3,p[g++]=e+1;i&&(p[g++]=s.length-1,p[g++]=s.length-2,p[g++]=0,p[g++]=0,p[g++]=1,p[g++]=s.length-1),ns(f,p,e.fixed,Wi.gfx.defTex,e.shader,e.uniform??void 0)}(e);case"miter":return function(e){let t,n=e.pts,s=[],r=.5*(e.width||1),i=n[0]===n[n.length-1]||n[0].eq(n[n.length-1]),a=e.pos||m(0,0);t=i?n[0].sub(n[n.length-2]):n[1].sub(n[0]);let l,h=t.len(),u=t.normal().scale(-r/h),d=n[0];if(!i)switch(e.cap){case"square":{let e=t.scale(-r/h);s.push(d.add(e).add(u)),s.push(d.add(e).sub(u));break}case"round":{let e=Math.max(r,10),t=Math.PI/e,n=u.scale(-1),i=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)s.push(d),s.push(d.sub(n)),n=m(n.x*i-n.y*a,n.x*a+n.y*i)}}for(let e=1;e<n.length;e++){if(d===n[e]||d.eq(n[e]))continue;l=d,d=n[e];let i=d.sub(l),a=i.len(),o=i.normal().scale(-r/a),c=t.cross(i);if(Math.abs(c)/(h*a)<.05){s.push(l.add(u)),s.push(l.sub(u)),t.dot(i)<0&&(s.push(l.sub(u)),s.push(l.add(u))),t=i,h=a,u=o;continue}let f=o.sub(u).cross(i)/c,p=u.add(t.scale(f));s.push(l.add(p)),s.push(l.sub(p)),t=i,h=a,u=o}if(!i)switch(s.push(d.add(u)),s.push(d.sub(u)),e.cap){case"square":{let e=t.scale(r/h);s.push(d.add(e).add(u)),s.push(d.add(e).sub(u));break}case"round":{let e=Math.max(r,10),t=Math.PI/e,n=u.scale(1),i=Math.cos(t),a=Math.sin(t);for(let t=0;t<e;t++)n=m(n.x*i-n.y*a,n.x*a+n.y*i),s.push(d),s.push(d.sub(n))}}if(s.length<4)return;let c=s.map((t=>({pos:a.add(t),uv:m(),color:e.color||o.WHITE,opacity:e.opacity??1}))),f=[],p=0;for(let e=0;e<s.length-2;e+=2)f[p++]=e+1,f[p++]=e,f[p++]=e+2,f[p++]=e+2,f[p++]=e+3,f[p++]=e+1;i&&(f[p++]=s.length-1,f[p++]=s.length-2,f[p++]=0,f[p++]=0,f[p++]=1,f[p++]=s.length-1),ns(c,f,e.fixed,Wi.gfx.defTex,e.shader,e.uniform??void 0)}(e)}if(e.radius&&t.length>=3){as(Object.assign({},e,{p1:t[0],p2:t[1]}));for(let n=1;n<t.length-2;n++){let s=t[n],r=t[n+1];as(Object.assign({},e,{p1:s,p2:r}))}as(Object.assign({},e,{p1:t[t.length-2],p2:t[t.length-1]}))}else for(let s=0;s<t.length-1;s++)as(Object.assign({},e,{p1:t[s],p2:t[s+1]})),"none"!==e.join&&is(Object.assign({},e,{pos:t[s],radius:n/2}))}}function ls(e,t){let n=t.segments??16,s=[];for(let t=0;t<=n;t++)s.push(e(t/n));os({pts:s,width:t.width||1,pos:t.pos,color:t.color,opacity:t.opacity})}function hs(e){ls((t=>he(e.pt1,e.pt2,e.pt3,e.pt4,t)),e)}var us=class e{ctx;src=null;glTex;width;height;constructor(e,t,n,s={}){this.ctx=e;let r=e.gl,i=e.gl.createTexture();if(!i)throw new Error("Failed to create texture");this.glTex=i,e.onDestroy((()=>this.free())),this.width=t,this.height=n;let a={linear:r.LINEAR,nearest:r.NEAREST}[s.filter??e.opts.texFilter??"nearest"],o={repeat:r.REPEAT,clampToEdge:r.CLAMP_TO_EDGE}[s.wrap??"clampToEdge"];this.bind(),t&&n&&r.texImage2D(r.TEXTURE_2D,0,r.RGBA,t,n,0,r.RGBA,r.UNSIGNED_BYTE,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,a),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,a),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,o),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.unbind()}static fromImage(t,n,s={}){let r=new e(t,n.width,n.height,s);return r.update(n),r.src=n,r}update(e,t=0,n=0){let s=this.ctx.gl;this.bind(),s.texSubImage2D(s.TEXTURE_2D,0,t,n,s.RGBA,s.UNSIGNED_BYTE,e),this.unbind()}bind(){this.ctx.pushTexture2D(this.glTex)}unbind(){this.ctx.popTexture2D()}free(){this.ctx.gl.deleteTexture(this.glTex)}},ds=class{ctx;tex;glFramebuffer;glRenderbuffer;constructor(e,t,n,s={}){this.ctx=e;let r=e.gl;e.onDestroy((()=>this.free())),this.tex=new us(e,t,n,s);let i=r.createFramebuffer(),a=r.createRenderbuffer();if(!i||!a)throw new Error("Failed to create framebuffer");this.glFramebuffer=i,this.glRenderbuffer=a,this.bind(),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,t,n),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.tex.glTex,0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,this.glRenderbuffer),this.unbind()}get width(){return this.tex.width}get height(){return this.tex.height}toImageData(){let e=this.ctx.gl,t=new Uint8ClampedArray(this.width*this.height*4);this.bind(),e.readPixels(0,0,this.width,this.height,e.RGBA,e.UNSIGNED_BYTE,t),this.unbind();let n=4*this.width,s=new Uint8Array(n);for(let e=0;e<(this.height/2|0);e++){let r=e*n,i=(this.height-e-1)*n;s.set(t.subarray(r,r+n)),t.copyWithin(r,i,i+n),t.set(s,i)}return new ImageData(t,this.width,this.height)}toDataURL(){let e=document.createElement("canvas"),t=e.getContext("2d");if(e.width=this.width,e.height=this.height,!t)throw new Error("Failed to get 2d context");return t.putImageData(this.toImageData(),0,0),e.toDataURL()}clear(){let e=this.ctx.gl;e.clear(e.COLOR_BUFFER_BIT)}draw(e){this.bind(),e(),this.unbind()}bind(){this.ctx.pushFramebuffer(this.glFramebuffer),this.ctx.pushRenderbuffer(this.glRenderbuffer),this.ctx.pushViewport({x:0,y:0,w:this.width,h:this.height})}unbind(){this.ctx.popFramebuffer(),this.ctx.popRenderbuffer(),this.ctx.popViewport()}free(){let e=this.ctx.gl;e.deleteFramebuffer(this.glFramebuffer),e.deleteRenderbuffer(this.glRenderbuffer),this.tex.free()}};function cs(e){let t=[],n=()=>t[t.length-1];return[n=>{t.push(n),e(n)},()=>{t.pop(),e(n()??null)},n]}var fs={};function ps(e,t){t.override?Object.assign(e,t):(t.pos&&(e.pos=e.pos.add(t.pos)),t.scale&&(e.scale=e.scale.scale(m(t.scale))),t.angle&&(e.angle+=t.angle),t.color&&1===e.ch.length&&(e.color=e.color.mult(t.color)),null!=t.opacity&&(e.opacity*=t.opacity))}function gs(e){let t={},n="",s=[],r=String(e),i=e=>{s.length>0&&(t[n.length]=s.slice()),n+=e};for(;""!==r;)if("\\"!==r[0])if("["!==r[0])i(r[0]),r=r.slice(1);else{let e=/^\[(\/)?(\w+?)\]/.exec(r);if(!e){i(r[0]),r=r.slice(1);continue}let[t,n,a]=e;if(void 0!==n){let e=s.pop();if(e!==a)throw void 0!==e?new Error(`Styled text error: mismatched tags. Expected [/${e}], got [/${a}]`):new Error(`Styled text error: stray end tag [/${a}]`)}else s.push(a);r=r.slice(t.length)}else{if(1===r.length)throw new Error("Styled text error: \\ at end of string");i(r[1]),r=r.slice(2)}if(s.length>0)throw new Error(`Styled text error: unclosed tags ${s}`);return{charStyleMap:t,text:n}}function ms(e){if(void 0===e.text)throw new Error('formatText() requires property "text".');let t=jn(e.font);if(!e.text||""===e.text||t instanceof vn||!t)return{width:0,height:0,chars:[],opt:e,renderedText:""};let{charStyleMap:n,text:s}=gs(e.text+""),r=function(e){if("string"!=typeof e)throw new TypeError("string cannot be undefined or null");let t=[],n=0,s=0;for(;n<e.length;)s+=gt(n+s,e),At(e[n+s])&&s++,wt(e[n+s])&&s++,yt(e[n+s])&&s++,xt(e[n+s])?s++:(t.push(e.substring(n,n+s)),n+=s,s=0);return t}(s);if(t instanceof Hn||"string"==typeof t){let e=t instanceof Hn?t.fontface.family:t,n=t instanceof Hn?{outline:t.outline,filter:t.filter}:{outline:null,filter:Ne},s=fs[e]??{font:{tex:new us(Wi.gfx.ggl,2048,2048,{filter:n.filter}),map:{},size:64},cursor:new g(0),maxHeight:0,outline:n.outline};fs[e]||(fs[e]=s),t=s.font;for(let n of r)if(!s.font.map[n]){let r=Wi.fontCacheC2d;if(!r)throw new Error("fontCacheC2d is not defined.");if(!Wi.fontCacheCanvas)throw new Error("fontCacheCanvas is not defined.");r.clearRect(0,0,Wi.fontCacheCanvas.width,Wi.fontCacheCanvas.height),r.font=`${t.size}px ${e}`,r.textBaseline="top",r.textAlign="left",r.fillStyle="#ffffff";let i=r.measureText(n),a=Math.ceil(i.width);if(!a)continue;let o=Math.ceil(Math.abs(i.actualBoundingBoxAscent))+Math.ceil(Math.abs(i.actualBoundingBoxDescent));s.outline&&s.outline.width&&s.outline.color&&(r.lineJoin="round",r.lineWidth=2*s.outline.width,r.strokeStyle=s.outline.color.toHex(),r.strokeText(n,s.outline.width,s.outline.width),a+=2*s.outline.width,o+=3*s.outline.width),r.fillText(n,s.outline?.width??0,s.outline?.width??0);let l=r.getImageData(0,0,a,o);if(s.cursor.x+a>2048&&(s.cursor.x=0,s.cursor.y+=s.maxHeight,s.maxHeight=0,s.cursor.y>2048))throw new Error("Font atlas exceeds character limit");t.tex.update(l,s.cursor.x,s.cursor.y),t.map[n]=new w(s.cursor.x,s.cursor.y,a,o),s.cursor.x+=a+1,s.maxHeight=Math.max(s.maxHeight,o)}}let i,a=e.size||t.size,l=m(e.scale??1).scale(a/t.size),h=e.lineSpacing??0,u=e.letterSpacing??0,d=0,c=0,f=0,p=[],y=[],A=0,x=null,v=0;for(;A<r.length;){let n=r[A];if("\n"===n)f+=a+h,p.push({width:d-u,chars:y}),x=null,v=0,d=0,y=[],i=void 0;else{let s=t.map[n];if(s){let b=s.w*l.x;e.width&&d+b>e.width&&(f+=a+h,null!=x&&(A-=y.length-x,n=r[A],s=t.map[n],b=s.w*l.x,y=y.slice(0,x-1),d=v),x=null,v=0,p.push({width:d-u,chars:y}),d=i??0,y=[]),y.push({tex:t.tex,width:s.w,height:s.h,quad:new w(s.x/t.tex.width,s.y/t.tex.height,s.w/t.tex.width,s.h/t.tex.height),ch:n,pos:new g(d,f),opacity:e.opacity??1,color:e.color??o.WHITE,scale:m(l),angle:0})," "===n&&(x=y.length,v=d),e.indentAll&&void 0===i&&/\S/.test(n)&&(i=d),d+=b,c=Math.max(c,d),d+=u}}A++}p.push({width:d-u,chars:y}),f+=a,e.width&&(c=e.width);let b=[];for(let s=0;s<p.length;s++){let r=(c-p[s].width)*Wt(e.align??"left");for(let i of p[s].chars){let a=t.map[i.ch],o=b.length+s;if(i.pos=i.pos.add(r,0).add(a.w*l.x*.5,a.h*l.y*.5),e.transform){let t="function"==typeof e.transform?e.transform(o,i.ch):e.transform;t&&ps(i,t)}if(n[o]){let t=n[o];for(let n of t){let t=e.styles?.[n],s="function"==typeof t?t(o,i.ch):t;s&&ps(i,s)}}b.push(i)}}return{width:c,height:f,chars:b,opt:e,renderedText:s}}function ws(e){if(void 0===e.width||void 0===e.height)throw new Error('drawUVQuad() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,s=Qt(e.anchor||Ue).scale(new g(t,n).scale(-.5)),r=e.quad||new w(0,0,1,1),i=e.color||l(255,255,255),a=e.opacity??1,o=e.tex?.1/e.tex.width:0,h=e.tex?.1/e.tex.height:0,u=r.x+o,d=r.y+h,c=r.w-2*o,f=r.h-2*h;hn(),ln(e.pos),cn(e.angle),dn(e.scale),ln(s),ns([{pos:new g(-t/2,n/2),uv:new g(e.flipX?u+c:u,e.flipY?d:d+f),color:i,opacity:a},{pos:new g(-t/2,-n/2),uv:new g(e.flipX?u+c:u,e.flipY?d+f:d),color:i,opacity:a},{pos:new g(t/2,-n/2),uv:new g(e.flipX?u:u+c,e.flipY?d+f:d),color:i,opacity:a},{pos:new g(t/2,n/2),uv:new g(e.flipX?u:u+c,e.flipY?d:d+f),color:i,opacity:a}],[0,1,3,1,2,3],e.fixed,e.tex,e.shader,e.uniform??void 0),fn()}function ys(e){hn(),ln(e.opt.pos),cn(e.opt.angle),ln(Qt(e.opt.anchor??"topleft").add(1,1).scale(e.width,e.height).scale(-.5)),e.chars.forEach((t=>{ws({tex:t.tex,width:t.width,height:t.height,pos:t.pos,scale:t.scale,angle:t.angle,color:t.color,opacity:t.opacity,quad:t.quad,anchor:"center",uniform:e.opt.uniform,shader:e.opt.shader,fixed:e.opt.fixed})})),fn()}function As(e){if(void 0===e.width||void 0===e.height)throw new Error('drawRect() requires property "width" and "height".');if(e.width<=0||e.height<=0)return;let t=e.width,n=e.height,s=Qt(e.anchor||Ue).add(1,1).scale(new g(t,n).scale(-.5)),r=[new g(0,0),new g(t,0),new g(t,n),new g(0,n)];if(e.radius){let s=Math.min(t,n)/2,i=Array.isArray(e.radius)?e.radius.map((e=>Math.min(s,e))):new Array(4).fill(Math.min(s,e.radius));r=[new g(i[0],0),...i[1]?rn(new g(t-i[1],i[1]),i[1],i[1],270,360):[m(t,0)],...i[2]?rn(new g(t-i[2],n-i[2]),i[2],i[2],0,90):[m(t,n)],...i[3]?rn(new g(i[3],n-i[3]),i[3],i[3],90,180):[m(0,n)],...i[0]?rn(new g(i[0],i[0]),i[0],i[0],180,270):[]]}ss(Object.assign({},e,{offset:s,pts:r,...e.gradient?{colors:e.horizontal?[e.gradient[0],e.gradient[1],e.gradient[1],e.gradient[0]]:[e.gradient[0],e.gradient[0],e.gradient[1],e.gradient[1]]}:{}}))}function xs(e){pn();let t=Wi.gfx.width,n=Wi.gfx.height;Wi.gfx.width=Wi.gfx.viewport.width,Wi.gfx.height=Wi.gfx.viewport.height,e(),pn(),Wi.gfx.width=t,Wi.gfx.height=n}function vs(e,t){xs((()=>{let n=m(8);hn(),ln(e);let s=ms({text:t,font:Le,size:16,pos:n,color:l(255,255,255),fixed:!0}),r=s.width+2*n.x,i=s.height+2*n.x;e.x+r>=gn()&&ln(m(-r,0)),e.y+i>=mn()&&ln(m(0,-i)),As({width:r,height:i,color:l(0,0,0),radius:4,opacity:.8,fixed:!0}),ys(s),fn()}))}function bs(e){if(!e.p1||!e.p2||!e.p3)throw new Error('drawTriangle() requires properties "p1", "p2" and "p3".');return ss(Object.assign({},e,{pts:[e.p1,e.p2,e.p3]}))}function Es(){if(Wi.debug.inspect){let e=null;for(let t of Wi.game.root.get("*",{recursive:!0}))if(t.has("area")&&t.isHovering()){e=t;break}if(Wi.game.root.drawInspect(),e){let t=[],n=e.inspect();for(let e in n)n[e]?t.push(`${n[e]}`):t.push(`${e}`);vs(function(e){return new g(e.x*Wi.gfx.viewport.width/Wi.gfx.width,e.y*Wi.gfx.viewport.height/Wi.gfx.height)}(Wi.k.mousePos()),t.join("\n"))}vs(m(8),`FPS: ${Wi.debug.fps()}`)}Wi.debug.paused&&xs((()=>{hn(),ln(gn(),0),ln(-8,8);As({width:32,height:32,anchor:"topright",color:l(0,0,0),opacity:.8,radius:4,fixed:!0});for(let e=1;e<=2;e++)As({width:4,height:19.2,anchor:"center",pos:m(-32/3*e,16),color:l(255,255,255),radius:2,fixed:!0});fn()})),1!==Wi.debug.timeScale&&xs((()=>{hn(),ln(gn(),mn()),ln(-8,-8);let e=ms({text:Wi.debug.timeScale.toFixed(1),font:Le,size:16,color:l(255,255,255),pos:m(-8),anchor:"botright",fixed:!0});As({width:e.width+16+32,height:e.height+16,anchor:"botright",color:l(0,0,0),opacity:.8,radius:4,fixed:!0});for(let t=0;t<2;t++){let n=Wi.debug.timeScale<1;bs({p1:m(-e.width-8*(n?2:3.5),-8),p2:m(-e.width-8*(n?2:3.5),-8-e.height),p3:m(-e.width-8*(n?3.5:2),-8-e.height/2),pos:m(8*-t*1+(n?-4:0),0),color:l(255,255,255),fixed:!0})}ys(e),fn()})),Wi.debug.curRecording&&xs((()=>{hn(),ln(0,mn()),ln(24,-24),is({radius:12,color:l(255,0,0),opacity:b(0,1,4*Wi.app.time()),fixed:!0}),fn()})),Wi.debug.showLog&&Wi.game.logs.length>0&&xs((()=>{hn(),ln(0,mn()),ln(8,-8);let e=[];for(let t of Wi.game.logs){let n="",s=t.msg instanceof Error?"error":"info";n+=`[time]${t.time.toFixed(2)}[/time]`,n+=" ",n+=`[${s}]${Ms(t.msg)}[/${s}]`,e.push(n)}Wi.game.logs=Wi.game.logs.filter((e=>Wi.app.time()-e.time<(Wi.globalOpt.logTime||4)));let t=ms({text:e.join("\n"),font:Le,pos:m(8,-8),anchor:"botleft",size:16,width:.6*gn(),lineSpacing:4,fixed:!0,styles:{time:{color:l(127,127,127)},info:{color:l(255,255,255)},error:{color:l(255,0,127)}}});As({width:t.width+16,height:t.height+16,anchor:"botleft",color:l(0,0,0),radius:4,opacity:.8,fixed:!0}),ys(t),fn()}))}function Ms(e,t=!1,n=new Set){if(n.has(e))return"<recursive>";var s,r="";return t&&"string"==typeof e&&(e=JSON.stringify(e)),Array.isArray(e)&&(r=["[",e.map((t=>Ms(t,!0,n.union(new Set([e]))))).join(", "),"]"].join(""),e=r),null===e?"null":("object"==typeof e&&e.toString===Object.prototype.toString&&(e.constructor!==Object&&(r+=e.constructor.name+" "),r+=["{",(s=Object.getOwnPropertyNames(e).map((t=>`${/^\w+$/.test(t)?t:JSON.stringify(t)}: ${Ms(e[t],!0,n.union(new Set([e])))}`)).join(", "))?` ${s} `:"","}"].join(""),e=r),String(e).replaceAll(/(?<!\\)\[/g,"\\["))}function qs(e,t,n){let s=Wi.gfx.ggl.gl;pn(),s.clear(s.STENCIL_BUFFER_BIT),s.enable(s.STENCIL_TEST),s.stencilFunc(s.NEVER,1,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE),t(),pn(),s.stencilFunc(n,1,255),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),e(),pn(),s.disable(s.STENCIL_TEST)}function Ss(e,t){qs(e,t,Wi.gfx.ggl.gl.EQUAL)}function Bs(e){if(!e.tex)throw new Error('drawTexture() requires property "tex".');let t=e.quad??new w(0,0,1,1),n=e.tex.width*t.w,s=e.tex.height*t.h,r=new g(1);if(e.tiled){let r=Qt(e.anchor||Ue),i=(e.pos?.x,r.x,e.width,e.pos?.y,r.y,e.height,(e.width||n)/n),a=(e.height||s)/s,l=Math.floor(i),h=Math.floor(a),u=i-l,d=a-h,c=(l+u?1:0)*(h+d?1:0),f=new Array(6*c),p=new Array(4*c),m=0,y=(t,n,s,i,a)=>{f[6*m+0]=4*m+0,f[6*m+1]=4*m+1,f[6*m+2]=4*m+3,f[6*m+3]=4*m+1,f[6*m+4]=4*m+2,f[6*m+5]=4*m+3,p[4*m+0]={pos:new g(t-r.x,n-r.y),uv:new g(a.x,a.y),color:e.color||o.WHITE,opacity:e.opacity||1},p[4*m+1]={pos:new g(t+s-r.x,n-r.y),uv:new g(a.x+a.w,a.y),color:e.color||o.WHITE,opacity:e.opacity||1},p[4*m+2]={pos:new g(t+s-r.x,n+i-r.y),uv:new g(a.x+a.w,a.y+a.h),color:e.color||o.WHITE,opacity:e.opacity||1},p[4*m+3]={pos:new g(t-r.x,n+i-r.y),uv:new g(a.x,a.y+a.h),color:e.color||o.WHITE,opacity:e.opacity||1},m++};for(let e=0;e<h;e++){for(let r=0;r<l;r++)y(r*n,e*s,n,s,t);u&&y(l*n,e*s,n*u,s,new w(t.x,t.y,t.w*u,t.h))}if(d){for(let e=0;e<l;e++)y(e*n,h*s,n,s*d,new w(t.x,t.y,t.w,t.h*d));u&&y(l*n,h*s,n*u,s*d,new w(t.x,t.y,t.w*u,t.h*d))}ns(p,f,e.fixed,e.tex,e.shader,e.uniform??void 0)}else e.width&&e.height?(r.x=e.width/n,r.y=e.height/s):e.width?(r.x=e.width/n,r.y=r.x):e.height&&(r.y=e.height/s,r.x=r.y),ws(Object.assign({},e,{scale:r.scale(e.scale||new g(1)),tex:e.tex,quad:t,width:n,height:s}))}function Rs(e){if(!e.sprite)throw new Error('drawSprite() requires property "sprite"');let t=Fn(e.sprite);if(!t||!t.data)return;let n=t.data.frames[e.frame??0];if(!n)throw new Error(`Frame not found: ${e.frame??0}`);Bs(Object.assign({},e,{tex:t.data.tex,quad:n.scale(e.quad??new w(0,0,1,1))}))}function Is(e,t){qs(e,t,Wi.gfx.ggl.gl.NOTEQUAL)}function ks(e){ys(ms(e))}var Ps=(e,t)=>{let n=Qn(t,Ye,Xe),s=e.pixelDensity??1,r=e.scale??1,{gl:i}=t,a=us.fromImage(t,new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),o=e.width&&e.height?new ds(t,e.width*s*r,e.height*s*r):new ds(t,i.drawingBufferWidth,i.drawingBufferHeight),h=null,u=1;e.background&&("string"==typeof e.background?h=l(e.background):(h=l(...e.background),u=e.background[3]??1),i.clearColor(h.r/255,h.g/255,h.b/255,u??1)),i.enable(i.BLEND),i.blendFuncSeparate(i.ONE,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA);let d=new class{ctx;glVBuf;glIBuf;vqueue=[];iqueue=[];stride;maxVertices;maxIndices;vertexFormat;numDraws=0;curPrimitive=null;curTex=null;curShader=null;curUniform={};constructor(e,t,n,s){let r=e.gl;this.vertexFormat=t,this.ctx=e,this.stride=t.reduce(((e,t)=>e+t.size),0),this.maxVertices=n,this.maxIndices=s;let i=r.createBuffer();if(!i)throw new Error("Failed to create vertex buffer");this.glVBuf=i,e.pushArrayBuffer(this.glVBuf),r.bufferData(r.ARRAY_BUFFER,4*n,r.DYNAMIC_DRAW),e.popArrayBuffer(),this.glIBuf=r.createBuffer(),e.pushElementArrayBuffer(this.glIBuf),r.bufferData(r.ELEMENT_ARRAY_BUFFER,4*s,r.DYNAMIC_DRAW),e.popElementArrayBuffer()}push(e,t,n,s,r=null,i={}){(e!==this.curPrimitive||r!==this.curTex||s!==this.curShader||!ht(this.curUniform,i)||this.vqueue.length+t.length*this.stride>this.maxVertices||this.iqueue.length+n.length>this.maxIndices)&&this.flush();let a=this.vqueue.length/this.stride;for(let e of t)this.vqueue.push(e);for(let e of n)this.iqueue.push(e+a);this.curPrimitive=e,this.curShader=s,this.curTex=r,this.curUniform=i}flush(){if(!this.curPrimitive||!this.curShader||0===this.vqueue.length||0===this.iqueue.length)return;let e=this.ctx.gl;this.ctx.pushArrayBuffer(this.glVBuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),this.ctx.pushElementArrayBuffer(this.glIBuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),this.ctx.setVertexFormat(this.vertexFormat),this.curShader.bind(),this.curShader.send(this.curUniform),this.curTex?.bind(),e.drawElements(this.curPrimitive,this.iqueue.length,e.UNSIGNED_SHORT,0),this.curTex?.unbind(),this.curShader.unbind(),this.ctx.popArrayBuffer(),this.ctx.popElementArrayBuffer(),this.vqueue=[],this.iqueue=[],this.numDraws++}free(){let e=this.ctx.gl;e.deleteBuffer(this.glVBuf),e.deleteBuffer(this.glIBuf)}}(t,He,Ge,12288),c=us.fromImage(t,new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2),{wrap:"repeat",filter:"nearest"});return{lastDrawCalls:0,ggl:t,defShader:n,defTex:a,frameBuffer:o,postShader:null,postShaderUniform:null,renderer:d,transform:new v,transformStack:[],bgTex:c,bgColor:h,bgAlpha:u,width:e.width??i.drawingBufferWidth/s/r,height:e.height??i.drawingBufferHeight/s/r,viewport:{x:0,y:0,width:i.drawingBufferWidth,height:i.drawingBufferHeight,scale:1},fixed:!1}};function Cs(e){return!!e.fixed||!!e.parent&&Cs(e.parent)}function Fs(e){return{color:e.color,opacity:e.opacity,anchor:e.anchor,outline:e.outline,shader:e.shader,uniform:e.uniform}}function Ts(e,t={}){return{id:"circle",radius:e,draw(){is(Object.assign(Fs(this),{radius:this.radius,fill:t.fill}))},renderArea(){return new ne(new g(this.anchor?0:-this.radius),2*this.radius,2*this.radius)},inspect(){return`radius: ${Math.ceil(this.radius)}`}}}function Ds(...e){return{id:"color",color:l(...e),inspect(){return`color: ${this.color.toString()}`}}}function Os(e){return{add(){this.canvas=e}}}function Us(e=1){let t,n=0,s=!1;return{require:["opacity"],add(){t=this.opacity,this.opacity=0},update(){s||(n+=Dt(),this.opacity=f(n,0,e,0,t),n>=e&&(this.opacity=t,s=!0))}}}function Ls(e="intersect"){return{id:"mask",mask:e}}function Ns(e){return{id:"opacity",opacity:e??1,fadeIn(e=1,t=Wi.k.easings.linear){return Wi.game.root.tween(0,this.opacity,e,(e=>this.opacity=e),t)},fadeOut(e=1,t=Wi.k.easings.linear){return Wi.game.root.tween(this.opacity,0,e,(e=>this.opacity=e),t)},inspect(){return`opacity: ${ct(this.opacity,1)}`}}}function Hs(e=1,t=l(0,0,0),n=1,s="miter",r=10,i="butt"){return{id:"outline",outline:{width:e,color:t,opacity:n,join:s,miterLimit:r,cap:i},inspect(){return`outline: ${this.outline.width}px, ${this.outline.color}`}}}var js=class{pos=m(0);vel=m(0);acc=m(0);angle=0;angularVelocity=0;damping=0;t;lt=null;gc;constructor(){this.t=0,this.gc=!0}get progress(){return this.lt?this.t/this.lt:this.t}};function Gs(e,t){let n=t.lifetime,s=[],r=e.colors||[o.WHITE],i=e.opacities||[1],a=e.quads||[new w(0,0,1,1)],h=e.scales||[1],u=e.lifeTime,d=t.direction,p=t.spread,y=e.speed||[0,0],A=e.angle||[0,0],x=e.angularVelocity||[0,0],v=e.acceleration||[m(0),m(0)],b=e.damping||[0,0],E=[],M=new Array(e.max),q=0,S=0;for(let t=0;t<e.max;t++){E[6*t+0]=4*t+0,E[6*t+1]=4*t+1,E[6*t+2]=4*t+3,E[6*t+3]=4*t+1,E[6*t+4]=4*t+2,E[6*t+5]=4*t+3;for(let e=0;e<4;e++)M[4*t+e]={pos:new g(0,0),uv:new g(0,0),color:l(255,255,255),opacity:1};s[t]=new js}let R=new _e;function I(t=0){for(;t<e.max;){if(s[t].gc)return t;t++}return null}return{id:"particles",emit(e){let n=0;for(let r=0;r<e;r++){if(n=I(n),null==n)return;let e=B(d-p,d+p),r=g.fromAngle(e).scale(B(y[0],y[1])),i=B(A[0],A[1]),a=B(x[0],x[1]),o=m(B(v[0].x,v[1].x),B(v[0].y,v[1].y)),l=B(b[0],b[1]),h=u?B(u[0],u[1]):null,c=t.shape?t.shape.random():m(),f=s[n];f.lt=h,f.pos=c,f.vel=r,f.acc=o,f.angle=i,f.angularVelocity=a,f.damping=l,f.angularVelocity=a,f.gc=!1}q+=e},update(){if(void 0!==n&&n<=0)return;let r=Dt();for(let e of s)if(!e.gc){if(e.t+=r,e.lt&&e.t>=e.lt){e.gc=!0,q--;continue}e.vel=e.vel.add(e.acc.scale(r)).scale(1-e.damping*r),e.pos=e.pos.add(e.vel.scale(r)),e.angle+=e.angularVelocity*r}for(void 0!==n&&(n-=r,n<=0&&R.trigger()),S+=r;q<e.max&&t.rate&&S>t.rate;)this.emit(1),q++,S-=t.rate},draw(){if(!(void 0!==n&&n<=0)){for(let t=0;t<s.length;t++){let n=s[t];if(n.gc)continue;let o=n.progress,l=Math.floor(n.progress*r.length),u=l<r.length-1?c(r[l],r[l+1],f(o,l/r.length,(l+1)/r.length,0,1)):r[l],d=Math.floor(n.progress*i.length),p=d<i.length-1?c(i[d],i[d+1],f(o,d/i.length,(d+1)/i.length,0,1)):i[d],g=Math.floor(n.progress*a.length),m=a[g],w=Math.floor(n.progress*h.length),y=h[w],A=Math.cos(n.angle*Math.PI/180),x=Math.sin(n.angle*Math.PI/180),v=(e.texture?e.texture.width:10)*m.w/2,b=(e.texture?e.texture.height:10)*m.h/2,E=4*t,q=M[E];q.pos.x=n.pos.x+-v*y*A- -b*y*x,q.pos.y=n.pos.y+-v*y*x+-b*y*A,q.uv.x=m.x,q.uv.y=m.y,q.color.r=u.r,q.color.g=u.g,q.color.b=u.b,q.opacity=p,q=M[E+1],q.pos.x=n.pos.x+v*y*A- -b*y*x,q.pos.y=n.pos.y+v*y*x+-b*y*A,q.uv.x=m.x+m.w,q.uv.y=m.y,q.color.r=u.r,q.color.g=u.g,q.color.b=u.b,q.opacity=p,q=M[E+2],q.pos.x=n.pos.x+v*y*A-b*y*x,q.pos.y=n.pos.y+v*y*x+b*y*A,q.uv.x=m.x+m.w,q.uv.y=m.y+m.h,q.color.r=u.r,q.color.g=u.g,q.color.b=u.b,q.opacity=p,q=M[E+3],q.pos.x=n.pos.x+-v*y*A-b*y*x,q.pos.y=n.pos.y+-v*y*x+b*y*A,q.uv.x=m.x,q.uv.y=m.y+m.h,q.color.r=u.r,q.color.g=u.g,q.color.b=u.b,q.opacity=p}ns(M,E,this.fixed,e.texture,this.shader,this.uniform)}},onEnd:e=>R.add(e),inspect:()=>`count: ${q}/${e.max}`}}function Vs(e,t={}){if(e.length<3)throw new Error(`Polygon's need more than two points, ${e.length} points provided`);return{id:"polygon",pts:e,colors:t.colors,uv:t.uv,tex:t.tex,radius:t.radius,draw(){ss(Object.assign(Fs(this),{pts:this.pts,colors:this.colors,uv:this.uv,tex:this.tex,radius:this.radius,fill:t.fill,triangulate:t.triangulate}))},renderArea(){return new ie(this.pts)},inspect(){return`polygon: ${this.pts.map((e=>`[${e.x},${e.y}]`)).join(",")}`}}}function Ks(e,t,n){let s;return Wi.game.root.get("area").forEach((r=>{if(n&&n.some((e=>r.is(e))))return;let i=r.worldArea().raycast(e,t);i&&(s?i.fraction<s.fraction&&(s=i,s.object=r):(s=i,s.object=r))})),s}function Ys(e,t,n={}){return{id:"rect",width:e,height:t,radius:n.radius||0,draw(){As(Object.assign(Fs(this),{width:this.width,height:this.height,radius:this.radius,fill:n.fill}))},renderArea(){return new ne(m(0),this.width,this.height)},inspect(){return`rect: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)}h)`}}}function Xs(e,t){return{id:"shader",shader:e,..."function"==typeof t?{uniform:t(),update(){this.uniform=t()}}:{uniform:t},inspect:()=>`shader: ${e}`}}function Qs(e,t){if(!t.tileWidth||!t.tileHeight)throw new Error("Must provide tileWidth and tileHeight.");let n=Wi.game.root.add([Vi(t.pos??m(0))]),s=e.length,r=0,i=null,a=null,o=null,l=null,h=e=>e.x+e.y*r,u=e=>m(Math.floor(e%r),Math.floor(e/r)),d=()=>{i=[];for(let e of n.children)c(e)},c=e=>{let t=h(e.tilePos);i[t]?i[t].push(e):i[t]=[e]},f=e=>{let t=h(e.tilePos);if(i[t]){let n=i[t].indexOf(e);n>=0&&i[t].splice(n,1)}},p=(e,t)=>a[t],g=(e,t)=>{let n=u(e),s=u(t);return n.dist(s)},w=(e,t)=>{let n=[],i=Math.floor(e%r),l=i>0&&1&o[e]&&a[e-1]!==1/0,h=e>=r&&2&o[e]&&a[e-r]!==1/0,u=i<r-1&&4&o[e]&&a[e+1]!==1/0,d=e<r*s-r-1&&8&o[e]&&a[e+r]!==1/0;return t?(l&&(h&&n.push(e-r-1),n.push(e-1),d&&n.push(e+r-1)),h&&n.push(e-r),u&&(h&&n.push(e-r+1),n.push(e+1),d&&n.push(e+r+1)),d&&n.push(e+r)):(l&&n.push(e-1),h&&n.push(e-r),u&&n.push(e+1),d&&n.push(e+r)),n},y={id:"level",tileWidth:()=>t.tileWidth,tileHeight:()=>t.tileHeight,spawn(e,...s){let r=m(...s),a=(()=>{if("string"!=typeof e){if(Array.isArray(e))return e;throw new Error("Expected a symbol or a component list")}if(t.tiles[e]){if("function"!=typeof t.tiles[e])throw new Error("Level symbol def must be a function returning a component list");return t.tiles[e](r)}if(t.wildcardTile)return t.wildcardTile(e,r)})();if(!a)return null;let o=!1,l=!1;for(let e of a)"tile"===e.id&&(l=!0),"pos"===e.id&&(o=!0);o||a.push(Vi(this.tile2Pos(r))),l||a.push(di());let h=n.add(a);return o&&(h.tilePosOffset=h.pos.clone()),h.tilePos=r,h.transform=nn(h),i&&(c(h),this.trigger("spatialMapChanged"),this.trigger("navigationMapInvalid")),h},numColumns:()=>r,numRows:()=>s,levelWidth(){return r*this.tileWidth()},levelHeight(){return s*this.tileHeight()},tile2Pos(...e){return m(...e).scale(this.tileWidth(),this.tileHeight())},pos2Tile(...e){let t=m(...e);return m(Math.floor(t.x/this.tileWidth()),Math.floor(t.y/this.tileHeight()))},getSpatialMap:()=>(i||d(),i),removeFromSpatialMap:f,insertIntoSpatialMap:c,onSpatialMapChanged(e){return this.on("spatialMapChanged",e)},onNavigationMapInvalid(e){return this.on("navigationMapInvalid",e)},getAt(e){i||d();let t=h(e);return i[t]||[]},raycast(e,t){let n=this.toWorld(e),s=this.toWorld(e.add(t)).sub(n),r=1/this.tileWidth(),i=function(e,t,n,s=64){let r=e,i=t.len(),a=t.scale(1/i),o=0,l=m(Math.floor(e.x),Math.floor(e.y)),h=m(a.x>0?1:-1,a.y>0?1:-1),u=m(Math.abs(1/a.x),Math.abs(1/a.y)),d=m(h.x>0?l.x+1-e.x:e.x-l.x,h.y>0?l.y+1-e.y:e.y-l.y),c=m(u.x<1/0?u.x*d.x:1/0,u.y<1/0?u.y*d.y:1/0),f=-1;for(;o<=s;){let e=n(l);if(!0===e)return{point:r.add(a.scale(o)),normal:m(0===f?-h.x:0,1===f?-h.y:0),fraction:o/i,gridPos:l};if(e)return e;c.x<c.y?(l.x+=h.x,o=c.x,c.x+=u.x,f=0):(l.y+=h.y,o=c.y,c.y+=u.y,f=1)}return null}(e.scale(r),t,(e=>{let t=this.getAt(e);if(t.some((e=>e.isObstacle)))return!0;let i=null;for(let e of t)if(e.has("area")){let t=e.worldArea().raycast(n,s);t&&(i?t.fraction<i.fraction&&(i=t,i.object=e):(i=t,i.object=e))}return i&&(i.point=this.fromWorld(i.point).scale(r)),i||!1}),64);return i&&(i.point=i.point.scale(this.tileWidth())),i},update(){i&&(()=>{let e=!1;for(let t of n.children){let s=n.pos2Tile(t.pos);(t.tilePos.x!=s.x||t.tilePos.y!=s.y)&&(e=!0,f(t),t.tilePos.x=s.x,t.tilePos.y=s.y,c(t))}e&&n.trigger("spatialMapChanged")})()},invalidateNavigationMap(){a=null,o=null,l=null},onNavigationMapChanged(e){return this.on("navigationMapChanged",e)},getTilePath(e,t,i={}){if(a||(()=>{let e=n.getSpatialMap(),t=n.numRows()*n.numColumns();a?a.length=t:a=new Array(t),a.fill(1,0,t);for(let t=0;t<e.length;t++){let n=e[t];if(n){let e=0;for(let t of n){if(t.isObstacle){e=1/0;break}e+=t.cost}a[t]=e||1}}})(),o||(()=>{let e=n.getSpatialMap(),t=n.numRows()*n.numColumns();o?o.length=t:o=new Array(t),o.fill(15,0,t);for(let t=0;t<e.length;t++){let n=e[t];if(n){let e=n.length,s=15;for(let t=0;t<e;t++)s|=n[t].edgeMask;o[t]=s}}})(),l||(()=>{let e=n.numRows()*n.numColumns(),t=(e,t)=>{let n=[];for(n.push(e);n.length>0;){let e=n.pop();w(e).forEach((e=>{l[e]<0&&(l[e]=t,n.push(e))}))}};l?l.length=e:l=new Array(e),l.fill(-1,0,e);let s=0;for(let e=0;e<a.length;e++)l[e]>=0||t(e,s),s++})(),e.x<0||e.x>=r||e.y<0||e.y>=s||t.x<0||t.x>=r||t.y<0||t.y>=s)return null;let d=h(e),c=h(t);if(a[c]===1/0)return null;if(d===c)return[];if(-1!=l[d]&&l[d]!==l[c])return null;let f=new nt(((e,t)=>e.cost<t.cost));f.insert({cost:0,node:d});let m=new Map;m.set(d,d);let y=new Map;for(y.set(d,0);0!==f.length;){let e=f.remove()?.node;if(e===c)break;let t=w(e,i.allowDiagonals);for(let n of t){let t=(y.get(e)||0)+p(0,n)+g(n,c);(!y.has(n)||t<y.get(n))&&(y.set(n,t),f.insert({cost:t,node:n}),m.set(n,e))}}let A=[],x=c,v=u(x);for(A.push(v);x!==d;){let e=m.get(x);if(void 0===e)throw new Error("Bug in pathfinding algorithm");x=e;let t=u(x);A.push(t)}return A.reverse()},getPath(e,t,n={}){let s=this.tileWidth(),r=this.tileHeight(),i=this.getTilePath(this.pos2Tile(e),this.pos2Tile(t),n);return i?[e,...i.slice(1,-1).map((e=>e.scale(s,r).add(s/2,r/2))),t]:null}};return n.use(y),n.onNavigationMapInvalid((()=>{n.invalidateNavigationMap(),n.trigger("navigationMapChanged")})),e.forEach(((e,t)=>{let s=e.split("");r=Math.max(s.length,r),s.forEach(((e,s)=>{n.spawn(e,m(s,t))}))})),n}function Ws(e,t,n){return Wi.game.objEvents.registers[e]||(Wi.game.objEvents.registers[e]=new Ze),Wi.game.objEvents.on(e,((e,...s)=>{e.is(t)&&n(e,...s)}))}var zs=(e,t,...n)=>{for(let s of Wi.game.root.children)s.is(t)&&s.trigger(e,n)},Zs=ft((e=>{let t=Wi.game.root.add([{fixedUpdate:e}]);return{get paused(){return t.paused},set paused(e){t.paused=e},cancel:()=>t.destroy()}}),((e,t)=>Ws("fixedUpdate",e,t))),Js=ft((e=>{let t=Wi.game.root.add([{update:e}]);return{get paused(){return t.paused},set paused(e){t.paused=e},cancel:()=>t.destroy()}}),((e,t)=>Ws("update",e,t))),_s=ft((e=>{let t=Wi.game.root.add([{draw:e}]);return{get paused(){return t.hidden},set paused(e){t.hidden=e},cancel:()=>t.destroy()}}),((e,t)=>Ws("draw",e,t))),$s=ft((e=>Wi.game.events.on("add",e)),((e,t)=>Ws("add",e,t))),er=ft((e=>Wi.game.events.on("destroy",e)),((e,t)=>Ws("destroy",e,t))),tr=ft((e=>Wi.game.events.on("use",e)),((e,t)=>Ws("use",e,t))),nr=ft((e=>Wi.game.events.on("unuse",e)),((e,t)=>Ws("unuse",e,t))),sr=ft((e=>Wi.game.events.on("tag",e)),((e,t)=>Ws("tag",e,t))),rr=ft((e=>Wi.game.events.on("untag",e)),((e,t)=>Ws("untag",e,t)));function ir(e,t,n){return Ws("collide",e,((e,s,r)=>s.is(t)&&n(e,s,r)))}function ar(e,t,n){return Ws("collideUpdate",e,((e,s,r)=>s.is(t)&&n(e,s,r)))}function or(e,t,n){return Ws("collideEnd",e,((e,s,r)=>s.is(t)&&n(e,s,r)))}function lr(e,t){Wi.game.root.get(e,{recursive:!0}).forEach(t),$s(e,t),sr(((n,s)=>{s===e&&t(n)}))}var hr=ft((e=>Wi.app.onMousePress(e)),((e,t)=>{let n=[];return lr(e,(e=>{if(!e.area)throw new Error("onClick() requires the object to have area() component");n.push(e.onClick((()=>t(e))))})),Je.join(n)}));function ur(e,t){let n=[];return lr(e,(e=>{if(!e.area)throw new Error("onHover() requires the object to have area() component");n.push(e.onHover((()=>t(e))))})),Je.join(n)}function dr(e,t){let n=[];return lr(e,(e=>{if(!e.area)throw new Error("onHoverUpdate() requires the object to have area() component");n.push(e.onHoverUpdate((()=>t(e))))})),Je.join(n)}function cr(e,t){let n=[];return lr(e,(e=>{if(!e.area)throw new Error("onHoverEnd() requires the object to have area() component");n.push(e.onHoverEnd((()=>t(e))))})),Je.join(n)}function fr(e){Wi.game.events.on("loading",e)}function pr(e){Wi.app.onResize(e)}function gr(e){Wi.game.events.on("error",e)}function mr(e){Wi.assets.loaded?e():Wi.game.events.on("load",e)}function wr(e){if(!Wi.assets.loaded)return Wi.game.events.on("loadError",e);In().forEach((t=>e(...t)))}function yr(...e){Wi.game.cam.pos=m(...e)}function Ar(){return Wi.game.cam.pos?Wi.game.cam.pos.clone():yn()}function xr(...e){Wi.game.cam.scale=m(...e)}function vr(){return Wi.game.cam.scale.clone()}function br(e){Wi.game.cam.angle=e}function Er(){return Wi.game.cam.angle}function Mr(){return Wi.game.cam.transform.clone()}function qr(e=l(255,255,255),t=1){let n=Wi.game.root.add([Ys(gn(),mn()),Ds(e),Ns(1),{id:"fixed",fixed:!0}]),s=n.fadeOut(t);return s.onEnd((()=>_r(n))),s}function Sr(){return Wi.game.cam.transform.clone()}function Br(e=12){Wi.game.cam.shake+=e}function Rr(e){return Wi.game.cam.transform.multVec2(e)}function Ir(e){return Wi.game.cam.transform.invert().multVec2(e)}function kr(...e){return dt("camPos","setCamPos / getCamPos"),e.length>0&&yr(...e),Ar()}function Pr(...e){return dt("camScale","setCamScale / getCamScale"),e.length>0&&xr(...e),vr()}function Cr(e){return dt("camRot","setCamRot / getCamRot"),void 0!==e&&br(e),Er()}function Fr(e=l(255,255,255),t=1){return dt("camFlash","flash"),qr(e,t)}function Tr(e=[]){let t=new Map,n=[],s={},r=new $e,i=[],a=new Set("*"),o=Wi.globalOpt.tagsAsComponents,l=null,h=!1,u={id:St(),hidden:!1,transform:new v,children:[],parent:null,set paused(e){if(e!==h){h=e;for(let t of i)t.paused=e}},get paused(){return h},get tags(){return Array.from(a)},add(e){let t=Array.isArray(e)?Tr(e):e;if(t.parent)throw new Error("Cannot add a game obj that already has a parent.");return t.parent=this,t.transform=nn(t),this.children.push(t),t.trigger("add",t),Wi.game.events.trigger("add",t),t},readd(e){let t=this.children.indexOf(e);return-1!==t&&(this.children.splice(t,1),this.children.push(e)),e},remove(e){let t=this.children.indexOf(e);if(-1!==t){e.parent=null,this.children.splice(t,1);let n=e=>{e.trigger("destroy"),Wi.game.events.trigger("destroy",e),e.children.forEach((e=>n(e)))};n(e)}},removeAll(e){if(e)this.get(e).forEach((e=>this.remove(e)));else for(let e of[...this.children])this.remove(e)},fixedUpdate(){this.paused||(this.children.forEach((e=>e.fixedUpdate())),this.trigger("fixedUpdate"))},update(){this.paused||(this.children.forEach((e=>e.update())),this.trigger("update"))},draw(){if(this.hidden)return;this.canvas&&(pn(),this.canvas.bind());let e=Wi.gfx.fixed;this.fixed&&(Wi.gfx.fixed=!0),hn(),ln(this.pos),dn(this.scale),cn(this.angle);let t=this.children.sort(((e,t)=>(e.layerIndex??Wi.game.defaultLayerIndex)-(t.layerIndex??Wi.game.defaultLayerIndex)||(e.z??0)-(t.z??0)));if(this.mask){let e={intersect:Wi.k.drawMasked,subtract:Wi.k.drawSubtracted}[this.mask];if(!e)throw new Error(`Invalid mask func: "${this.mask}"`);e((()=>{t.forEach((e=>e.draw()))}),(()=>{this.trigger("draw")}))}else this.trigger("draw"),t.forEach((e=>e.draw()));fn(),Wi.gfx.fixed=e,this.canvas&&(pn(),this.canvas.unbind())},drawInspect(){this.hidden||(hn(),ln(this.pos),dn(this.scale),cn(this.angle),this.children.forEach((e=>e.drawInspect())),this.trigger("drawInspect"),fn())},use(e){if("string"==typeof e)return a.add(e);if(!e||"object"!=typeof e)throw new Error(`You can only pass a component or a string to .use(), you passed a "${typeof e}"`);let r=[];e.id?(this.unuse(e.id),s[e.id]=[],r=s[e.id],t.set(e.id,e),o&&a.add(e.id)):n.push(e);for(let n in e){if(Qe.has(n))continue;let s=Object.getOwnPropertyDescriptor(e,n);if(s)if("function"==typeof s.value&&(e[n]=e[n].bind(this)),s.set&&Object.defineProperty(e,n,{set:s.set.bind(this)}),s.get&&Object.defineProperty(e,n,{get:s.get.bind(this)}),We.has(n)){let t="add"===n?()=>{l=e=>r.push(e),e[n]?.(),l=null}:e[n];r.push(this.on(n,t).cancel)}else{if(void 0!==this[n]){let s=t.values().find((e=>void 0!==e[n]))?.id;throw new Error(`Duplicate component property: "${n}" while adding component "${e.id}"`+(s?` (originally added by "${s}")`:""))}Object.defineProperty(this,n,{get:()=>e[n],set:t=>e[n]=t,configurable:!0,enumerable:!0}),r.push((()=>delete this[n]))}}let i=()=>{if(e.require)for(let t of e.require)if(!this.c(t))throw new Error(`Component "${e.id}" requires component "${t}"`)};e.destroy&&r.push(e.destroy.bind(this)),this.exists()?(i(),e.add&&(l=e=>r.push(e),e.add.call(this),l=null),e.id&&(this.trigger("use",e.id),Wi.game.events.trigger("use",this,e.id))):e.require&&r.push(this.on("add",i).cancel)},unuse(e){if(t.has(e)){for(let n of t.values())if(n.require&&n.require.includes(e))throw new Error(`Can't unuse. Component "${n.id}" requires component "${e}"`);t.delete(e),this.trigger("unuse",e),Wi.game.events.trigger("unuse",this,e)}else o&&a.has(e)&&a.delete(e);s[e]&&(s[e].forEach((e=>e())),delete s[e])},c:e=>t.get(e)??null,get(e,t={}){let n=(e,n)=>"comps"===t.only?e.has(n):"tags"===t.only?e.is(n):e.is(n)||e.has(n),s=t.recursive?this.children.flatMap((function e(t){return[t,...t.children.flatMap(e)]})):this.children;if(s=s.filter((t=>!e||n(t,e))),t.liveUpdate){let r=e=>t.recursive?this.isAncestorOf(e):e.parent===this,i=[];i.push(Wi.k.onAdd((t=>{r(t)&&n(t,e)&&s.push(t)}))),i.push(Wi.k.onDestroy((t=>{if(r(t)&&n(t,e)){let e=s.findIndex((e=>e.id===t.id));-1!==e&&s.splice(e,1)}}))),this.onDestroy((()=>{for(let e of i)e.cancel()}))}return s},query(e){let t=e.hierarchy||"children",n=e.include,s=e.exclude,r=[];switch(t){case"children":r=this.children;break;case"siblings":r=this.parent?this.parent.children.filter((e=>e!==this)):[];break;case"ancestors":let e=this.parent;for(;e;)r.push(e),e=e.parent;break;case"descendants":r=this.children.flatMap((function e(t){return[t,...t.children.flatMap(e)]}));break}if(n&&(r="and"!==(e.includeOp||"and")&&Array.isArray(e.include)?r.filter((t=>e.include.some((e=>t.is(e))))):r.filter((e=>e.is(n)))),s&&(r="and"!==(e.includeOp||"and")&&Array.isArray(e.include)?r.filter((t=>!e.exclude.some((e=>t.is(e))))):r.filter((e=>!e.is(s)))),!0===e.visible&&(r=r.filter((e=>e.visible))),e.distance){if(!this.pos)throw Error("Can't do a distance query from an object without pos");let t=e.distanceOp||"near",n=e.distance*e.distance;r="near"===t?r.filter((e=>e.pos&&this.pos.sdist(e.pos)<=n)):r.filter((e=>e.pos&&this.pos.sdist(e.pos)>n))}return e.name&&(r=r.filter((t=>t.name===e.name))),r},isAncestorOf(e){return!!e.parent&&(e.parent===this||this.isAncestorOf(e.parent))},exists(){return Wi.game.root.isAncestorOf(this)},is:(e,t="and")=>Array.isArray(e)?"and"===t?e.every((e=>a.has(e))):e.some((e=>a.has(e))):a.has(e),tag(e){if(Array.isArray(e))for(let t of e)a.add(t),this.trigger("tag",t),Wi.game.events.trigger("tag",this,t);else a.add(e),this.trigger("tag",e),Wi.game.events.trigger("tag",this,e)},untag(e){if(Array.isArray(e))for(let t of e)a.delete(t),this.trigger("untag",t),Wi.game.events.trigger("untag",this,t);else a.delete(e),this.trigger("untag",e),Wi.game.events.trigger("untag",this,e)},has:(e,n="and")=>Array.isArray(e)?"and"===n?e.every((e=>t.has(e))):e.some((e=>t.has(e))):t.has(e),on(e,t){let n=r.on(e,t.bind(this));return l&&l((()=>n.cancel())),n},trigger(e,...t){r.trigger(e,...t),Wi.game.objEvents.trigger(e,this,...t)},destroy(){this.parent&&this.parent.remove(this)},inspect(){let e={};for(let[n,s]of t)e[n]=s.inspect?.()??null;for(let[t,s]of n.entries())if(s.inspect)e[t]=s.inspect();else for(let[t,n]of Object.entries(s))"function"!=typeof n&&(e[t]=`${t}: ${n}`);return e},onAdd(e){return this.on("add",e)},onFixedUpdate(e){return this.on("fixedUpdate",e)},onUpdate(e){return this.on("update",e)},onDraw(e){return this.on("draw",e)},onDestroy(e){return this.on("destroy",e)},onUse(e){return this.on("use",e)},onUnuse(e){return this.on("unuse",e)},clearEvents(){r.clear()}},d=["onKeyPress","onKeyPressRepeat","onKeyDown","onKeyRelease","onMousePress","onMouseDown","onMouseRelease","onMouseMove","onCharInput","onMouseMove","onTouchStart","onTouchMove","onTouchEnd","onScroll","onGamepadButtonPress","onGamepadButtonDown","onGamepadButtonRelease","onGamepadStick","onButtonPress","onButtonDown","onButtonRelease"];for(let e of d)u[e]=(...t)=>{let n=Wi.app[e]?.(...t);return i.push(n),u.onDestroy((()=>n.cancel())),u.on("sceneEnter",(()=>{i.splice(i.indexOf(n),1);let s=Wi.app[e]?.(...t);Je.replace(n,s),i.push(n)})),n};for(let t of e)u.use(t);return u}function Dr(e){Wi.game.gravity=e?(Wi.game.gravity||m(0,1)).unit().scale(e):null}function Or(){return Wi.game.gravity?Wi.game.gravity.len():0}function Ur(e){Wi.game.gravity=e.unit().scale(Wi.game.gravity?Wi.game.gravity.len():1)}function Lr(){return Wi.game.gravity?Wi.game.gravity.unit():m(0,1)}var Nr=r("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");function Hr(e,t={}){let n=new _e,s=new Audio(e);function r(){Wi.debug.paused||Wi.app.isHidden()&&!Wi.globalOpt.backgroundAudio||Wi.audio.ctx.resume(),s.play()}return s.crossOrigin="anonymous",s.loop=!!t.loop,Wi.audio.ctx.createMediaElementSource(s).connect(Wi.audio.masterNode),t.paused||r(),s.onended=()=>n.trigger(),{play(){r()},seek(e){s.currentTime=e},stop(){s.pause(),this.seek(0)},set loop(e){s.loop=e},get loop(){return s.loop},set paused(e){e?s.pause():r()},get paused(){return s.paused},time:()=>s.currentTime,duration:()=>s.duration,set volume(e){s.volume=a(e,0,1)},get volume(){return s.volume},set speed(e){s.playbackRate=Math.max(e,0)},get speed(){return s.playbackRate},set detune(e){},get detune(){return 0},onEnd:e=>n.add(e),then(e){return this.onEnd(e)}}}function jr(e,t={}){if("string"==typeof e&&Wi.assets.music[e])return Hr(Wi.assets.music[e],t);let n=Wi.audio.ctx,s=t.paused??!1,r=n.createBufferSource(),i=new _e,a=n.createGain(),o=n.createStereoPanner(),l=t.seek??0,h=0,u=0,d=!1;r.loop=!!t.loop,r.detune.value=t.detune??0,r.playbackRate.value=t.speed??1,r.connect(o),r.onended=()=>{f()>=(r.buffer?.duration??Number.POSITIVE_INFINITY)&&i.trigger()},o.pan.value=t.pan??0,o.connect(a),a.connect(Wi.audio.masterNode),a.gain.value=t.volume??1;let c=function(e){if("string"==typeof e){let t=_n(e);if(t)return t;if(Rn()<1)return null;throw new Error(`Sound not found: ${e}`)}if(e instanceof Jn)return vn.loaded(e);if(e instanceof vn)return e;throw new Error(`Invalid sound: ${e}`)}(e);c instanceof vn&&c.onLoad((e=>{r.buffer=e.buf,s||(h=n.currentTime,r.start(0,l),d=!0)}));let f=()=>{if(!r.buffer)return 0;let e=s?u-h:n.currentTime-h,t=r.buffer.duration;return r.loop?e%t:Math.min(e,t)},p=e=>{let t=n.createBufferSource();return t.buffer=e.buffer,t.loop=e.loop,t.playbackRate.value=e.playbackRate.value,t.detune.value=e.detune.value,t.onended=e.onended,t.connect(o),t};return{stop(){this.paused=!0,this.seek(0)},set paused(e){if(s!==e)if(s=e,e)d&&(r.stop(),d=!1),u=n.currentTime;else{r=p(r);let e=u-h;r.start(0,e),d=!0,h=n.currentTime-e,u=0}},get paused(){return s},play(e=0){this.seek(e),this.paused=!1},seek(e){r.buffer?.duration&&(e>r.buffer.duration||(s?(r=p(r),h=u-e):(r.stop(),r=p(r),h=n.currentTime-e,r.start(0,e),d=!0,u=0)))},set speed(e){r.playbackRate.value=e},get speed(){return r.playbackRate.value},set detune(e){r.detune.value=e},get detune(){return r.detune.value},set volume(e){a.gain.value=Math.max(e,0)},get volume(){return a.gain.value},set pan(e){o.pan.value=e},get pan(){return o.pan.value},set loop(e){r.loop=e},get loop(){return r.loop},duration:()=>r.buffer?.duration??0,time(){return f()%this.duration()},onEnd:e=>i.add(e),then(e){return this.onEnd(e)}}}function Gr(e){return Wi.k.play(Wi.audio.burpSnd,e)}function Vr(e){Wi.audio.masterNode.gain.value=e}function Kr(){return Wi.audio.masterNode.gain.value}function Yr(e){return dt("volume","setVolume / getVolume"),void 0!==e&&Vr(e),Kr()}function Xr(){Wi.app.onHide((()=>{Wi.globalOpt.backgroundAudio||Wi.audio.ctx.suspend()})),Wi.app.onShow((()=>{!Wi.globalOpt.backgroundAudio&&!Wi.debug.paused&&Wi.audio.ctx.resume()})),Wi.app.onResize((()=>{if(Wi.app.isFullscreen())return;let e=Wi.globalOpt.width&&Wi.globalOpt.height;e&&!Wi.globalOpt.stretch&&!Wi.globalOpt.letterbox||(Wi.canvas.width=Wi.canvas.offsetWidth*Wi.pixelDensity,Wi.canvas.height=Wi.canvas.offsetHeight*Wi.pixelDensity,Bt(),e||(Wi.gfx.frameBuffer.free(),Wi.gfx.frameBuffer=new ds(Wi.gfx.ggl,Wi.gfx.ggl.gl.drawingBufferWidth,Wi.gfx.ggl.gl.drawingBufferHeight),Wi.gfx.width=Wi.gfx.ggl.gl.drawingBufferWidth/Wi.pixelDensity/Wi.gscale,Wi.gfx.height=Wi.gfx.ggl.gl.drawingBufferHeight/Wi.pixelDensity/Wi.gscale))})),!1!==Wi.globalOpt.debug&&(Wi.app.onKeyPress(Wi.globalOpt.debugKey??"f1",(()=>Wi.debug.inspect=!Wi.debug.inspect)),Wi.app.onKeyPress("f2",(()=>Wi.debug.clearLog())),Wi.app.onKeyPress("f8",(()=>Wi.debug.paused=!Wi.debug.paused)),Wi.app.onKeyPress("f7",(()=>{Wi.debug.timeScale=ct(a(Wi.debug.timeScale-.2,0,2),1)})),Wi.app.onKeyPress("f9",(()=>{Wi.debug.timeScale=ct(a(Wi.debug.timeScale+.2,0,2),1)})),Wi.app.onKeyPress("f10",(()=>Wi.debug.stepFrame()))),Wi.globalOpt.burp&&Wi.app.onKeyPress("b",(()=>Gr()))}function Qr(e,t={}){let n=Wi.game.root.add([Vi(e),Mi()]),s=5*(t.speed||1),r=t.scale||1;n.add([ri(Wi.boomSprite),Yi(0),Ui("center"),Ai(s,r),...t.comps??[]]);let i=n.add([ri(Wi.kaSprite),Yi(0),Ui("center"),Si(),...t.comps??[]]);return i.wait(.4/s,(()=>i.use(Ai(s,r)))),i.onDestroy((()=>n.destroy())),n}function Wr(e,t){if(Wi.game.layers)throw Error("Layers can only be assigned once.");let n=e.indexOf(t);if(-1==n)throw Error("The default layer name should be present in the layers list.");Wi.game.layers=e,Wi.game.defaultLayerIndex=n}function zr(){return Wi.game.layers}function Zr(){return Wi.game.layers?.[Wi.game.defaultLayerIndex]??null}function Jr(e,t){dt("layers","setLayers"),Wr(e,t)}function _r(e){e.destroy()}function $r(){return Wi.game.root}function ei(e,t){Wi.game.scenes[e]=t}function ti(e,...t){if(!Wi.game.scenes[e])throw new Error(`Scene not found: ${e}`);Wi.game.events.onOnce("frameEnd",(()=>{Wi.game.events.trigger("sceneLeave",e),Wi.app.events.clear(),Wi.game.events.clear(),Wi.game.objEvents.clear(),[...Wi.game.root.children].forEach((t=>{!t.stay||t.scenesToStay&&!t.scenesToStay.includes(e)?Wi.game.root.remove(t):t.trigger("sceneEnter",e)})),Wi.game.root.clearEvents(),Xr(),Wi.game.cam={pos:null,scale:m(1),angle:0,shake:0,transform:new v},Wi.game.scenes[e](...t)})),Wi.game.currentScene=e}function ni(e){return Wi.game.events.on("sceneLeave",e)}function si(){return Wi.game.currentScene}function ri(e,t={}){let n=null,s=null,r=null,i=new _e;if(!e)throw new Error("Please pass the resource name or data to sprite()");let a=(e,s)=>{if(!s)return;let r=s.frames[0].clone();t.quad&&(r=r.scale(t.quad));let a=((e,t,n,s)=>{let r=m(1,1);return n&&s?(r.x=n/(e.width*t.w),r.y=s/(e.height*t.h)):n?(r.x=n/(e.width*t.w),r.y=r.x):s&&(r.y=s/(e.height*t.h),r.x=r.y),r})(s.tex,r,t.width,t.height);if(e.width=s.tex.width*r.w*a.x,e.height=s.tex.height*r.h*a.y,s.anims)for(let e in s.anims){let t=s.anims[e];"number"!=typeof t&&(t.frames=o(t))}n=s,i.trigger(n),t.anim&&e.play(t.anim)},o=e=>{if(e.frames)return e.frames;let t=[];if(void 0===e.from||void 0===e.to)throw new Error("Sprite anim 'from' and 'to' must be defined if 'frames' is not defined");let n=Math.abs(e.to-e.from)+1;for(let s=0;s<n;s++)t.push(e.from+s*Math.sign(e.to-e.from));if(e.pingpong)for(let e=n-2;e>0;e--)t.push(t[e]);return t};return{id:"sprite",width:0,height:0,frame:t.frame||0,quad:t.quad||new w(0,0,1,1),animSpeed:t.animSpeed??1,flipX:t.flipX??!1,flipY:t.flipY??!1,get sprite(){return e.toString()},set sprite(e){let t=Fn(e);t&&t.onLoad((e=>a(this,e)))},get animFrame(){if(!n||!s||null===r)return this.frame;let e=n.anims[s.name];return"number"==typeof e?e:void 0===e.from||void 0===e.to?s.frameIndex:this.frame-Math.min(e.from,e.to)},draw(){if(!n)return;let e=n.frames[this.frame??0];if(!e)throw new Error(`Frame not found: ${this.frame??0}`);if(n.slice9){let{left:s,right:r,top:i,bottom:a}=n.slice9,o=n.tex.width*e.w,l=n.tex.height*e.h,h=this.width-s-r,u=this.height-i-a,d=s/o,c=r/o,f=1-d-c,p=i/l,g=a/l,m=1-p-g,w=[y(0,0,d,p),y(d,0,f,p),y(d+f,0,c,p),y(0,p,d,m),y(d,p,f,m),y(d+f,p,c,m),y(0,p+m,d,g),y(d,p+m,f,g),y(d+f,p+m,c,g),y(0,0,s,i),y(s,0,h,i),y(s+h,0,r,i),y(0,i,s,u),y(s,i,h,u),y(s+h,i,r,u),y(0,i+u,s,a),y(s,i+u,h,a),y(s+h,i+u,r,a)];for(let s=0;s<9;s++){let r=w[s],i=w[s+9];Bs(Object.assign(Fs(this),{pos:i.pos(),tex:n.tex,quad:e.scale(r),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:i.w,height:i.h}))}}else Bs(Object.assign(Fs(this),{tex:n.tex,quad:e.scale(this.quad??new w(0,0,1,1)),flipX:this.flipX,flipY:this.flipY,tiled:t.tiled,width:this.width,height:this.height}))},add(){let t=Fn(e);t?t.onLoad((e=>a(this,e))):mr((()=>a(this,Fn(e).data)))},update(){if(!n||!s||null===r)return;let e=n.anims[s.name];if("number"!=typeof e){if(0===e.speed)throw new Error("Sprite anim speed cannot be 0");if(s.timer+=Dt()*this.animSpeed,s.timer>=1/s.speed){s.timer=0,s.frameIndex+=r;let t=e.frames;if(s.frameIndex>=t.length)if(s.pingpong&&!e.pingpong)r=-1,s.frameIndex=t.length-2;else{if(!s.loop)return this.frame=t.at(-1),s.onEnd(),void this.stop();s.frameIndex=0}else if(s.frameIndex<0)if(s.pingpong&&s.loop)r=1,s.frameIndex=1;else{if(!s.loop)return this.frame=t[0],s.onEnd(),void this.stop();s.frameIndex=t.length-1}this.frame=t[s.frameIndex]}}else this.frame=e},play(e,t={}){if(!n)return void i.add((()=>this.play(e,t)));let a=n.anims[e];if(void 0===a)throw new Error(`Anim not found: ${e}`);s&&this.stop(),s="number"==typeof a?{name:e,timer:0,loop:!1,pingpong:!1,speed:0,frameIndex:0,onEnd:()=>{}}:{name:e,timer:0,loop:t.loop??a.loop??!1,pingpong:t.pingpong??a.pingpong??!1,speed:t.speed??a.speed??10,frameIndex:0,onEnd:t.onEnd??(()=>{})},r="number"==typeof a?null:1,this.frame="number"==typeof a?a:a.frames[0],this.trigger("animStart",e)},stop(){if(!s)return;let e=s.name;s=null,this.trigger("animEnd",e)},numFrames:()=>n?.frames.length??0,getCurAnim:()=>s,curAnim:()=>s?.name,getAnim:e=>n?.anims[e]??null,hasAnim(e){return!!this.getAnim(e)},onAnimEnd(e){return this.on("animEnd",e)},onAnimStart(e){return this.on("animStart",e)},renderArea(){return new ne(m(0),this.width,this.height)},inspect:()=>"string"==typeof e?`sprite: "${e}"`:null}}function ii(e,t={}){function n(e){let n=ms(Object.assign(Fs(e),{text:e.text+"",size:e.textSize,font:e.font,width:t.width&&e.width,align:e.align,letterSpacing:e.letterSpacing,lineSpacing:e.lineSpacing,transform:e.textTransform,styles:e.textStyles,indentAll:t.indentAll}));return t.width||(e.width=n.width/(e.scale?.x||1)),e.height=n.height/(e.scale?.y||1),n}let s={id:"text",set text(t){e=t,n(this),this.renderedText=gs(e).text},get text(){return e},textSize:t.size??36,font:t.font,width:t.width??0,height:0,align:t.align,lineSpacing:t.lineSpacing,letterSpacing:t.letterSpacing,textTransform:t.transform,textStyles:t.styles,renderedText:e?gs(e).text:"",add(){mr((()=>n(this)))},draw(){ys(n(this))},renderArea(){return new ne(m(0),this.width,this.height)}};return n(s),s}function ai(e,t){return{id:"rect",width:e,height:t,draw(){ws(Object.assign(Fs(this),{width:this.width,height:this.height}))},renderArea(){return new ne(m(0),this.width,this.height)},inspect(){return`uvquad: (${Math.ceil(this.width)}w, ${Math.ceil(this.height)})h`}}}function oi(e={}){let t=null,n=null,s=null,r=null;return{id:"agent",require:["pos","tile"],agentSpeed:e.speed??100,allowDiagonals:e.allowDiagonals??!0,getDistanceToTarget(){return t?this.pos.dist(t):0},getNextLocation:()=>n&&s?n[s]:null,getPath:()=>n?n.slice():null,getTarget:()=>t,isNavigationFinished:()=>!n||null===s,isTargetReachable:()=>null!==n,isTargetReached(){return!t||this.pos.eq(t)},setTarget(e){t=e,n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),s=n?0:null,n&&null!==s?(r||(r=this.getLevel().onNavigationMapChanged((()=>{t&&n&&null!==s&&(n=this.getLevel().getPath(this.pos,t,{allowDiagonals:this.allowDiagonals}),n?(s=0,this.trigger("navigationNext",this,n[s])):(s=null,this.trigger("navigationEnded",this)))})),this.onDestroy((()=>r?.cancel()))),this.trigger("navigationStarted",this),this.trigger("navigationNext",this,n[s])):this.trigger("navigationEnded",this)},update(){if(t&&n&&null!==s){if(this.pos.sdist(n[s])<2){if(s===n.length-1)return this.pos=t.clone(),s=null,this.trigger("navigationEnded",this),void this.trigger("targetReached",this);s++,this.trigger("navigationNext",this,n[s])}this.moveTo(n[s],this.agentSpeed)}},onNavigationStarted(e){return this.on("navigationStarted",e)},onNavigationNext(e){return this.on("navigationNext",e)},onNavigationEnded(e){return this.on("navigationEnded",e)},onTargetReached(e){return this.on("targetReached",e)},inspect:()=>"agent: "+JSON.stringify({target:JSON.stringify(t),path:JSON.stringify(n)})}}function li(e){let t=e.graph;return{id:"pathfinder",require:["pos"],navigateTo(t){return this.graph?.getWaypointPath(this.pos,t,e.navigationOpt)},get graph(){if(t)return t;let e=this.parent;for(;e;){if(e.has("pathfinderMap"))return e.graph;e=e.parent}},set graph(e){t=e}}}function hi(e={}){let t=e.waypoints,n=e.speed||100,s=e.endBehavior||"stop",r=0,i=null!=t;return{id:"patrol",require:["pos"],get patrolSpeed(){return n},set patrolSpeed(e){n=e},get waypoints(){return t},set waypoints(e){t=e,r=0,i=!1},get nextLocation(){return t?t[r]:void 0},update(){let e=this.nextLocation;if(t&&e&&!i&&(this.moveTo(e,n),this.pos.sdist(e)<9))switch(s){case"loop":r=(r+1)%t.length;break;case"ping-pong":r+=1,r==t.length&&(t.reverse(),r=0);break;case"stop":r=Math.min(r+1,t.length-1),r==t.length-1&&(i=!0,this.trigger("patrolFinished"));break}},onPatrolFinished(e){return this.on("patrolFinished",e)}}}function ui(e,t={}){let n="function"==typeof e?e:()=>Wi.game.root.query(e),s=t.checkFrequency||1,r="number"==typeof t.direction?g.fromAngle(t.direction):t.direction,i=0;return{id:"sentry",require:["pos"],direction:"number"==typeof t.direction?g.fromAngle(t.direction):t.direction,spotted:[],set directionAngle(e){this.direction=void 0!==e?g.fromAngle(e):void 0},get directionAngle(){return this.direction?this.direction.angle():void 0},fieldOfView:t.fieldOfView||200,isWithinFieldOfView(e,n,s){let i=("number"==typeof n?g.fromAngle(n):n)||r,a=s||t.fieldOfView;if(!i||!a||a>=360)return!0;let o=a/2;return e.pos&&i.angleBetween(e.pos.sub(this.pos))<=o},hasLineOfSight(e){let n=Ks(this.pos,e.pos.sub(this.pos),t.raycastExclude);return null!=n&&n.object===e},update(){if(i+=Dt(),i>s){i-=s;let e=n();if(e.length&&r&&this.fieldOfView&&this.fieldOfView<360){let t=this.fieldOfView/2;e=e.filter((e=>e.pos&&r.angleBetween(e.pos.sub(this.pos))<=t))}e.length&&t.lineOfSight&&(e=e.filter((e=>e.pos&&this.hasLineOfSight(e)))),e.length>0&&(this.spotted=e,this.trigger("objectSpotted",e))}},onObjectsSpotted(e){return this.on("objectSpotted",e)}}}function di(e={}){let t=m(0),n=e.isObstacle??!1,s=e.cost??0,r=e.edges??[],i=()=>{let e={left:1,top:2,right:4,bottom:8};return r.map((t=>e[t]||0)).reduce(((e,t)=>e|t),0)},a=i();return{id:"tile",tilePosOffset:e.offset??m(0),set tilePos(e){let n=this.getLevel();t=e.clone(),this.pos=m(this.tilePos.x*n.tileWidth(),this.tilePos.y*n.tileHeight()).add(this.tilePosOffset)},get tilePos(){return t},set isObstacle(e){n!==e&&(n=e,this.getLevel().invalidateNavigationMap())},get isObstacle(){return n},set cost(e){s!==e&&(s=e,this.getLevel().invalidateNavigationMap())},get cost(){return s},set edges(e){r=e,a=i(),this.getLevel().invalidateNavigationMap()},get edges(){return r},get edgeMask(){return a},getLevel(){return this.parent},tileMove(e){let t=this.getLevel();t.removeFromSpatialMap(this),this.tilePos=this.tilePos.add(e),t.insertIntoSpatialMap(this),t.trigger("spatialMapChanged")},moveLeft(){this.tileMove(m(-1,0))},moveRight(){this.tileMove(m(1,0))},moveUp(){this.tileMove(m(0,-1))},moveDown(){this.tileMove(m(0,1))}}}var ci=class{name;duration;loops;direction;easing;interpolation;isFinished;timing;easings;relative;constructor(e,t,n){this.name=e,this.duration=t.duration,this.loops=t.loops||0,this.direction=t.direction||"forward",this.easing=t.easing||en.linear,this.interpolation=t.interpolation||"linear",this.isFinished=!1,this.timing=t.timing,this.easings=t.easings,this.relative=n}update(e,t){return!0}getLowerKeyIndexAndRelativeTime(e,t,n){let s=t-1,r=e/this.duration;if(0!==this.loops&&r>=this.loops)return[s,0,!0];let i=Math.trunc(r);if(r-=i,("reverse"==this.direction||"ping-pong"==this.direction&&1&i)&&(r=1-r),n){let e=0;for(;void 0!==n[e+1]&&n[e+1]<r;)e++;return e>=s?[s,0,!0]:[e,(r-n[e])/(n[e+1]-n[e]),!1]}{let e=Math.floor((t-1)*r);return[e,(r-e/s)*s,!1]}}setValue(e,t,n){if(this.relative)switch(t){case"pos":e.pos=e.base.pos.add(n);break;case"angle":e.angle=e.base.angle+n;break;case"scale":e.scale=e.base.scale.scale(n);break;case"opacity":e.opacity=e.base.opacity*n;break;default:e[t]=n}else e[t]=n}serialize(){let e={duration:this.duration,keys:[]};return this.loops&&(e.loops=this.loops),"forward"!==this.direction&&(e.direction=this.direction),this.easing!=en.linear&&(e.easing=this.easing.name),"linear"!==this.interpolation&&(e.interpolation=this.interpolation),this.timing&&(e.timing=this.timing),this.easings&&(e.easings=this.easings.map((e=>this.easing.name))),e}};function fi(e,t){return t.add(t.sub(e))}var pi=class extends ci{keys;constructor(e,t,n,s){super(e,n,s),this.keys=t}update(e,t){let[n,s,r]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(0==s||"none"===this.interpolation)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,c(this.keys[n],this.keys[n+1],t(s)))}return r}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}},gi=class extends ci{keys;curves;dcurves;constructor(e,t,n,s,r){if(super(e,n,s),this.keys=t,"spline"===this.interpolation){this.curves=[],r&&(this.dcurves=[]);for(let e=0;e<this.keys.length-1;e++){let t=this.keys[e],n=e+1,s=this.keys[n],i=e>0?this.keys[e-1]:fi(s,t),a=n<this.keys.length-1?this.keys[n+1]:fi(t,s);this.curves.push(ye(i,t,s,a)),r&&this.dcurves?.push(ye(i,t,s,a,ve))}}}update(e,t){let[n,s,r]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(0==s||"none"===this.interpolation)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;switch(this.interpolation){case"linear":this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],t(s)));break;case"slerp":this.setValue(e,this.name,this.keys[n].slerp(this.keys[n+1],t(s)));break;case"spline":if(this.curves){this.setValue(e,this.name,this.curves[n](t(s))),this.dcurves&&this.setValue(e,"angle",this.dcurves[n](t(s)).angle());break}}}return r}serialize(){return Object.assign(super.serialize(),{keys:this.keys.map((e=>[e.x,e.y]))})}},mi=class extends ci{keys;constructor(e,t,n,s){super(e,n,s),this.keys=t}update(e,t){let[n,s,r]=this.getLowerKeyIndexAndRelativeTime(t,this.keys.length,this.timing);if(0==s||"none"==this.interpolation)this.setValue(e,this.name,this.keys[n]);else{let t=this.easings?this.easings[n]:this.easing;this.setValue(e,this.name,this.keys[n].lerp(this.keys[n+1],t(s)))}return r}serialize(){return Object.assign(super.serialize(),{keys:this.keys})}};function wi(e={}){let t=[],n=0,s=!1;return{id:"animate",require:e.followMotion?["rotate"]:void 0,base:{pos:m(0,0),angle:0,scale:m(1,1),opacity:1},animation:{paused:!1,seek(e){n=a(e,0,this.duration),t.forEach((e=>{e.isFinished=!1})),s=!1},get duration(){return t.reduce(((e,t)=>Math.max(t.duration,e)),0)}},add(){e.relative&&(this.has("pos")&&(this.base.pos=this.pos.clone()),this.has("rotate")&&(this.base.angle=this.angle),this.has("scale")&&(this.base.scale=this.scale),this.has("opacity")&&(this.base.opacity=this.opacity))},update(){if(this.animation.paused)return;let e,r=!0;n+=Dt();for(let s of t)e=s.update(this,n),e&&!s.isFinished&&(s.isFinished=!0,this.trigger("animateChannelFinished",s.name)),r&&=e;r&&!s&&(s=!0,this.trigger("animateFinished"))},animate(n,r,i){s=!1,this.unanimate(n),"number"==typeof r[0]?t.push(new pi(n,r,i,e.relative||!1)):r[0]instanceof g?t.push(new gi(n,r,i,e.relative||!1,"pos"===n&&(e.followMotion||!1))):r[0]instanceof o&&t.push(new mi(n,r,i,e.relative||!1))},unanimate(e){let n=t.findIndex((t=>t.name===e));n>=0&&t.splice(n,1)},unanimateAll(){t.splice(0,t.length)},onAnimateFinished(e){return this.on("animateFinished",e)},onAnimateChannelFinished(e){return this.on("animateChannelFinished",e)},serializeAnimationChannels:()=>t.reduce(((e,t)=>(e[t.name]=t.serialize(),e)),{}),serializeAnimationOptions(){let t={};return e.followMotion&&(t.followMotion=!0),e.relative&&(t.relative=!0),t}}}function yi(e,t){let n={name:e.name};return e.has("animate")&&(n.channels=e.serializeAnimationChannels(),Object.assign(n,e.serializeAnimationOptions())),e.children.length>0&&(n.children=e.children.filter((e=>e.has("named"))).map((e=>yi(e,e.name)))),n}function Ai(e=2,t=1){let n=0;return{require:["scale"],update(){let s=Math.sin(n*e)*t;s<0&&this.destroy(),this.scale=m(s),n+=Dt()}}}function xi(e,t){if(null==e)throw new Error("health() requires the initial amount of hp");return{id:"health",hurt(t=1){this.setHP(e-t),this.trigger("hurt",t)},heal(t=1){let n=e;this.setHP(e+t),this.trigger("heal",e-n)},hp:()=>e,maxHP:()=>t??null,setMaxHP(e){t=e},setHP(n){(e=t?Math.min(t,n):n)<=0&&this.trigger("death")},onHurt(e){return this.on("hurt",e)},onHeal(e){return this.on("heal",e)},onDeath(e){return this.on("death",e)},inspect:()=>`health: ${e}`}}function vi(e,t={}){if(null==e)throw new Error("lifespan() requires time");let n=t.fade??0;return{id:"lifespan",require:["opacity"],add(){Wi.game.root.wait(e,(()=>{this.opacity=this.opacity??1,n>0?Wi.game.root.tween(this.opacity,0,n,(e=>this.opacity=e),en.linear).onEnd((()=>{this.destroy()})):this.destroy()}))}}}function bi(e){return{id:"named",name:e}}function Ei(e,t,n){if(!e)throw new Error("state() requires an initial state");let s={};function r(e){s[e]||(s[e]={enter:new _e,end:new _e,update:new _e,draw:new _e})}function i(e,t,n){return r(t),s[t][e].add(n)}function a(e,t,...n){r(t),s[t][e].trigger(...n)}let o=!1;return{id:"state",state:e,enterState(e,...s){if(o=!0,t&&!t.includes(e))throw new Error(`State not found: ${e}`);let r=this.state;if(n){if(!n?.[r])return;let t="string"==typeof n[r]?[n[r]]:n[r];if(!t.includes(e))throw new Error(`Cannot transition state from "${r}" to "${e}". Available transitions: ${t.map((e=>`"${e}"`)).join(", ")}`)}a("end",r,...s),this.state=e,a("enter",e,...s),a("enter",`${r} -> ${e}`,...s)},onStateTransition:(e,t,n)=>i("enter",`${e} -> ${t}`,n),onStateEnter:(e,t)=>i("enter",e,t),onStateUpdate:(e,t)=>i("update",e,t),onStateDraw:(e,t)=>i("draw",e,t),onStateEnd:(e,t)=>i("end",e,t),update(){o||(a("enter",e),o=!0),a("update",this.state)},draw(){a("draw",this.state)},inspect(){return`state: ${this.state}`}}}function Mi(e){return{id:"stay",stay:!0,scenesToStay:e}}function qi(e=!0,t){let n,s;return{id:"textInput",hasFocus:e,require:["text"],typedText:"",add(){let e=()=>{this.text=this.typedText.replace(/([\[\\])/g,"\\$1")};n=Wi.k.onCharInput((n=>{this.hasFocus&&(!t||this.typedText.length<t)&&(Wi.k.isKeyDown("shift")?this.typedText+=n.toUpperCase():this.typedText+=n,e())})),s=Wi.k.onKeyPressRepeat("backspace",(()=>{this.hasFocus&&(this.typedText=this.typedText.slice(0,-1)),e()}))},destroy(){n.cancel(),s.cancel()}}}function Si(e=1e3){return{id:"timer",maxLoopsPerFrame:e,loop(e,t,n=1/0,s=!1){let r=s?0:e,i=new _e,a=this.onUpdate((()=>{r+=Wi.app.state.dt;for(let s=0;r>=e&&s<this.maxLoopsPerFrame;s++)if(n--,t(),r-=e,n<=0)return a.cancel(),void i.trigger()}));return{get paused(){return a.paused},set paused(e){a.paused=e},cancel:a.cancel,onEnd(e){i.add(e)},then(e){return i.add(e),this}}},wait(e,t){return this.loop(e,t??(()=>{}),1,!0)},tween(e,t,n,s,r=en.linear){let i=0,a=[],o=this.onUpdate((()=>{i+=Wi.app.state.dt;let l=Math.min(i/n,1);s(c(e,t,r(l))),1===l&&(o.cancel(),s(t),a.forEach((e=>e())))}));return{get paused(){return o.paused},set paused(e){o.paused=e},onEnd(e){a.push(e)},then(e){return this.onEnd(e),this},cancel(){o.cancel()},finish(){o.cancel(),s(t),a.forEach((e=>e()))}}}}}var Bi=0;function Ri(e={}){let t={},n=new Set,s=[];return{id:"area",collisionIgnore:e.collisionIgnore??[],add(){Bi++,this.area.cursor&&s.push(this.onHover((()=>Wi.app.setCursor(this.area.cursor)))),s.push(this.onCollideUpdate(((e,s)=>{if(!e.id)throw new Error("area() requires the object to have an id");t[e.id]||this.trigger("collide",e,s),s&&(t[e.id]=s,n.add(e.id))})))},destroy(){Bi--;for(let e of s)e.cancel()},fixedUpdate(){for(let e in t)n.has(Number(e))||(this.trigger("collideEnd",t[e].target),delete t[e]);n.clear()},drawInspect(){let e=this.localArea();hn(),ln(this.area.offset);let t={outline:{width:4/wn(),color:l(0,0,255)},anchor:this.anchor,fill:!1,fixed:Cs(this)};e instanceof ne?As({...t,pos:e.pos,width:e.width*this.area.scale.x,height:e.height*this.area.scale.y}):e instanceof ie?ss({...t,pts:e.pts,scale:this.area.scale}):e instanceof se&&is({...t,pos:e.center,radius:e.radius}),fn()},area:{shape:e.shape??null,scale:e.scale?m(e.scale):m(1),offset:e.offset??m(0),cursor:e.cursor??null},isClicked(){return Wi.app.isMousePressed()&&this.isHovering()},isHovering(){let e=Cs(this)?Wi.k.mousePos():Wi.k.toWorld(Wi.k.mousePos());return this.hasPoint(e)},checkCollision(e){if(!e.id)throw new Error("checkCollision() requires the object to have an id");return t[e.id]??null},getCollisions:()=>Object.values(t),isColliding(e){if(!e.id)throw new Error("isColliding() requires the object to have an id");return!!t[e.id]},isOverlapping(e){if(!e.id)throw new Error("isOverlapping() requires the object to have an id");let n=t[e.id];return n&&n.hasOverlap()},onClick(e,t="left"){let n=Wi.app.onMousePress(t,(()=>{this.isHovering()&&e()}));return s.push(n),n},onHover(e){let t=!1;return this.onUpdate((()=>{t?t=this.isHovering():this.isHovering()&&(t=!0,e())}))},onHoverUpdate(e){return this.onUpdate((()=>{this.isHovering()&&e()}))},onHoverEnd(e){let t=!1;return this.onUpdate((()=>{t?this.isHovering()||(t=!1,e()):t=this.isHovering()}))},onCollide(e,t){if("function"==typeof e&&void 0===t)return this.on("collide",e);if("string"==typeof e)return this.onCollide(((n,s)=>{n.is(e)&&t?.(n,s)}));throw new Error("onCollide() requires either a function or a tag")},onCollideUpdate(e,t){if("function"==typeof e&&void 0===t)return this.on("collideUpdate",e);if("string"==typeof e)return this.on("collideUpdate",((n,s)=>n.is(e)&&t?.(n,s)));throw new Error("onCollideUpdate() requires either a function or a tag")},onCollideEnd(e,t){if("function"==typeof e&&void 0===t)return this.on("collideEnd",e);if("string"==typeof e)return this.on("collideEnd",(n=>n.is(e)&&t?.(n)));throw new Error("onCollideEnd() requires either a function or a tag")},hasPoint(e){return Y(this.worldArea(),e)},resolveCollision(e){let t=this.checkCollision(e);t&&!t.resolved&&(this.pos=this.pos.add(t.displacement),t.resolved=!0)},localArea(){return this.area.shape?this.area.shape:this.renderArea()},worldArea(){let e=this.localArea();if(!(e instanceof ie||e instanceof ne))throw new Error("Only support polygon and rect shapes for now");let t=this.transform.clone().translate(this.area.offset).scale(m(this.area.scale??1));if(e instanceof ne){let n=Qt(this.anchor||Ue).add(1,1).scale(-.5).scale(e.width,e.height);t.translate(n)}return e.transform(t)},screenArea(){let e=this.worldArea();return Cs(this)?e:e.transform(Wi.game.cam.transform)},inspect(){return this.area.scale?.x==this.area.scale?.y?`area: ${this.area.scale?.x?.toFixed(1)}x`:`area: (${this.area.scale?.x?.toFixed(1)}x, ${this.area.scale.y?.toFixed(1)}y)`}}}function Ii(e={}){let t,n=null,s=null,r=!1,i=m(0),a=null,o=null;return{id:"body",require:["pos"],vel:m(0),drag:e.drag??0,jumpForce:e.jumpForce??640,gravityScale:e.gravityScale??1,isStatic:e.isStatic??!1,mass:e.mass??1,add(){if(a=this.pos.clone(),o=this.pos.clone(),t=this.pos.clone(),0===this.mass)throw new Error("Can't set body mass to 0");this.has("area")&&(this.onCollideUpdate(((e,t)=>{if(!t||!e.has("body")||t.resolved)return;this.trigger("beforePhysicsResolve",t);let n=t.reverse();if(e.trigger("beforePhysicsResolve",n),!(t.resolved||n.resolved||this.isStatic&&e.isStatic)){if(this.isStatic||e.isStatic){let n=!this.isStatic&&e.isStatic?t:t.reverse();n.source.pos=n.source.pos.add(n.displacement),n.source.transform=nn(n.source)}else{let n=this.mass+e.mass;this.pos=this.pos.add(t.displacement.scale(e.mass/n)),e.pos=e.pos.add(t.displacement.scale(-this.mass/n)),this.transform=nn(this),e.transform=nn(e)}t.resolved=!0,this.trigger("physicsResolve",t),e.trigger("physicsResolve",t.reverse())}})),this.onPhysicsResolve((e=>{if(Wi.game.gravity)if(e.isBottom()&&this.isFalling()){this.vel=this.vel.reject(Wi.game.gravity.unit());let t=n;n=e.target,t!=n&&(s=e.target.pos),r?r=!1:t||(this.trigger("ground",n),e.target.trigger("land",this))}else e.isTop()&&this.isJumping()&&(this.vel=this.vel.reject(Wi.game.gravity.unit()),this.trigger("headbutt",e.target),e.target.trigger("headbutted",this))})))},update(){n&&this.isColliding(n)&&n.exists()&&n.has("body")&&(s&&!n.pos.eq(s)&&!1!==e.stickToPlatform&&this.moveBy(n.pos.sub(s)),s=n.pos);let r=Ut();r&&(this.pos.x==t.x&&(this.pos.x=c(a.x,o.x,r/Ot()),t.x=this.pos.x),this.pos.y==t.y&&(this.pos.y=c(a.y,o.y,r/Ot()),t.y=this.pos.y))},fixedUpdate(){if(a&&(this.pos.x==t.x&&(this.pos.x=a.x),this.pos.y==t.y&&(this.pos.y=a.y),a=null),Wi.game.gravity&&!this.isStatic){r&&(n=null,s=null,this.trigger("fallOff"),r=!1),n&&(!this.isColliding(n)||!n.exists()||!n.has("body"))&&(r=!0);let t=this.vel.clone();this.vel=this.vel.add(Wi.game.gravity.scale(this.gravityScale*Dt()));let i=e.maxVelocity??65536;this.vel.slen()>i*i&&(this.vel=this.vel.unit().scale(i)),t.dot(Wi.game.gravity)<0&&this.vel.dot(Wi.game.gravity)>=0&&this.trigger("fall")}if(this.vel.x+=i.x*Dt(),this.vel.y+=i.y*Dt(),this.vel.x*=1-this.drag*Dt(),this.vel.y*=1-this.drag*Dt(),this.move(this.vel),Ut()){a=this.pos.clone();let e=this.vel.add(i.scale(Dt()));o=this.pos.add(e.scale(Dt())),t=this.pos.clone()}i.x=0,i.y=0},onPhysicsResolve(e){return this.on("physicsResolve",e)},onBeforePhysicsResolve(e){return this.on("beforePhysicsResolve",e)},curPlatform:()=>n,isGrounded:()=>null!==n,isFalling(){return this.vel.dot(Lr())>0},isJumping(){return this.vel.dot(Lr())<0},applyImpulse(e){this.isStatic||(this.vel=this.vel.add(e))},addForce(e){this.isStatic||(i.x+=e.x/this.mass,i.y+=e.y/this.mass)},jump(e){this.isStatic||(n=null,s=null,this.vel=Lr().scale(-e||-this.jumpForce))},onGround(e){return this.on("ground",e)},onFall(e){return this.on("fall",e)},onFallOff(e){return this.on("fallOff",e)},onHeadbutt(e){return this.on("headbutt",e)},onLand(e){return this.on("land",e)},onHeadbutted(e){return this.on("headbutted",e)},inspect(){return`gravityScale: ${this.gravityScale}x`}}}function ki(e=2){let t=e;return{id:"doubleJump",require:["body"],numJumps:e,add(){this.onGround((()=>{t=this.numJumps}))},doubleJump(e){t<=0||(t<this.numJumps&&this.trigger("doubleJump"),t--,this.jump(e))},onDoubleJump(e){return this.on("doubleJump",e)},inspect:()=>`jumpsLeft: ${t}`}}function Pi(e){return{id:"surfaceEffector",require:["area"],speed:e.speed,speedVariation:e.speedVariation??0,forceScale:e.speedVariation??.9,add(){this.onCollideUpdate("body",((e,t)=>{let n=t?.normal.normal(),s=e.vel.project(n),r=n?.scale(this.speed)?.sub(s);e.addForce(r?.scale(e.mass*this.forceScale))}))}}}function Ci(e){return{id:"areaEffector",require:["area"],useGlobalAngle:e.useGlobalAngle||!1,forceAngle:e.forceAngle,forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",((e,t)=>{if(!e.has("body"))return;let n=g.fromAngle(this.forceAngle).scale(this.forceMagnitude);e.addForce(n),this.linearDrag&&e.addForce(e.vel.scale(-this.linearDrag))}))}}}function Fi(e){return{id:"pointEffector",require:["area","pos"],forceMagnitude:e.forceMagnitude,forceVariation:e.forceVariation??0,distanceScale:e.distanceScale??1,forceMode:e.forceMode||"inverseLinear",linearDrag:e.linearDrag??0,add(){this.onCollideUpdate("body",((e,t)=>{let n=this.pos.sub(e.pos),s=n.len(),r=s*this.distanceScale/10,i="constant"===this.forceMode?1:"inverseLinear"===this.forceMode?1/r:1/r**2,a=n.scale(this.forceMagnitude*i/s);e.addForce(a),this.linearDrag&&e.addForce(e.vel.scale(-this.linearDrag))}))}}}function Ti(e){return{id:"constantForce",require:["body"],force:e.force,update(){this.force&&this.addForce(this.force)}}}function Di(e){return{id:"platformEffector",require:["area","body"],surfaceArc:e.surfaceArc??180,useOneWay:e.useOneWay??!1,add(){this.onBeforePhysicsResolve((e=>{let t=e.target.vel,n=Lr().scale(-1).angleBetween(t);Math.abs(n)>this.surfaceArc/2&&e.preventResolution()}))}}}function Oi(e){return{id:"buoyancyEffector",require:["area"],surfaceLevel:e.surfaceLevel,density:e.density??1,linearDrag:e.linearDrag??1,angularDrag:e.angularDrag??.2,flowAngle:e.flowAngle??0,flowMagnitude:e.flowMagnitude??0,flowVariation:e.flowVariation??0,add(){this.onCollideUpdate("body",((e,t)=>{let n=e,s=n.worldArea(),[r,i]=s.cut(m(-100,this.surfaceLevel),m(100,this.surfaceLevel));r&&(this.applyBuoyancy(n,r),this.applyDrag(n,r)),this.flowMagnitude&&n.addForce(g.fromAngle(this.flowAngle).scale(this.flowMagnitude))}))},applyBuoyancy(e,t){let n=this.density*t.area(),s=m(0,1).scale(-n);e.addForce(s)},applyDrag(e,t){let n=e.vel,s=this.density*this.linearDrag,r=n.scale(-s);e.addForce(r)}}}function Ui(e){if(!e)throw new Error("Please define an anchor");return{id:"anchor",anchor:e,inspect(){return"string"==typeof this.anchor?"anchor: "+this.anchor:"anchor: "+this.anchor.toString()}}}function Li(){return{id:"fixed",fixed:!0}}function Ni(e,t){return{id:"follow",require:["pos"],follow:{obj:e,offset:t??m(0)},add(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))},update(){e.exists()&&(this.pos=this.follow.obj.pos.add(this.follow.offset))}}}function Hi(e){let t=Wi.game.layers?.indexOf(e);return{id:"layer",get layerIndex(){return t??null},get layer(){return t?Wi.game.layers?.[t]??null:null},set layer(e){if(t=Wi.game.layers?.indexOf(e),-1==t)throw Error("Invalid layer name")},inspect(){return`layer: ${this.layer}`}}}function ji(e,t){let n="number"==typeof e?g.fromAngle(e):e.unit();return{id:"move",require:["pos"],update(){this.move(n.scale(t))}}}function Gi(e={}){let t=!1,n=new ne(m(0),gn(),mn()),s=new ne(m(0),0,0),r=n=>{n.isOffScreen()?(t||(n.trigger("exitView"),t=!0),e.hide&&(n.hidden=!0),e.pause&&(n.paused=!0),e.destroy&&n.destroy()):(t&&(n.trigger("enterView"),t=!1),e.hide&&(n.hidden=!1),e.pause&&(n.paused=!1))};return{id:"offscreen",require:["pos"],offscreenDistance:e.distance??200,isOffScreen(){let e=this.screenPos();if(!e)return!1;if(n.width=gn(),n.height=mn(),!this.offscreenDistance&&this.width&&this.height)return s.width=this.width,s.height=this.height,s.pos=this.pos,s.collides(n);let t=this.offscreenDistance?this.offscreenDistance:200;return!O(n,e)&&n.sdistToPoint(e)>t*t},onExitScreen(e){return this.on("exitView",e)},onEnterScreen(e){return this.on("enterView",e)},add(){e.pause&&e.unpause?Js((()=>r(this))):this.onUpdate((()=>r(this)))}}}function Vi(...e){return{id:"pos",pos:m(...e),moveBy(...e){this.pos=this.pos.add(m(...e))},move(...e){this.moveBy(m(...e).scale(Dt()))},moveTo(...e){if("number"==typeof e[0]&&"number"==typeof e[1])return this.moveTo(m(e[0],e[1]),e[2]);let t=e[0],n=e[1];if(void 0===n)return void(this.pos=m(t));let s=t.sub(this.pos);s.len()<=n*Dt()?this.pos=m(t):this.move(s.unit().scale(n))},worldPos(e=null){return e?(this.pos=this.pos.add(this.fromWorld(e)),null):this.parent?this.parent.transform.multVec2(this.pos):this.pos},toWorld(e){return this.parent?this.parent.transform.multVec2(this.pos.add(e)):this.pos.add(e)},fromWorld(e){return this.parent?this.parent.transform.invert().multVec2(e).sub(this.pos):e.sub(this.pos)},screenPos(e=null){if(e)return this.pos=this.pos.add(this.fromScreen(e)),null;{let e=this.worldPos();return e?Cs(this)?e:Rr(e):null}},toScreen(e){let t=this.toWorld(e);return Cs(this)?t:Rr(t)},fromScreen(e){return Cs(this)?this.fromWorld(e):this.fromWorld(Ir(e))},toOther(e,t){return e.fromWorld(this.toWorld(t))},fromOther(e,t){return e.toOther(this,t)},inspect(){return`pos: (${Math.round(this.pos.x)}x, ${Math.round(this.pos.y)}y)`},drawInspect(){is({color:l(255,0,0),radius:4/wn()})}}}function Ki(e){return{id:"rotate",angle:e??0,rotateBy(e){this.angle+=e},rotateTo(e){this.angle=e},inspect(){return`angle: ${Math.round(this.angle)}`}}}function Yi(...e){if(0===e.length)return Yi(1);let t=m(...e);return{id:"scale",set scale(e){if(!(e instanceof g))throw Error("The scale property on scale is a vector. Use scaleTo or scaleBy to set the scale with a number.");t=m(e)},get scale(){return t},scaleTo(...e){t=m(...e)},scaleBy(...e){t=t.scale(m(...e))},inspect:()=>t.x==t.y?`scale: ${t.x.toFixed(1)}x`:`scale: (${t.x.toFixed(1)}x, ${t.y.toFixed(1)}y)`}}function Xi(e){return{id:"z",z:e,inspect(){return`z: ${this.z}`}}}var Qi,Wi={k:null,globalOpt:null,gfx:null,game:null,app:null,assets:null,fontCacheCanvas:null,fontCacheC2d:null,debug:null,audio:null,pixelDensity:null,canvas:null,gscale:null,kaSprite:null,boomSprite:null},zi=(e={tagsAsComponents:!0})=>{Wi.k&&Wi.k.quit(),Wi.globalOpt=e;let t=e.root??document.body;t===document.body&&(document.body.style.width="100%",document.body.style.height="100%",document.body.style.margin="0px",document.documentElement.style.width="100%",document.documentElement.style.height="100%");let n=e.canvas??t.appendChild(document.createElement("canvas"));Wi.canvas=n;let s=e.scale??1;Wi.gscale=s;let r=e.width&&e.height&&!e.stretch&&!e.letterbox;r?(n.width=e.width*s,n.height=e.height*s):(n.width=n.parentElement.offsetWidth,n.height=n.parentElement.offsetHeight);let i=["outline: none","cursor: default"];if(r){let e=n.width,t=n.height;i.push(`width: ${e}px`),i.push(`height: ${t}px`)}else i.push("width: 100%"),i.push("height: 100%");e.crisp&&(i.push("image-rendering: pixelated"),i.push("image-rendering: crisp-edges")),n.style.cssText=i.join(";");let A=e.pixelDensity||1;Wi.pixelDensity=A,n.width*=A,n.height*=A,n.tabIndex=0;let x=document.createElement("canvas");x.width=256,x.height=256,Wi.fontCacheCanvas=x;let E=x.getContext("2d",{willReadFrequently:!0});Wi.fontCacheC2d=E;let q=Tt({canvas:n,touchToMouse:e.touchToMouse,gamepads:e.gamepads,pixelDensity:e.pixelDensity,maxFPS:e.maxFPS,buttons:e.buttons});Wi.app=q;let U=[],L=q.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});if(!L)throw new Error("WebGL not supported");let j=L,G=function(e,t={}){let n=[],s=null,[r,i]=cs((t=>e.bindTexture(e.TEXTURE_2D,t))),[a,o]=cs((t=>e.bindBuffer(e.ARRAY_BUFFER,t))),[l,h]=cs((t=>e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t))),[u,d]=cs((t=>e.bindFramebuffer(e.FRAMEBUFFER,t))),[c,f]=cs((t=>e.bindRenderbuffer(e.RENDERBUFFER,t))),[p,g]=cs((t=>{if(!t)return;let{x:n,y:s,w:r,h:i}=t;e.viewport(n,s,r,i)})),[m,w]=cs((t=>e.useProgram(t)));return p({x:0,y:0,w:e.drawingBufferWidth,h:e.drawingBufferHeight}),{gl:e,opts:t,onDestroy:function(e){n.push(e)},destroy:function(){n.forEach((e=>e()));let t=e.getExtension("WEBGL_lose_context");t&&t.loseContext()},pushTexture2D:r,popTexture2D:i,pushArrayBuffer:a,popArrayBuffer:o,pushElementArrayBuffer:l,popElementArrayBuffer:h,pushFramebuffer:u,popFramebuffer:d,pushRenderbuffer:c,popRenderbuffer:f,pushViewport:p,popViewport:g,pushProgram:m,popProgram:w,setVertexFormat:function(t){if(ht(t,s))return;s=t;let n=t.reduce(((e,t)=>e+t.size),0);t.reduce(((t,s,r)=>(e.vertexAttribPointer(r,s.size,e.FLOAT,!1,4*n,t),e.enableVertexAttribArray(r),t+4*s.size)),0)}}}(j,{texFilter:e.texFilter}),K=Ps(e,G);Wi.gfx=K;let Y=(()=>{let e=new(window.AudioContext||window.webkitAudioContext),t=e.createGain();t.connect(e.destination);let n=new Jn(e.createBuffer(1,1,44100));return e.decodeAudioData(Nr.buffer.slice(0)).then((e=>{n.buf=e})).catch((e=>{})),{ctx:e,masterNode:t,burpSnd:n}})();Wi.audio=Y;let X=((e,t)=>({urlPrefix:"",sprites:new bn,fonts:new bn,bitmapFonts:new bn,sounds:new bn,shaders:new bn,custom:new bn,music:{},packer:new An(e,2048,2048,t),loaded:!1}))(G,e.spriteAtlasPadding??0);Wi.assets=X;let Q={events:new $e,objEvents:new $e,root:Tr([]),gravity:null,scenes:{},currentScene:null,layers:null,defaultLayerIndex:0,logs:[],cam:{pos:null,scale:new g(1),angle:0,shake:0,transform:new v}};function W(){j.clear(j.COLOR_BUFFER_BIT),K.frameBuffer.bind(),j.clear(j.COLOR_BUFFER_BIT),K.bgColor||xs((()=>{ws({width:gn(),height:mn(),quad:new w(0,0,gn()/64,mn()/64),tex:K.bgTex,fixed:!0})})),K.renderer.numDraws=0,K.fixed=!1,K.transformStack.length=0,K.transform=new v}function z(){pn(),K.lastDrawCalls=K.renderer.numDraws,K.frameBuffer.unbind(),j.viewport(0,0,j.drawingBufferWidth,j.drawingBufferHeight);let e=K.width,t=K.height;K.width=j.drawingBufferWidth/A,K.height=j.drawingBufferHeight/A,Bs({flipY:!0,tex:K.frameBuffer.tex,pos:new g(K.viewport.x,K.viewport.y),width:K.viewport.width,height:K.viewport.height,shader:K.postShader,uniform:"function"==typeof K.postShaderUniform?K.postShaderUniform():K.postShaderUniform,fixed:!0}),pn(),K.width=e,K.height=t}Wi.game=Q,Q.root.use(Si());let Z=!1,J={inspect:!1,set timeScale(e){Wi.app.state.timeScale=e},get timeScale(){return Wi.app.state.timeScale},showLog:!0,fps:()=>q.fps(),numFrames:()=>q.numFrames(),stepFrame:Ne,drawCalls:()=>K.lastDrawCalls,clearLog:()=>Q.logs=[],log:(...t)=>{let n=e.logMax??8,s=t.length>1?t.concat(" ").join(" "):t[0];Q.logs.unshift({msg:s,time:q.time()}),Q.logs.length>n&&(Q.logs=Q.logs.slice(0,n))},error:e=>J.log(new Error(e.toString?e.toString():e)),curRecording:null,numObjects:()=>Me("*",{recursive:!0}).length,get paused(){return Z},set paused(e){Z=e,e?Y.ctx.suspend():Y.ctx.resume()}};function _(e,t){window.localStorage[e]=JSON.stringify(t)}function $(t,...n){let s,r=t(Ke);s="function"==typeof r?r(...n)(Ke):r;for(let t in s)Ke[t]=s[t],!1!==e.global&&(window[t]=s[t]);return Ke}Wi.debug=J;let ve=Q.root.add.bind(Q.root),be=Q.root.readd.bind(Q.root),Ee=Q.root.removeAll.bind(Q.root),Me=Q.root.get.bind(Q.root),qe=Q.root.wait.bind(Q.root),ke=Q.root.loop.bind(Q.root),Pe=Q.root.query.bind(Q.root),Ce=Q.root.tween.bind(Q.root),Fe=Dn(null,"data:image/png;base64,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"),Ue=Dn(null,"data:image/png;base64,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");function Ne(){Q.root.update()}Wi.kaSprite=Fe,Wi.boomSprite=Ue;class He{source;target;normal;distance;resolved=!1;constructor(e,t,n,s,r=!1){this.source=e,this.target=t,this.normal=n,this.distance=s,this.resolved=r}get displacement(){return this.normal.scale(this.distance)}reverse(){return new He(this.target,this.source,this.normal.scale(-1),this.distance,this.resolved)}hasOverlap(){return!this.displacement.isZero()}isLeft(){return this.displacement.cross(Q.gravity||m(0,1))>0}isRight(){return this.displacement.cross(Q.gravity||m(0,1))<0}isTop(){return this.displacement.dot(Q.gravity||m(0,1))>0}isBottom(){return this.displacement.dot(Q.gravity||m(0,1))<0}preventResolution(){this.resolved=!0}}function je(){if(!(Bi>0))return;let t={},n=e.hashGridSize||64,s=new v,r=[];!function e(i){if(r.push(s.clone()),i.pos&&s.translate(i.pos),i.scale&&s.scale(i.scale),i.angle&&s.rotate(i.angle),i.transform=s.clone(),i.c("area")&&!i.paused){let e=i,s=e.worldArea().bbox(),r=Math.floor(s.pos.x/n),a=Math.floor(s.pos.y/n),o=Math.ceil((s.pos.x+s.width)/n),l=Math.ceil((s.pos.y+s.height)/n),h=new Set;for(let n=r;n<=o;n++)for(let s=a;s<=l;s++)if(t[n])if(t[n][s]){let r=t[n][s];e:for(let t of r){if(t.paused||!t.exists()||h.has(t.id))continue;for(let n of e.collisionIgnore)if(t.is(n))continue e;for(let n of t.collisionIgnore)if(e.is(n))continue e;let n=Ie(e.worldArea(),t.worldArea());if(n){let s=new He(e,t,n.normal,n.distance);e.trigger("collideUpdate",t,s);let r=s.reverse();r.resolved=s.resolved,t.trigger("collideUpdate",e,r)}h.add(t.id)}r.push(e)}else t[n][s]=[e];else t[n]={},t[n][s]=[e]}i.children.forEach(e),s=r.pop()}(Q.root)}function Ge(e){Y.ctx.suspend();let t=e.message??String(e)??"Unknown error, check console for more info";q.run((()=>{}),(()=>{W(),xs((()=>{let n=gn(),s=mn(),r={size:36,width:n-64,letterSpacing:4,lineSpacing:4,font:Le,fixed:!0};As({width:n,height:s,color:l(0,0,255),fixed:!0});let i=ms({...r,text:"Error",pos:m(32),color:l(255,128,0),fixed:!0});ys(i),ks({...r,text:t,pos:m(32,32+i.height+16),fixed:!0}),fn(),Q.events.trigger("error",e)})),z()}))}let Ve=!0;q.run((()=>{try{X.loaded&&(J.paused||Q.root.fixedUpdate(),je())}catch(e){Ge(e)}}),((t,n)=>{try{t(),X.loaded||1===Rn()&&!Ve&&(X.loaded=!0,In().forEach((e=>Q.events.trigger("loadError",...e))),Q.events.trigger("load")),!X.loaded&&!1!==e.loadingScreen||Ve?(W(),function(){let e=Rn();Wi.game.events.numListeners("loading")>0?Wi.game.events.trigger("loading",e):xs((()=>{let t=gn()/2,n=m(gn()/2,mn()/2).sub(m(t/2,12));As({pos:m(0),width:gn(),height:mn(),color:l(0,0,0)}),As({pos:n,width:t,height:24,fill:!1,outline:{width:4}}),As({pos:n,width:t*e,height:24})}))}(),z()):(J.paused||Ne(),je(),W(),function(){let e=Wi.game.cam,t=g.fromAngle(B(0,360)).scale(e.shake);e.shake=c(e.shake,0,5*Dt()),e.transform=(new v).translate(yn()).scale(e.scale).rotate(e.angle).translate((e.pos??yn()).scale(-1).add(t)),Wi.game.root.draw(),pn()}(),!1!==e.debug&&Es(),z()),Ve&&(Ve=!1),Q.events.trigger("frameEnd"),n()}catch(e){Ge(e)}})),Bt(),Xr();let Ke={_k:Wi,VERSION:"3001.0.16",loadRoot:qn,loadProgress:Rn,loadSprite:Dn,loadSpriteAtlas:ts,loadSound:$n,loadMusic:es,loadBitmapFont:Yn,loadFont:Vn,loadShader:zn,loadShaderURL:Zn,loadAseprite:Nn,loadPedit:Xn,loadBean:Ln,loadJSON:Sn,load:Pn,getSound:_n,getFont:Gn,getBitmapFont:Kn,getSprite:Tn,getShader:Wn,getAsset:kn,Asset:vn,SpriteData:Cn,SoundData:Jn,width:gn,height:mn,center:yn,dt:Dt,fixedDt:Ot,restDt:Ut,time:q.time,screenshot:q.screenshot,record:function(e){let t=q.canvas.captureStream(e),n=Y.ctx.createMediaStreamDestination();Y.masterNode.connect(n);let s=new MediaRecorder(t),r=[];return s.ondataavailable=e=>{e.data.size>0&&r.push(e.data)},s.onerror=()=>{Y.masterNode.disconnect(n),t.getTracks().forEach((e=>e.stop()))},s.start(),{resume(){s.resume()},pause(){s.pause()},stop:()=>(s.stop(),Y.masterNode.disconnect(n),t.getTracks().forEach((e=>e.stop())),new Promise((e=>{s.onstop=()=>{e(new Blob(r,{type:"video/mp4"}))}}))),download(e="kaboom.mp4"){this.stop().then((t=>ot(e,t)))}}},isFocused:function(){return document.activeElement===q.canvas},setCursor:q.setCursor,getCursor:q.getCursor,setCursorLocked:q.setCursorLocked,isCursorLocked:q.isCursorLocked,setFullscreen:q.setFullscreen,isFullscreen:q.isFullscreen,isTouchscreen:q.isTouchscreen,onLoad:mr,onLoadError:wr,onLoading:fr,onResize:pr,onGamepadConnect:q.onGamepadConnect,onGamepadDisconnect:q.onGamepadDisconnect,onError:gr,onCleanup:function(e){U.push(e)},flash:qr,setCamPos:yr,getCamPos:Ar,setCamRot:br,getCamRot:Er,setCamScale:xr,getCamScale:vr,getCamTransform:Mr,camPos:kr,camScale:Pr,camFlash:Fr,camRot:Cr,camTransform:Sr,shake:Br,toScreen:Rr,toWorld:Ir,setGravity:Dr,getGravity:Or,setGravityDirection:Ur,getGravityDirection:Lr,setBackground:an,getBackground:on,getGamepads:q.getGamepads,getTreeRoot:$r,add:ve,make:Tr,destroy:_r,destroyAll:Ee,get:Me,query:Pe,readd:be,pos:Vi,scale:Yi,rotate:Ki,color:Ds,opacity:Ns,anchor:Ui,area:Ri,sprite:ri,text:ii,polygon:Vs,rect:Ys,circle:Ts,uvquad:ai,outline:Hs,particles:Gs,body:Ii,platformEffector:Di,surfaceEffector:Pi,areaEffector:Ci,pointEffector:Fi,buoyancyEffector:Oi,constantForce:Ti,doubleJump:ki,shader:Xs,textInput:qi,timer:Si,fixed:Li,stay:Mi,health:xi,lifespan:vi,named:bi,state:Ei,z:Xi,layer:Hi,move:ji,offscreen:Gi,follow:Ni,fadeIn:Us,mask:Ls,drawon:Os,raycast:Ks,tile:di,animate:wi,serializeAnimation:yi,agent:oi,sentry:ui,patrol:hi,pathfinder:li,trigger:zs,on:Ws,onFixedUpdate:Zs,onUpdate:Js,onDraw:_s,onAdd:$s,onDestroy:er,onTag:sr,onUntag:rr,onUse:tr,onUnuse:nr,onClick:hr,onCollide:ir,onCollideUpdate:ar,onCollideEnd:or,onHover:ur,onHoverUpdate:dr,onHoverEnd:cr,onKeyDown:q.onKeyDown,onKeyPress:q.onKeyPress,onKeyPressRepeat:q.onKeyPressRepeat,onKeyRelease:q.onKeyRelease,onMouseDown:q.onMouseDown,onMousePress:q.onMousePress,onMouseRelease:q.onMouseRelease,onMouseMove:q.onMouseMove,onCharInput:q.onCharInput,onTouchStart:q.onTouchStart,onTouchMove:q.onTouchMove,onTouchEnd:q.onTouchEnd,onScroll:q.onScroll,onHide:q.onHide,onShow:q.onShow,onGamepadButtonDown:q.onGamepadButtonDown,onGamepadButtonPress:q.onGamepadButtonPress,onGamepadButtonRelease:q.onGamepadButtonRelease,onGamepadStick:q.onGamepadStick,onButtonPress:q.onButtonPress,onButtonDown:q.onButtonDown,onButtonRelease:q.onButtonRelease,mousePos:q.mousePos,mouseDeltaPos:q.mouseDeltaPos,isKeyDown:q.isKeyDown,isKeyPressed:q.isKeyPressed,isKeyPressedRepeat:q.isKeyPressedRepeat,isKeyReleased:q.isKeyReleased,isMouseDown:q.isMouseDown,isMousePressed:q.isMousePressed,isMouseReleased:q.isMouseReleased,isMouseMoved:q.isMouseMoved,isGamepadButtonPressed:q.isGamepadButtonPressed,isGamepadButtonDown:q.isGamepadButtonDown,isGamepadButtonReleased:q.isGamepadButtonReleased,getGamepadStick:q.getGamepadStick,isButtonPressed:q.isButtonPressed,isButtonDown:q.isButtonDown,isButtonReleased:q.isButtonReleased,setButton:q.setButton,getButton:q.getButton,pressButton:q.pressButton,releaseButton:q.releaseButton,getLastInputDeviceType:q.getLastInputDeviceType,charInputted:q.charInputted,loop:ke,wait:qe,play:jr,setVolume:Vr,getVolume:Kr,volume:Yr,burp:Gr,audioCtx:Y.ctx,Line:te,Rect:ne,Circle:se,Ellipse:re,Point:ee,Polygon:ie,Vec2:g,Color:o,Mat4:v,Quad:w,RNG:M,rand:B,randi:R,randSeed:S,vec2:m,rgb:l,hsl2rgb:h,quad:y,choose:C,chooseMultiple:P,shuffle:k,chance:I,lerp:c,tween:Ce,easings:en,map:f,mapc:p,wave:b,deg2rad:u,rad2deg:d,clamp:a,evaluateQuadratic:ae,evaluateQuadraticFirstDerivative:oe,evaluateQuadraticSecondDerivative:le,evaluateBezier:he,evaluateBezierFirstDerivative:ue,evaluateBezierSecondDerivative:de,evaluateCatmullRom:ce,evaluateCatmullRomFirstDerivative:fe,curveLengthApproximation:ge,normalizedCurve:pe,hermite:me,cardinal:we,catmullRom:ye,bezier:Ae,kochanekBartels:xe,easingSteps:Re,easingLinear:Se,easingCubicBezier:Be,testLineLine:T,testRectRect:F,testRectLine:D,testRectPoint:O,testCirclePolygon:V,testLinePoint:N,testLineCircle:H,isConvex:De,triangulate:Te,NavMesh:tn,drawSprite:Rs,drawText:ks,formatText:ms,drawRect:As,drawLine:as,drawLines:os,drawTriangle:bs,drawCircle:is,drawEllipse:rs,drawUVQuad:ws,drawPolygon:ss,drawCurve:ls,drawBezier:hs,drawFormattedText:ys,drawMasked:Ss,drawSubtracted:Is,pushTransform:hn,popTransform:fn,pushTranslate:ln,pushScale:dn,pushRotate:cn,pushMatrix:un,usePostEffect:function(e,t){K.postShader=e,K.postShaderUniform=t??null},makeCanvas:function(e,t){let n=new ds(G,e,t);return{clear:()=>n.clear(),free:()=>n.free(),toDataURL:()=>n.toDataURL(),toImageData:()=>n.toImageData(),width:n.width,height:n.height,draw:e=>{pn(),n.bind(),e(),pn(),n.unbind()},get fb(){return n}}},debug:J,scene:ei,getSceneName:si,go:ti,onSceneLeave:ni,layers:Jr,getLayers:zr,setLayers:Wr,getDefaultLayer:Zr,addLevel:Qs,getData:function(e,t){try{return JSON.parse(window.localStorage[e])}catch{return t?(_(e,t),t):null}},setData:_,download:rt,downloadJSON:at,downloadText:it,downloadBlob:ot,plug:$,ASCII_CHARS:Oe,canvas:q.canvas,addKaboom:Qr,LEFT:g.LEFT,RIGHT:g.RIGHT,UP:g.UP,DOWN:g.DOWN,RED:o.RED,GREEN:o.GREEN,BLUE:o.BLUE,YELLOW:o.YELLOW,MAGENTA:o.MAGENTA,CYAN:o.CYAN,WHITE:o.WHITE,BLACK:o.BLACK,quit:function(){Q.events.onOnce("frameEnd",(()=>{q.quit(),j.clear(j.COLOR_BUFFER_BIT|j.DEPTH_BUFFER_BIT|j.STENCIL_BUFFER_BIT);let e=j.getParameter(j.MAX_TEXTURE_IMAGE_UNITS);for(let t=0;t<e;t++)j.activeTexture(j.TEXTURE0+t),j.bindTexture(j.TEXTURE_2D,null),j.bindTexture(j.TEXTURE_CUBE_MAP,null);j.bindBuffer(j.ARRAY_BUFFER,null),j.bindBuffer(j.ELEMENT_ARRAY_BUFFER,null),j.bindRenderbuffer(j.RENDERBUFFER,null),j.bindFramebuffer(j.FRAMEBUFFER,null),G.destroy(),U.forEach((e=>e()))}))},KEvent:_e,KEventHandler:$e,KEventController:Je,cancel:()=>ze};Wi.k=Ke;let Ye=e.plugins;if(Ye&&Ye.forEach($),!1!==e.global)for(let e in Ke)window[e]=Ke[e];return!1!==e.focus&&q.canvas.focus(),Ke},Zi=zi;return Qi=i,((r,i,a,o)=>{if(i&&"object"==typeof i||"function"==typeof i)for(let l of n(i))!s.call(r,l)&&l!==a&&e(r,l,{get:()=>i[l],enumerable:!(o=t(i,l))||o.enumerable});return r})(e({},"__esModule",{value:!0}),Qi)})();window.kaboom=kaplay.default,window.kaplay=kaplay.default;